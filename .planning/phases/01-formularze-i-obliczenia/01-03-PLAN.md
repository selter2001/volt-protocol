---
phase: 01-formularze-i-obliczenia
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified: [index.html]
autonomous: false

must_haves:
  truths:
    - "Zal. 2: dla obwodow 1-fazowych aktywne sa tylko L1-N, L1-PE, N-PE; reszta jest szara i nieaktywna"
    - "Zal. 2: dla obwodow 3-fazowych wszystkie 10 pol Rp aktywne"
    - "Zal. 2: ocena POZYTYWNA gdy wszystkie aktywne Rp >= Rw (domyslne 1 MOhm)"
    - "Zal. 2: staly wiersz WLZ jest na gorze tabeli"
    - "Zal. 2: sekcje i podtytuly sa te same co w Zal. 1 (wspoldzielone)"
    - "Zal. 3: ocena POZYTYWNA gdy Iw <= In AND tw <= tz (domyslne 300ms)"
    - "Zal. 4: Rpo = Rp * Wk oblicza sie automatycznie, ocena Rpo <= Rw (domyslne 10 Ohm)"
    - "Wszystkie 4 zalaczniki dzialaja kompletnie w jednej aplikacji"
  artifacts:
    - path: "index.html"
      provides: "Kompletna aplikacja z 4 zalacznikami, obliczeniami i ocenami"
      contains: "renderAttachment2.*renderAttachment3.*renderAttachment4"
  key_links:
    - from: "select[data-field=phaseType]"
      to: "applyPhaseType(row, phaseType)"
      via: "change event -> toggle disabled/enabled na polach Rp"
      pattern: "phaseType.*disabled|getActiveIZOLFields"
    - from: "AppState.sections"
      to: "renderAttachment2()"
      via: "Wspoldzielone sekcje z Zal. 1 (DYN-06)"
      pattern: "AppState\\.sections.*forEach|for.*of.*AppState\\.sections"
    - from: "input[data-field='Rp']"
      to: "calcUZIEMRow()"
      via: "input event -> Rpo = Rp * Wk -> verdict = Rpo <= Rw"
      pattern: "calcUZIEMRow"
---

<objective>
Zaimplementowac kompletne Zalaczniki 2 (rezystancja izolacji), 3 (RCD) i 4 (uziemienie) z tabelami, obliczeniami i automatyczna ocena. Po tym planie wszystkie 4 zalaczniki beda w pelni funkcjonalne.

Purpose: Zal. 2 jest drugim co do zlozonosci formularzem (15 kolumn, logika 1-faz/3-faz). Zal. 3 i 4 sa prostsze ale rownie wazne. Po tym planie faza 1 jest kompletna.
Output: Kompletna aplikacja z 4 dzialajacymi zalacznikami.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-formularze-i-obliczenia/01-RESEARCH.md
@.planning/phases/01-formularze-i-obliczenia/01-01-SUMMARY.md
@.planning/phases/01-formularze-i-obliczenia/01-02-SUMMARY.md
@reference-protokol-extracted.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zalacznik 2 (izolacja) - tabela 15 kolumn, logika 1-faz/3-faz, ocena</name>
  <files>index.html</files>
  <action>
Zastap szkieletowa wersje renderAttachment2() pelna implementacja tabeli rezystancji izolacji.

**Naglowek tabeli Zal. 2:**

Tabela z 15 kolumnami (landscape-ready, ale na ekranie uzyj `overflow-x-auto` z `min-w-max` - Open Question 3 z RESEARCH):

```html
<div class="overflow-x-auto">
  <table class="min-w-max border-collapse text-sm">
```

Kolumny naglowka (2 wiersze):
Wiersz 1: Lp. | Nazwa obwodu | Typ przewodu | Rp [MOhm] (colspan=10) | Rw [MOhm] | Ocena
Wiersz 2: (puste 3 kol) | L1-N | L2-N | L3-N | L1-L2 | L1-L3 | L2-L3 | L1-PE | L2-PE | L3-PE | N-PE | (puste 2 kol)

**Staly wiersz WLZ (IZOL-01):**

Renderowany z `AppState.attachment2.fixedRow`:
- Lp. = 1
- Nazwa: "WLZ" (nie-edytowalna)
- Typ przewodu: input text
- Select 1-faz/3-faz: domyslnie 3-fazowy (WLZ to zawsze 3-fazowe)
- 10 pol Rp: input number step="0.01" - WSZYSTKIE aktywne (3-faz)
- Rw: wyswietlone jako "1" (IZOL-05, domyslnie 1 MOhm, nie-edytowalne)
- Ocena: wyliczona

**Sekcje i podtytuly (wspoldzielone z Zal. 1 - DYN-06):**

Iteracja po `AppState.sections` - TE SAME sekcje co w Zal. 1:
- Wiersz sekcji: `<tr class="bg-gray-200 font-bold"><td colspan="15">[tytul - read-only]</td></tr>`
- Wiersz podtytulu: `<tr class="bg-gray-100 italic"><td colspan="15">[tytul - read-only] + przycisk "Dodaj wiersz"</td></tr>`

  WAZNE: W Zal. 2 nazwy sekcji i podtytulow sa READ-ONLY (wyswietlone jako tekst, nie input). Edycja tylko z Zal. 1. Przycisk "Dodaj wiersz" dodaje wiersz do `AppState.attachment2.rowsBySubsection[subId]`.

**Wiersze dynamiczne Zal. 2:**

Kazdy wiersz z `AppState.attachment2.rowsBySubsection[sub.id]`:
- Lp. = obliczane w renderze (osobna numeracja Lp. niezalezna od Zal. 1 - Zal. 2 ma wlasne Lp.)
- Nazwa obwodu: input text `data-field="name"`
- Typ przewodu: input text `data-field="wireType"` (np. "YDYp 3x2.5")
- Select fazy: `<select data-field="phaseType">` z opcjami "1-fazowy" (value="1") i "3-fazowy" (value="3")
- 10 pol Rp: kazde `<input type="number" data-field="rp.L1N" step="0.01" class="w-14">` (analogicznie dla pozostalych)
- Rw: tekst "1" (nie-edytowalne) (IZOL-05)
- Ocena: wyliczona
- Przycisk "Usun"

**Logika 1-faz/3-faz (IZOL-03, IZOL-04):**

Funkcja `applyPhaseType(trElement, phaseType)` wg RESEARCH.md Pattern 4:
- Pobierz aktywne pola: `getActiveIZOLFields(phaseType)` (IZOL_FIELDS_1PHASE / IZOL_FIELDS_3PHASE)
- Dla kazdego z 10 pol Rp:
  - Jesli pole jest w aktywnych: `input.disabled = false`, usun klasy szarego tla
  - Jesli pole NIE jest w aktywnych: `input.disabled = true`, dodaj `bg-gray-100 cursor-not-allowed`, wyczysc wartosc input.value = '', ustaw AppState wartosc na null
- Wywolaj na kazdym renderze wiersza (nie tylko przy zmianie)
- Przy zmianie selecta phaseType: zaktualizuj AppState, wyczysc wartosci nieaktywnych pol w AppState (ustaw na null), wywolaj applyPhaseType(), przelicz ocene

**Obliczenia izolacji (podlacz event):**

Listener `input` na `#attachment-2`:
- Przy zmianie pola `rp.XXXX`: parsuj wartosc (`parseFloat || null`), zapisz do `row.rp[field]`, wywolaj `calcIZOLRow(row)`, zaktualizuj DOM oceny
- Przy zmianie `phaseType` (event `change` na select): zaktualizuj `row.phaseType`, wyczysc nieaktywne pola, przelicz

calcIZOLRow juz zaimplementowany w Plan 01. Weryfikuj ze prawidlowo:
- Pobiera aktywne pola na podstawie phaseType
- Sprawdza czy wszystkie aktywne pola maja wartosc (nie null)
- Jesli tak: `allPass = activeFields.every(f => roundTo3(row.rp[f]) >= roundTo3(row.Rw))`
- verdict = allPass ? 'POZYTYWNA' : 'NEGATYWNA'

**Styl pola Rp:**
- Aktywne: normalna ramka
- Nieaktywne: `bg-gray-100 text-gray-400 cursor-not-allowed` + `disabled` atrybut
- Szerokosc: `w-14` (56px) - minimalna dla 10 kolumn

**Legenda pod tabela (IZOL-07):**
- Rp - Zmierzona wartosc rezystancji izolacji
- Rw - Wymagana wartosc rezystancji izolacji
  </action>
  <verify>
1. Zal. 2 wyswietla tabele z 15 kolumnami, scroll poziomy na waskim ekranie
2. Staly wiersz WLZ (Lp.1) z 10 aktywnymi polami Rp (3-fazowy)
3. Sekcje i podtytuly te same co Zal. 1, nazwy read-only
4. Dodaj wiersz 1-fazowy: aktywne TYLKO L1-N, L1-PE, N-PE; reszta szara/disabled
5. Zmien na 3-fazowy: wszystkie 10 pol aktywne
6. Wpisz wartosci Rp = 150 (>= 1 MOhm) -> ocena POZYTYWNA
7. Wpisz jedna wartosc Rp = 0.5 (< 1 MOhm) -> ocena NEGATYWNA
8. Zmien nazwe sekcji w Zal. 1 -> nazwa w Zal. 2 sie aktualizuje (DYN-06)
  </verify>
  <done>
Zalacznik 2 dziala kompletnie: staly wiersz WLZ (IZOL-01), 15 kolumn (IZOL-02), logika 1-faz (IZOL-03) i 3-faz (IZOL-04), Rw=1 MOhm (IZOL-05), automatyczna ocena (IZOL-06), legenda (IZOL-07). Sekcje wspoldzielone z Zal. 1 (DYN-06).
  </done>
</task>

<task type="auto">
  <name>Task 2: Zalacznik 3 (RCD) i Zalacznik 4 (uziemienie) - tabele, obliczenia, ocena</name>
  <files>index.html</files>
  <action>
Zaimplementuj kompletne Zal. 3 i Zal. 4. Oba sa prostsze - plaska lista wierszy bez sekcji/podsekcji.

**=== ZALACZNIK 3 - RCD ===**

Zastap szkieletowy renderAttachment3() pelna implementacja.

**Naglowek tabeli (1 wiersz):**
Lp. | Typ urzadzenia | TEST | In [mA] | Iw [mA] | tw [ms] | tz [ms] | Ocena

**Wiersze dynamiczne z AppState.attachment3.rows:**

Kazdy wiersz:
- Lp.: obliczane w renderze (1, 2, 3...)
- Typ urzadzenia: input text `data-field="deviceType"` (np. "Eaton PF7-25/2/003-A")
- TEST: select TAK/NIE `data-field="testResult"` (RCD-01)
- In [mA]: input number `data-field="In"` step="1" (np. 30)
- Iw [mA]: input number `data-field="Iw"` step="0.1" (np. 24.5 - zmierzony prad wylaczajacy)
- tw [ms]: input number `data-field="tw"` step="1" (np. 18 - zmierzony czas wylaczenia)
- tz [ms]: input number `data-field="tz"` step="1" value="300" (RCD-02: domyslnie 300ms, edytowalny)
- Ocena: wyliczona
- Przycisk "Usun"

Atrybuty: `data-row-id`, `data-attachment="3"`.

**Obliczenia RCD (podlacz event):**

Listener `input` + `change` na `#attachment-3`:
- Przy zmianie In, Iw, tw, tz:
  - Parsuj: `parseFloat(val) || null`
  - Zapisz do AppState
  - Wywolaj `calcRCDRow(row)`
  - Zaktualizuj DOM: verdict, kolory

calcRCDRow (juz w Plan 01):
- `Iw <= In AND tw <= tz -> POZYTYWNA` (RCD-03)
- Jesli jakiekolwiek pole null -> verdict = null (puste)

**Przycisk "Dodaj wiersz RCD"** pod tabela:
- Tworzy nowy wiersz: `{ id: crypto.randomUUID(), deviceType: '', testResult: 'TAK', In: null, Iw: null, tw: null, tz: 300, calculated: { verdict: null } }`
- Dodaje do `AppState.attachment3.rows`
- EventBus.emit('attachment3:changed')

**Legenda (RCD-05):**
- In - Znamionowy prad roznicowy wylacznika [mA]
- Iw - Zmierzony prad wylaczajacy [mA]
- tw - Zmierzony czas wylaczenia [ms]
- tz - Dopuszczalny czas wylaczenia [ms]

---

**=== ZALACZNIK 4 - UZIEMIENIE ===**

Zastap szkieletowy renderAttachment4() pelna implementacja.

**Naglowek tabeli (1 wiersz):**
Lp. | Nazwa urzadzenia | Rp [Ohm] | Wk | Rpo [Ohm] | Rw [Ohm] | Ocena

**Wiersze dynamiczne z AppState.attachment4.rows:**

Kazdy wiersz:
- Lp.: obliczane w renderze
- Nazwa urzadzenia: input text `data-field="deviceName"` (np. "Instalacja odgromowa")
- Rp [Ohm]: input number `data-field="Rp"` step="0.01" (zmierzona rezystancja)
- Wk: input number `data-field="Wk"` step="0.01" (wspolczynnik korekcyjny)
- Rpo [Ohm]: wyliczone, tylko wyswietlanie (UZIEM-02: Rpo = Rp * Wk)
- Rw [Ohm]: input number `data-field="Rw"` step="0.1" value="10" (UZIEM-03: domyslnie 10 Ohm, edytowalny)
- Ocena: wyliczona
- Przycisk "Usun"

**Obliczenia uziemienia (podlacz event):**

Listener `input` na `#attachment-4`:
- Przy zmianie Rp, Wk, Rw:
  - Parsuj: `parseFloat(val) || null`
  - Zapisz do AppState
  - Wywolaj `calcUZIEMRow(row)`
  - Zaktualizuj DOM: Rpo, verdict, kolory

calcUZIEMRow (juz w Plan 01):
- `Rpo = roundTo3(Rp * Wk)` (UZIEM-02)
- `Rpo <= roundTo3(Rw) -> POZYTYWNA` (UZIEM-04)

**Przycisk "Dodaj wiersz" (UZIEM-05):**
- Tworzy: `{ id: crypto.randomUUID(), deviceName: '', Rp: null, Wk: null, Rw: 10, calculated: { Rpo: null, verdict: null } }`
- Dodaje do `AppState.attachment4.rows`
- EventBus.emit('attachment4:changed')

**Legenda (UZIEM-06):**
- RE - Zmierzona wartosc rezystancji uziemienia [Ohm] (UWAGA: w legendzie uzywaj RE, nie Rp - wg RESEARCH.md)
- Wk - Wspolczynnik korekcyjny
- Rpo - Obliczona wartosc rezystancji uziemienia [Ohm]
- Rw - Wymagana wartosc rezystancji uziemienia [Ohm]

---

**STYL TAILWIND (wspolny dla Zal. 3 i 4):**

Tabele: `w-full border-collapse text-sm`
Komorki: `border border-gray-300 px-2 py-1`
Naglowek: `bg-gray-50 text-center font-semibold`
Inputy: `w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center`
Ocena POZYTYWNA: `text-green-700 font-bold`
Ocena NEGATYWNA: `text-red-700 font-bold`
Komorki numeryczne: `text-right font-mono`
Przycisk "Dodaj wiersz": `mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700`
Przycisk "Usun": `text-red-500 hover:text-red-700 text-xs`
  </action>
  <verify>
**Zal. 3 RCD:**
1. Tabela z 8 kolumnami i naglowkiem
2. Dodaj wiersz: tz domyslnie 300ms
3. Wpisz: In=30, Iw=24, tw=18, tz=300 -> POZYTYWNA (24<=30 AND 18<=300)
4. Zmien Iw=35 (>In=30) -> NEGATYWNA
5. Zmien tw=350 (>tz=300) -> NEGATYWNA
6. Usun wiersz -> Lp. aktualizuje sie

**Zal. 4 Uziemienie:**
1. Tabela z 7 kolumnami i naglowkiem
2. Dodaj wiersz: Rw domyslnie 10 Ohm
3. Wpisz: Rp=5, Wk=1.2 -> Rpo=6.00, ocena POZYTYWNA (6<=10)
4. Zmien Rp=12 -> Rpo=14.40, ocena NEGATYWNA (14.40>10)
5. Zmien Rw=15 -> Rpo=14.40, ocena POZYTYWNA (14.40<=15)

**Cross-check:**
6. Przelacz miedzy zakladkami 1-4 - wszystkie dzialaja
7. Dodaj sekcje w Zal. 1 -> widoczna tez w Zal. 2
8. Brak bledow w konsoli
  </verify>
  <done>
Zalacznik 3 kompletny: kolumny (RCD-01), tz=300ms (RCD-02), ocena Iw<=In AND tw<=tz (RCD-03), dodawanie wierszy (RCD-04), legenda (RCD-05). Zalacznik 4 kompletny: kolumny (UZIEM-01), Rpo=Rp*Wk (UZIEM-02), Rw=10 Ohm (UZIEM-03), ocena Rpo<=Rw (UZIEM-04), dodawanie wierszy (UZIEM-05), legenda (UZIEM-06).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Kompletna aplikacja z 4 zalacznikami formularzy pomiarowych: Zal. 1 (SWZ) z baza zabezpieczen B/C/D i obliczeniami Id/Zsmax, Zal. 2 (izolacja) z logika 1-faz/3-faz, Zal. 3 (RCD) z ocena Iw/tw, Zal. 4 (uziemienie) z obliczeniem Rpo. Dynamiczne sekcje wspoldzielone miedzy Zal. 1 i Zal. 2.</what-built>
  <how-to-verify>
1. Otworz index.html w przegladarce Chrome
2. **Zal. 1 - SWZ:**
   - Staly wiersz: wybierz C/25, wpisz Usk=236.80, Zs=0.68 -> Id=348.24, Zsmax=0.95, POZYTYWNA
   - Dodaj sekcje "Parter", dodaj podtytul "Obwod gniazd", dodaj wiersz
   - B/16, Usk=234.6, Zs=0.73 -> Id=321.37, Zsmax=2.93, POZYTYWNA
   - Zmien Zs na 5.00 -> NEGATYWNA
   - Wpisz Ia=50 recznie, sprawdz ze Zsmax sie zmienia
3. **Zal. 2 - Izolacja:**
   - Sprawdz ze sekcje z Zal. 1 sa widoczne
   - Dodaj wiersz 1-fazowy: tylko 3 pola Rp aktywne
   - Zmien na 3-fazowy: 10 pol aktywne
   - Wpisz Rp=150 -> POZYTYWNA, wpisz 0.5 -> NEGATYWNA
4. **Zal. 3 - RCD:**
   - Dodaj wiersz, In=30, Iw=24, tw=18 -> POZYTYWNA
5. **Zal. 4 - Uziemienie:**
   - Dodaj wiersz, Rp=5, Wk=1.2 -> Rpo=6.00, POZYTYWNA
6. Sprawdz ze zmiana nazwy sekcji w Zal. 1 odzwierciedla sie w Zal. 2
  </how-to-verify>
  <resume-signal>Wpisz "approved" lub opisz problemy do poprawienia</resume-signal>
</task>

</tasks>

<verification>
- Otworz index.html w Chrome/Firefox
- Przetestuj kazdy z 4 zalacznikow z danymi testowymi
- Sprawdz DYN-06: sekcje wspoldzielone Zal. 1 i Zal. 2
- Sprawdz logike 1-faz/3-faz w Zal. 2
- Sprawdz obliczenia Rpo=Rp*Wk w Zal. 4
- Brak bledow w konsoli
</verification>

<success_criteria>
1. Zal. 2: staly wiersz WLZ (IZOL-01), 15 kolumn (IZOL-02), 1-faz aktywne L-N/L-PE/N-PE (IZOL-03), 3-faz 10 pol (IZOL-04), Rw=1 (IZOL-05), ocena Rp>=Rw (IZOL-06), legenda (IZOL-07)
2. Zal. 3: 8 kolumn (RCD-01), tz=300ms (RCD-02), ocena Iw<=In AND tw<=tz (RCD-03), dodawanie wierszy (RCD-04), legenda (RCD-05)
3. Zal. 4: 7 kolumn (UZIEM-01), Rpo=Rp*Wk (UZIEM-02), Rw=10 (UZIEM-03), ocena Rpo<=Rw (UZIEM-04), dodawanie wierszy (UZIEM-05), legenda (UZIEM-06)
4. Wszystkie 33 wymagania Phase 1 pokryte
5. Uzytkownik weryfikuje dzialanie (checkpoint)
</success_criteria>

<output>
After completion, create `.planning/phases/01-formularze-i-obliczenia/01-03-SUMMARY.md`
</output>
