---
phase: 03-eksport-i-dane
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified: [index.html]
autonomous: true

must_haves:
  truths:
    - "Kliknięcie Zapisz zachowuje dane w localStorage"
    - "Kliknięcie Wczytaj odtwarza dane z localStorage — formularze wypełnione, obliczenia przeliczone, ocena aktualna"
    - "Kliknięcie Eksport JSON pobiera plik .json z danymi protokołu"
    - "Kliknięcie Import JSON wczytuje plik .json i odtwarza stan — identycznie jak Wczytaj z localStorage"
    - "Po wczytaniu danych (localStorage lub JSON) wszystkie zakładki renderują się poprawnie"
    - "Toast notification informuje użytkownika o wyniku operacji (Zapisano / Wczytano / Błąd)"
  artifacts:
    - path: "index.html"
      provides: "Sekcja // === PERSISTENCE === z saveToLocalStorage(), loadFromLocalStorage(), exportToJSON(), importFromJSON(), restoreAppState(), recalculateAll(), showToast()"
      contains: "localStorage.setItem"
  key_links:
    - from: "saveToLocalStorage()"
      to: "localStorage.setItem(STORAGE_KEY, JSON.stringify(AppState))"
      via: "serializacja AppState"
      pattern: "localStorage\\.setItem"
    - from: "loadFromLocalStorage()"
      to: "restoreAppState(saved)"
      via: "JSON.parse + restoreAppState"
      pattern: "restoreAppState"
    - from: "restoreAppState(saved)"
      to: "recalculateAll() + renderFormTab() + renderAttachment1-4()"
      via: "Object.assign + pełny re-render"
      pattern: "recalculateAll"
    - from: "exportToJSON()"
      to: "Blob + URL.createObjectURL + anchor.click()"
      via: "JSON.stringify → Blob download"
      pattern: "createObjectURL"
    - from: "importFromJSON()"
      to: "FileReader + JSON.parse + restoreAppState()"
      via: "input[type=file] → FileReader → restoreAppState"
      pattern: "FileReader"
---

<objective>
Implementacja Persistence — zapis/odczyt z localStorage i eksport/import JSON. Użytkownik może zapisać stan formularza na życzenie, wczytać go w nowej sesji, oraz przenosić dane między komputerami za pomocą pliku .json.

Purpose: Spełnienie wymagań EXP-05 (zapis localStorage), EXP-06 (odczyt localStorage), EXP-07 (eksport JSON), EXP-08 (import JSON).
Output: Sekcja `// === PERSISTENCE ===` w index.html + przyciski Zapisz/Wczytaj/Eksport JSON/Import JSON w nagłówku.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-eksport-i-dane/03-RESEARCH.md
@.planning/phases/03-eksport-i-dane/03-01-SUMMARY.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Persistence — localStorage save/load + JSON export/import + restoreAppState</name>
  <files>index.html</files>
  <action>
Dodaj sekcję `// === PERSISTENCE ===` w index.html PRZED sekcją `// === PDF EXPORTER ===` (lub bezpośrednio PRZED `// === INIT ===` jeśli PDF EXPORTER jest już na końcu).

**1. Stała:**
```javascript
const STORAGE_KEY = 'voltprotokol-state';
```

**2. showToast(message)** — prosty toast notification bez biblioteki:
- Tworzy `<div>` z klasami Tailwind: `fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm z-50`
- `document.body.appendChild(toast)`
- `setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 2500)` — guard na parentNode
- Nie używa alert() — nie blokuje UI

**3. recalculateAll()** — przelicza calculated we wszystkich wierszach:
- `AppState.swzFixedRow.calculated = calcSWZRow(AppState.swzFixedRow)`
- Iteracja po `AppState.sections` → subsections → `AppState.attachment1.rowsBySubsection[sub.id]` → `row.calculated = calcSWZRow(row)`
- Identycznie dla `AppState.attachment2.rowsBySubsection[sub.id]` → `row.calculated = calcIZOLRow(row)`
- `AppState.attachment2.fixedRow.calculated = calcIZOLRow(AppState.attachment2.fixedRow)`
- `AppState.attachment3.rows.forEach(row => row.calculated = calcRCDRow(row))`
- `AppState.attachment4.rows.forEach(row => row.calculated = calcUZIEMRow(row))`

**4. restoreAppState(saved)** — przywraca stan po wczytaniu:
- `Object.assign(AppState, JSON.parse(JSON.stringify(saved)))` — głęboka kopia chroni przed mutacją referencji
- WAŻNE: Trzeba nadpisać każdą właściwość AppState, ale nie zastępować samego obiektu (bo referencje w kodzie wskazują na oryginalny AppState). Użyj:
  ```javascript
  const deep = JSON.parse(JSON.stringify(saved));
  // Nadpisz wszystkie klucze
  Object.keys(deep).forEach(k => { AppState[k] = deep[k]; });
  // Usuń klucze które nie istnieją w saved (edge case — nowa wersja → stary JSON)
  Object.keys(AppState).forEach(k => { if (!(k in deep)) delete AppState[k]; });
  ```
- Wywołaj `recalculateAll()`
- Wywołaj pełny re-render: `renderFormTab()`, `renderAttachment1()`, `renderAttachment2()`, `renderAttachment3()`, `renderAttachment4()`
- Wywołaj `updateFinalAssessmentDisplay()` — aktualizuje ocenę końcową

**5. saveToLocalStorage():**
- `try { localStorage.setItem(STORAGE_KEY, JSON.stringify(AppState)); showToast('Dane zapisane.'); }`
- `catch (e) { if (e.name === 'QuotaExceededError') showToast('Błąd: brak miejsca w przeglądarce.'); else showToast('Błąd zapisu: ' + e.message); }`

**6. loadFromLocalStorage():**
- `const raw = localStorage.getItem(STORAGE_KEY);`
- `if (!raw) { showToast('Brak zapisanych danych.'); return; }`
- `try { const saved = JSON.parse(raw); restoreAppState(saved); showToast('Dane wczytane.'); }`
- `catch (e) { showToast('Błąd: uszkodzone dane w localStorage.'); }`

**7. exportToJSON():**
- `const json = JSON.stringify(AppState, null, 2);`
- `const blob = new Blob([json], { type: 'application/json' });`
- `const url = URL.createObjectURL(blob);`
- `const a = document.createElement('a');`
- `a.href = url;`
- Nazwa pliku: `'voltprotokol-' + (AppState.form.protocolNumber || 'draft').replace(/\//g, '-') + '.json'`
- `a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);`

**8. importFromJSON():**
- Tworzy `input` element: `type='file'`, `accept='.json,application/json'`
- `input.onchange = (e) => { ... FileReader ... }`
- `reader.onload = (ev) => { try { const saved = JSON.parse(ev.target.result); restoreAppState(saved); showToast('Wczytano z pliku.'); } catch (err) { showToast('Błąd: nieprawidłowy plik JSON.'); } }`
- `reader.readAsText(file)`
- `input.click()` — otwiera dialog wyboru pliku
  </action>
  <verify>
Wyszukaj w index.html: `localStorage.setItem`, `restoreAppState`, `recalculateAll`, `exportToJSON`, `importFromJSON`, `showToast`. Sprawdź brak błędów składniowych w konsoli.
  </verify>
  <done>
Funkcje saveToLocalStorage(), loadFromLocalStorage(), exportToJSON(), importFromJSON(), restoreAppState(), recalculateAll(), showToast() istnieją w sekcji `// === PERSISTENCE ===`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Przyciski Zapisz/Wczytaj/Eksport JSON/Import JSON w nagłówku + podpięcie</name>
  <files>index.html</files>
  <action>
Rozszerz nagłówek (div z `<h1>` i przyciskiem PDF z planu 03-01) o 4 dodatkowe przyciski. Zmień layout na dwa rzędy lub grupę przycisków.

**Zmiana HTML nagłówka:**
Nagłówek (po planie 03-01) ma `<h1>` + przycisk PDF. Rozszerz o przyciski persistence:
```html
<div class="flex items-center justify-between mb-6 flex-wrap gap-2">
  <h1 class="text-2xl font-bold">Protokół kontrolno-pomiarowy PN-HD 60364-6</h1>
  <div class="flex gap-2 flex-wrap">
    <button id="btn-save" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm font-medium">Zapisz</button>
    <button id="btn-load" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm font-medium">Wczytaj</button>
    <button id="btn-export-json" class="bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm font-medium">Eksport JSON</button>
    <button id="btn-import-json" class="bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm font-medium">Import JSON</button>
    <button id="btn-export-pdf" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-medium">Eksportuj PDF</button>
  </div>
</div>
```

Kolejność przycisków: Zapisz, Wczytaj (localStorage — zielone), Eksport JSON, Import JSON (transfer — szare), Eksportuj PDF (główna akcja — niebieski, na końcu).

**Podpięcie w sekcji INIT:**
Dodaj do bloku `// === INIT ===`:
```javascript
document.getElementById('btn-save').addEventListener('click', saveToLocalStorage);
document.getElementById('btn-load').addEventListener('click', loadFromLocalStorage);
document.getElementById('btn-export-json').addEventListener('click', exportToJSON);
document.getElementById('btn-import-json').addEventListener('click', importFromJSON);
```

Przycisk `btn-export-pdf` już podpięty w planie 03-01 — nie duplikuj.
  </action>
  <verify>
Otwórz index.html w przeglądarce:
1. Widoczne 5 przycisków w nagłówku (Zapisz, Wczytaj, Eksport JSON, Import JSON, Eksportuj PDF)
2. Wypełnij formularz danymi
3. Kliknij Zapisz → toast "Dane zapisane."
4. Odśwież stronę (dane znikają)
5. Kliknij Wczytaj → toast "Dane wczytane." → dane przywrócone we wszystkich zakładkach
6. Kliknij Eksport JSON → pobiera plik .json
7. Odśwież stronę
8. Kliknij Import JSON → wybierz pobrany plik → toast "Wczytano z pliku." → dane przywrócone
9. Brak błędów w konsoli
  </verify>
  <done>
5 przycisków widocznych w nagłówku. Zapisz/Wczytaj działają z localStorage. Eksport/Import JSON działają z plikiem .json. Toast notification po każdej operacji. Po wczytaniu — obliczenia przeliczone, ocena aktualna, formularze wypełnione.
  </done>
</task>

</tasks>

<verification>
1. Otwórz index.html w przeglądarce
2. Wypełnij dane formularza głównego + dodaj sekcje/wiersze w Zał. 1-4
3. Kliknij "Zapisz" → toast "Dane zapisane."
4. Sprawdź localStorage w DevTools (Application → Local Storage) — klucz `voltprotokol-state` istnieje
5. Odśwież stronę → dane czyste
6. Kliknij "Wczytaj" → dane przywrócone, obliczenia przeliczone, ocena aktualna
7. Kliknij "Eksport JSON" → plik .json pobrany
8. Odśwież stronę
9. Kliknij "Import JSON" → wybierz plik → dane przywrócone
10. Kliknij "Eksportuj PDF" → PDF z przywróconymi danymi (weryfikacja cross-feature)
</verification>

<success_criteria>
- Przycisk Zapisz zapisuje cały AppState do localStorage
- Przycisk Wczytaj odtwarza dane z localStorage z pełnym re-renderem
- Przycisk Eksport JSON pobiera plik .json
- Przycisk Import JSON wczytuje plik .json i odtwarza stan
- Toast notification informuje o wyniku operacji
- Po wczytaniu: obliczenia przeliczone (recalculateAll), renderery wywołane, ocena końcowa aktualna
- Brak błędów w konsoli przy Zapisz/Wczytaj/Eksport/Import
</success_criteria>

<output>
After completion, create `.planning/phases/03-eksport-i-dane/03-02-SUMMARY.md`
</output>
