<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoltProtokol - Protokół kontrolno-pomiarowy</title>

  <!-- Tailwind CSS v4 Play CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- pdfmake — załadowany od początku, używany w Fazie 3 -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.3.5/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.3.5/build/vfs_fonts.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">

  <div id="app" class="max-w-7xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-6">Protokół kontrolno-pomiarowy PN-HD 60364-6</h1>

    <!-- Zakładki -->
    <div id="tabs" class="flex border-b border-gray-300 mb-4">
      <button data-tab="1" class="px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600">Zał. 1 - SWZ</button>
      <button data-tab="2" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Zał. 2 - Izolacja</button>
      <button data-tab="3" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Zał. 3 - RCD</button>
      <button data-tab="4" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Zał. 4 - Uziemienie</button>
    </div>

    <!-- Kontenery załączników -->
    <div id="attachment-1"></div>
    <div id="attachment-2" class="hidden"></div>
    <div id="attachment-3" class="hidden"></div>
    <div id="attachment-4" class="hidden"></div>
  </div>

<script>
// === CONSTANTS ===

const PROTECTION_DB = Object.freeze({
  B: { multiplier: 5,  ratings: [6, 8, 10, 13, 16, 20, 25, 32, 40, 50, 63] },
  C: { multiplier: 10, ratings: [6, 8, 10, 13, 16, 20, 25, 32, 40, 50, 63] },
  D: { multiplier: 20, ratings: [6, 8, 10, 13, 16, 20, 25, 32, 40, 50, 63] }
});

function getIa(type, rating) {
  const spec = PROTECTION_DB[type];
  if (!spec) return null;
  if (!spec.ratings.includes(Number(rating))) return null;
  return spec.multiplier * Number(rating);
}

const IZOL_FIELDS_1PHASE = ['L1N', 'L1PE', 'NPE'];
const IZOL_FIELDS_3PHASE = ['L1N','L2N','L3N','L1L2','L1L3','L2L3','L1PE','L2PE','L3PE','NPE'];

function getActiveIZOLFields(phaseType) {
  return phaseType === '3' ? IZOL_FIELDS_3PHASE : IZOL_FIELDS_1PHASE;
}

// === STATE ===

const AppState = {
  sections: [],
  swzFixedRow: {
    circuit: 'Zabezpieczenie główne',
    protType: '',
    protCurrent: null,
    baseType: 'C',
    baseCurrent: 25,
    Ia: null,
    Usk: null,
    tw: '5',
    Zs: null,
    calculated: { Id: null, Zsmax: null, verdict: null }
  },
  attachment1: {
    rowsBySubsection: {}
  },
  attachment2: {
    fixedRow: {
      id: 'izol-fixed',
      name: 'WLZ',
      wireType: '',
      phaseType: '3',
      rp: { L1N: null, L2N: null, L3N: null, L1L2: null, L1L3: null,
            L2L3: null, L1PE: null, L2PE: null, L3PE: null, NPE: null },
      Rw: 1,
      calculated: { verdict: null }
    },
    rowsBySubsection: {}
  },
  attachment3: {
    rows: []
  },
  attachment4: {
    rows: []
  }
};

const UIState = { activeTab: 1 };

// === EVENT BUS ===

const EventBus = (() => {
  const listeners = {};
  return {
    on(event, fn) {
      (listeners[event] = listeners[event] || []).push(fn);
    },
    emit(event, data) {
      (listeners[event] || []).forEach(fn => fn(data));
    }
  };
})();

// === CALCULATOR ===

function roundTo3(val) {
  return Math.round(val * 1000) / 1000;
}

function calcSWZRow(row) {
  const Ia = (row.Ia != null) ? row.Ia : getIa(row.baseType, row.baseCurrent);
  if (!Ia || !row.Usk || !row.Zs) return { Id: null, Zsmax: null, verdict: null };
  const Id = roundTo3(row.Usk / row.Zs);
  const Zsmax = roundTo3(row.Usk / Ia);
  const verdict = roundTo3(row.Zs) <= Zsmax ? 'POZYTYWNA' : 'NEGATYWNA';
  return { Id, Zsmax, verdict };
}

function calcIZOLRow(row) {
  const activeFields = getActiveIZOLFields(row.phaseType);
  const allMeasured = activeFields.every(f => row.rp[f] != null);
  if (!allMeasured) return { verdict: null };
  const allPass = activeFields.every(f => roundTo3(row.rp[f]) >= roundTo3(row.Rw));
  return { verdict: allPass ? 'POZYTYWNA' : 'NEGATYWNA' };
}

function calcRCDRow(row) {
  if (row.Iw == null || row.In == null || row.tw == null || row.tz == null) {
    return { verdict: null };
  }
  const pass = roundTo3(row.Iw) <= roundTo3(row.In) && roundTo3(row.tw) <= roundTo3(row.tz);
  return { verdict: pass ? 'POZYTYWNA' : 'NEGATYWNA' };
}

function calcUZIEMRow(row) {
  if (row.Rp == null || row.Wk == null) return { Rpo: null, verdict: null };
  const Rpo = roundTo3(row.Rp * row.Wk);
  const verdict = Rpo <= roundTo3(row.Rw) ? 'POZYTYWNA' : 'NEGATYWNA';
  return { Rpo, verdict };
}

// === ROW FACTORIES ===

function createNewSWZRow() {
  return {
    id: crypto.randomUUID(),
    circuit: '',
    protType: '',
    protCurrent: null,
    baseType: 'B',
    baseCurrent: 16,
    Ia: null,
    Usk: 230,
    tw: '0.2',
    Zs: null,
    calculated: { Id: null, Zsmax: null, verdict: null }
  };
}

function createNewIZOLRow() {
  return {
    id: crypto.randomUUID(),
    name: '',
    wireType: '',
    phaseType: '1',
    rp: { L1N: null, L2N: null, L3N: null, L1L2: null, L1L3: null,
          L2L3: null, L1PE: null, L2PE: null, L3PE: null, NPE: null },
    Rw: 1,
    calculated: { verdict: null }
  };
}

function createNewRCDRow() {
  return {
    id: crypto.randomUUID(),
    deviceType: '',
    testResult: 'TAK',
    In: null,
    Iw: null,
    tw: null,
    tz: 300,
    calculated: { verdict: null }
  };
}

function createNewUZIEMRow() {
  return {
    id: crypto.randomUUID(),
    deviceName: '',
    Rp: null,
    Wk: null,
    Rw: 10,
    calculated: { Rpo: null, verdict: null }
  };
}

// === LP NUMBERING ===

function getSWZLpNumber(subId, rowId) {
  let counter = 2; // 1 = fixed row
  for (const section of AppState.sections) {
    for (const sub of section.subsections) {
      const rows = AppState.attachment1.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        if (sub.id === subId && row.id === rowId) return counter;
        counter++;
      }
    }
  }
  return counter;
}

function getIZOLLpNumber(subId, rowId) {
  let counter = 2; // 1 = fixed WLZ row
  for (const section of AppState.sections) {
    for (const sub of section.subsections) {
      const rows = AppState.attachment2.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        if (sub.id === subId && row.id === rowId) return counter;
        counter++;
      }
    }
  }
  return counter;
}

// === FORM RENDERER ===

function renderTabs() {
  const tabsContainer = document.getElementById('tabs');
  tabsContainer.querySelectorAll('[data-tab]').forEach(btn => {
    const tabNum = Number(btn.dataset.tab);
    if (tabNum === UIState.activeTab) {
      btn.className = 'px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600';
    } else {
      btn.className = 'px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
    }
  });

  for (let i = 1; i <= 4; i++) {
    const container = document.getElementById('attachment-' + i);
    if (i === UIState.activeTab) {
      container.classList.remove('hidden');
    } else {
      container.classList.add('hidden');
    }
  }
}

function renderBaseCurrentOptions(selectedType, selectedCurrent) {
  const spec = PROTECTION_DB[selectedType];
  if (!spec) return '';
  let opts = '';
  for (const r of spec.ratings) {
    opts += '<option value="' + r + '"' + (r === Number(selectedCurrent) ? ' selected' : '') + '>' + r + '</option>';
  }
  return opts;
}

function renderBaseTypeOptions(selectedType) {
  let opts = '';
  for (const t of ['B', 'C', 'D']) {
    opts += '<option value="' + t + '"' + (t === selectedType ? ' selected' : '') + '>' + t + '</option>';
  }
  return opts;
}

function renderTwOptions(selectedTw) {
  const twValues = ['0.2', '0.4', '5'];
  let opts = '';
  for (const tw of twValues) {
    opts += '<option value="' + tw + '"' + (String(selectedTw) === tw ? ' selected' : '') + '>' + tw + '</option>';
  }
  return opts;
}

function renderSWZRowCells(row, lp, subId, isFixed) {
  const rowIdAttr = isFixed ? 'fixed' : row.id;
  const subIdAttr = subId || '';
  const calc = row.calculated || { Id: null, Zsmax: null, verdict: null };
  const autoIa = getIa(row.baseType, row.baseCurrent);

  const dataAttrs = 'data-row-id="' + rowIdAttr + '"' + (subIdAttr ? ' data-sub-id="' + subIdAttr + '"' : '');
  const inputCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center';
  const selectCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm';

  let html = '';

  // Lp.
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-medium">' + lp + '</td>';

  // Obwod
  if (isFixed) {
    html += '<td class="border border-gray-300 px-2 py-1 font-medium">Zabezpieczenie główne</td>';
  } else {
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="text" data-field="circuit" ' + dataAttrs + ' value="' + escapeHtml(row.circuit || '') + '" class="' + inputCls + '" placeholder="nr obwodu">';
    html += '</td>';
  }

  // Zabezpieczenia dodatkowe - typ
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="text" data-field="protType" ' + dataAttrs + ' value="' + escapeHtml(row.protType || '') + '" class="' + inputCls + '" placeholder="typ">';
  html += '</td>';

  // Zabezpieczenia dodatkowe - prad
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="number" data-field="protCurrent" ' + dataAttrs + ' value="' + (row.protCurrent != null ? row.protCurrent : '') + '" class="' + inputCls + '" placeholder="[A]" step="any">';
  html += '</td>';

  // Zabezpieczenia podstawowe - typ (select B/C/D)
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<select data-field="baseType" ' + dataAttrs + ' class="' + selectCls + '">';
  html += renderBaseTypeOptions(row.baseType);
  html += '</select>';
  html += '</td>';

  // Zabezpieczenia podstawowe - prad (select from PROTECTION_DB ratings)
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<select data-field="baseCurrent" ' + dataAttrs + ' class="' + selectCls + '">';
  html += renderBaseCurrentOptions(row.baseType, row.baseCurrent);
  html += '</select>';
  html += '</td>';

  // Usk
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="number" data-field="Usk" ' + dataAttrs + ' value="' + (row.Usk != null ? row.Usk : '') + '" class="' + inputCls + '" step="0.1" placeholder="[V]">';
  html += '</td>';

  // Ia (editable, placeholder = auto value from DB)
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="number" data-field="Ia" ' + dataAttrs + ' value="' + (row.Ia != null ? row.Ia : '') + '" class="' + inputCls + '" placeholder="' + (autoIa != null ? autoIa : '') + '" step="any">';
  html += '</td>';

  // Id (computed, display only)
  html += '<td class="border border-gray-300 px-2 py-1 text-right text-sm font-mono id-cell" data-row-id="' + rowIdAttr + '">' + (calc.Id != null ? calc.Id.toFixed(2) : '') + '</td>';

  // Zs
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="number" data-field="Zs" ' + dataAttrs + ' value="' + (row.Zs != null ? row.Zs : '') + '" class="' + inputCls + '" step="0.001" placeholder="[&Omega;]">';
  html += '</td>';

  // Zsmax (computed, display only)
  html += '<td class="border border-gray-300 px-2 py-1 text-right text-sm font-mono zsmax-cell" data-row-id="' + rowIdAttr + '">' + (calc.Zsmax != null ? calc.Zsmax.toFixed(2) : '') + '</td>';

  // tw (select 0.2 / 0.4 / 5)
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<select data-field="tw" ' + dataAttrs + ' class="' + selectCls + '">';
  html += renderTwOptions(row.tw);
  html += '</select>';
  html += '</td>';

  // Ocena (verdict)
  const verdictClass = calc.verdict === 'POZYTYWNA' ? 'text-green-700' : calc.verdict === 'NEGATYWNA' ? 'text-red-700' : '';
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-bold verdict-cell ' + verdictClass + '" data-row-id="' + rowIdAttr + '">' + (calc.verdict || '') + '</td>';

  // Action (delete or fixed indicator)
  if (isFixed) {
    html += '<td class="border border-gray-300 px-2 py-1 text-center text-gray-400" title="Wiersz stały - nie można usunąć">-</td>';
  } else {
    html += '<td class="border border-gray-300 px-1 py-1 text-center">';
    html += '<button data-action="remove-row" data-row-id="' + row.id + '" data-sub-id="' + subId + '" data-attachment="1" class="text-red-500 hover:text-red-700 text-xs">Usuń</button>';
    html += '</td>';
  }

  return html;
}

function renderAttachment1() {
  const container = document.getElementById('attachment-1');
  let html = '';

  html += '<h2 class="text-lg font-semibold mb-3">Załącznik nr 1 - Skuteczność ochrony przez samoczynne wyłączenie zasilania</h2>';
  html += '<button data-action="add-section" class="mb-3 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Dodaj sekcję</button>';

  html += '<div class="overflow-x-auto">';
  html += '<table class="w-full border-collapse border border-gray-300 text-sm">';

  // 4-row header (as in reference)
  html += '<thead class="bg-gray-50 text-xs text-center">';

  // Row 1: main headers
  html += '<tr>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-10">Lp.</th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 min-w-[120px]">Obwód<br><span class="font-normal text-gray-500">numer gniazda</span></th>';
  html += '<th colspan="4" class="border border-gray-300 px-2 py-1">Zabezpieczenia</th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-16">U<sub>sk</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-16">I<sub>a</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-16">I<sub>d</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-16">Z<sub>s</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-20">Z<sub>s max</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-14">t<sub>w</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-24">Ocena</th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-10"></th>';
  html += '</tr>';

  // Row 2: zabezpieczenia sub-headers
  html += '<tr>';
  html += '<th colspan="2" class="border border-gray-300 px-2 py-1">dodatkowe</th>';
  html += '<th colspan="2" class="border border-gray-300 px-2 py-1">podstawowe</th>';
  html += '</tr>';

  // Row 3: typ / prad labels
  html += '<tr>';
  html += '<th class="border border-gray-300 px-1 py-0.5">typ</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">prąd</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">typ</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">prąd I<sub>&Delta;n</sub></th>';
  html += '</tr>';

  // Row 4: units
  html += '<tr class="text-gray-500">';
  html += '<th class="border border-gray-300 px-1 py-0.5">-</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">[A]</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">-</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">[A]</th>';
  html += '</tr>';

  html += '</thead>';

  html += '<tbody>';

  // Fixed row: Tablica rozdzielcza (Lp.1)
  const fr = AppState.swzFixedRow;
  html += '<tr class="bg-yellow-50" data-row-id="fixed">';
  html += renderSWZRowCells(fr, 1, null, true);
  html += '</tr>';

  // Dynamic sections
  for (const section of AppState.sections) {
    // Section header row
    html += '<tr class="bg-gray-200">';
    html += '<td colspan="12" class="border border-gray-300 px-2 py-1 font-bold">';
    html += '<input type="text" data-field="section-title" data-section-id="' + section.id + '" value="' + escapeHtml(section.title) + '" class="bg-transparent font-bold w-64 outline-none focus:bg-white focus:ring-1 focus:ring-blue-400 rounded px-1">';
    html += '<button data-action="add-subsection" data-section-id="' + section.id + '" class="ml-3 px-2 py-0.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Dodaj podtytuł</button>';
    html += '</td>';
    html += '<td colspan="2" class="border border-gray-300 px-2 py-1 text-right">';
    html += '<button data-action="remove-section" data-section-id="' + section.id + '" class="px-2 py-0.5 bg-red-500 text-white rounded text-xs hover:bg-red-600">Usuń sekcję</button>';
    html += '</td>';
    html += '</tr>';

    for (const sub of section.subsections) {
      // Subsection header row
      html += '<tr class="bg-gray-100">';
      html += '<td colspan="12" class="border border-gray-300 px-2 py-1 italic">';
      html += '<input type="text" data-field="subsection-title" data-section-id="' + section.id + '" data-sub-id="' + sub.id + '" value="' + escapeHtml(sub.title) + '" class="bg-transparent italic w-64 outline-none focus:bg-white focus:ring-1 focus:ring-blue-400 rounded px-1">';
      html += '<button data-action="add-row-swz" data-sub-id="' + sub.id + '" class="ml-3 px-2 py-0.5 bg-green-500 text-white rounded text-xs hover:bg-green-600">Dodaj wiersz</button>';
      html += '</td>';
      html += '<td colspan="2" class="border border-gray-300 px-2 py-1 text-right">';
      html += '<button data-action="remove-subsection" data-section-id="' + section.id + '" data-sub-id="' + sub.id + '" class="px-2 py-0.5 bg-red-400 text-white rounded text-xs hover:bg-red-500">Usuń podtytuł</button>';
      html += '</td>';
      html += '</tr>';

      // Data rows for this subsection
      const rows = AppState.attachment1.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        const lp = getSWZLpNumber(sub.id, row.id);
        html += '<tr data-row-id="' + row.id + '" data-sub-id="' + sub.id + '">';
        html += renderSWZRowCells(row, lp, sub.id, false);
        html += '</tr>';
      }
    }
  }

  html += '</tbody></table>';
  html += '</div>';

  // Legend SWZ-07
  html += '<div class="mt-4 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">';
  html += '<div><strong>I<sub>n</sub></strong> - prąd znamionowy zabezpieczenia [A]</div>';
  html += '<div><strong>I<sub>a</sub></strong> - prąd zapewniający samoczynne wyłączenie zasilania [A]</div>';
  html += '<div><strong>I<sub>d</sub></strong> - prąd obliczeniowy zwarcia jednofazowego [A]</div>';
  html += '<div><strong>t<sub>w</sub></strong> - wymagany czas wyłączenia [s]</div>';
  html += '<div><strong>Z<sub>s</sub></strong> - zmierzona impedancja pętli zwarcia [&Omega;]</div>';
  html += '<div><strong>Z<sub>s max</sub></strong> - dopuszczalna impedancja pętli zwarcia [&Omega;]</div>';
  html += '<div><strong>U<sub>sk</sub></strong> - napięcie znamionowe źródła zasilania [V]</div>';
  html += '</div>';

  container.innerHTML = html;
}

function renderIZOLRowCells(row, lp, subId, isFixed) {
  const rowIdAttr = isFixed ? 'izol-fixed' : row.id;
  const subIdAttr = subId || '';
  const calc = row.calculated || { verdict: null };
  const izolFields = ['L1N','L2N','L3N','L1L2','L1L3','L2L3','L1PE','L2PE','L3PE','NPE'];
  const activeFields = getActiveIZOLFields(row.phaseType);

  const dataAttrs = 'data-row-id="' + rowIdAttr + '"' + (subIdAttr ? ' data-sub-id="' + subIdAttr + '"' : '') + ' data-attachment="2"';
  const inputCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center';

  let html = '';

  // Lp.
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-medium">' + lp + '</td>';

  // Nazwa obwodu
  if (isFixed) {
    html += '<td class="border border-gray-300 px-2 py-1 font-medium">WLZ</td>';
  } else {
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="text" data-field="izol-name" ' + dataAttrs + ' value="' + escapeHtml(row.name || '') + '" class="' + inputCls + '" placeholder="nazwa obwodu">';
    html += '</td>';
  }

  // Typ przewodu
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="text" data-field="izol-wireType" ' + dataAttrs + ' value="' + escapeHtml(row.wireType || '') + '" class="' + inputCls + '" placeholder="typ przewodu">';
  html += '</td>';

  // Fazy select
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  if (isFixed) {
    html += '<span class="text-sm text-gray-500">3-faz</span>';
  } else {
    html += '<select data-field="izol-phaseType" ' + dataAttrs + ' class="w-full border border-gray-300 rounded px-1 py-0.5 text-sm">';
    html += '<option value="1"' + (row.phaseType === '1' ? ' selected' : '') + '>1-fazowy</option>';
    html += '<option value="3"' + (row.phaseType === '3' ? ' selected' : '') + '>3-fazowy</option>';
    html += '</select>';
  }
  html += '</td>';

  // 10 Rp fields
  for (const field of izolFields) {
    const isActive = activeFields.includes(field);
    const val = row.rp[field] != null ? row.rp[field] : '';
    const disabledAttr = isActive ? '' : ' disabled';
    const disabledCls = isActive ? '' : ' bg-gray-100 text-gray-400 cursor-not-allowed';
    html += '<td class="border border-gray-300 px-0.5 py-0.5">';
    html += '<input type="number" data-field="izol-rp-' + field + '" ' + dataAttrs + ' value="' + val + '" step="0.01" class="w-14 border border-gray-300 rounded px-0.5 py-0.5 text-sm text-center font-mono' + disabledCls + '"' + disabledAttr + '>';
    html += '</td>';
  }

  // Rw (not editable, display "1")
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-mono">' + row.Rw + '</td>';

  // Verdict
  const verdictClass = calc.verdict === 'POZYTYWNA' ? 'text-green-700' : calc.verdict === 'NEGATYWNA' ? 'text-red-700' : '';
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-bold izol-verdict-cell ' + verdictClass + '" data-row-id="' + rowIdAttr + '">' + (calc.verdict || '') + '</td>';

  // Action
  if (isFixed) {
    html += '<td class="border border-gray-300 px-2 py-1 text-center text-gray-400" title="Wiersz stały - nie można usunąć">-</td>';
  } else {
    html += '<td class="border border-gray-300 px-1 py-1 text-center">';
    html += '<button data-action="remove-row" data-row-id="' + row.id + '" data-sub-id="' + subId + '" data-attachment="2" class="text-red-500 hover:text-red-700 text-xs">Usuń</button>';
    html += '</td>';
  }

  return html;
}

function renderAttachment2() {
  const container = document.getElementById('attachment-2');
  let html = '';

  html += '<h2 class="text-lg font-semibold mb-3">Załącznik nr 2 - Rezystancja izolacji</h2>';
  html += '<p class="mb-3 text-sm text-blue-600 italic">Sekcje zarządzane z Zał. 1</p>';

  html += '<div class="overflow-x-auto">';
  html += '<table class="min-w-max border-collapse text-sm">';

  // Header Row 1
  html += '<thead class="bg-gray-50 text-xs text-center">';
  html += '<tr>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-10">Lp.</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 min-w-[120px]">Nazwa obwodu</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 min-w-[100px]">Typ przewodu</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-20">Fazy</th>';
  html += '<th colspan="10" class="border border-gray-300 px-2 py-1">R<sub>p</sub> [M&Omega;]</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-14">R<sub>w</sub><br>[M&Omega;]</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-24">Ocena</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-10"></th>';
  html += '</tr>';

  // Header Row 2 - Rp sub-columns
  html += '<tr>';
  const izolCols = ['L1-N','L2-N','L3-N','L1-L2','L1-L3','L2-L3','L1-PE','L2-PE','L3-PE','N-PE'];
  for (const col of izolCols) {
    html += '<th class="border border-gray-300 px-1 py-0.5 text-xs font-normal text-gray-600">' + col + '</th>';
  }
  html += '</tr>';
  html += '</thead>';

  html += '<tbody>';

  // Fixed row: WLZ (Lp.1) - always 3-phase
  const ifr = AppState.attachment2.fixedRow;
  ifr.calculated = calcIZOLRow(ifr);
  html += '<tr class="bg-yellow-50" data-row-id="izol-fixed">';
  html += renderIZOLRowCells(ifr, 1, null, true);
  html += '</tr>';

  // Shared sections from AppState.sections (DYN-06)
  for (const section of AppState.sections) {
    // Section header row (read-only title)
    html += '<tr class="bg-gray-200 font-bold">';
    html += '<td colspan="17" class="border border-gray-300 px-2 py-1">' + escapeHtml(section.title) + '</td>';
    html += '</tr>';

    for (const sub of section.subsections) {
      // Subsection header row (read-only title, add-row for Zal.2)
      html += '<tr class="bg-gray-100 italic">';
      html += '<td colspan="15" class="border border-gray-300 px-2 py-1">';
      html += escapeHtml(sub.title);
      html += '<button data-action="add-row-izol" data-sub-id="' + sub.id + '" class="ml-3 px-2 py-0.5 bg-green-500 text-white rounded text-xs hover:bg-green-600 not-italic font-normal">Dodaj wiersz</button>';
      html += '</td>';
      html += '<td colspan="2" class="border border-gray-300 px-2 py-1"></td>';
      html += '</tr>';

      // Data rows for this subsection in Zal.2
      const rows = AppState.attachment2.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        const lp = getIZOLLpNumber(sub.id, row.id);
        row.calculated = calcIZOLRow(row);
        html += '<tr data-row-id="' + row.id + '" data-sub-id="' + sub.id + '">';
        html += renderIZOLRowCells(row, lp, sub.id, false);
        html += '</tr>';
      }
    }
  }

  html += '</tbody></table>';
  html += '</div>';

  // Legend IZOL-07
  html += '<div class="mt-4 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">';
  html += '<div><strong>R<sub>p</sub></strong> - Zmierzona wartość rezystancji izolacji [M&Omega;]</div>';
  html += '<div><strong>R<sub>w</sub></strong> - Wymagana wartość rezystancji izolacji [M&Omega;]</div>';
  html += '</div>';

  container.innerHTML = html;
}

function renderAttachment3() {
  const container = document.getElementById('attachment-3');
  const inputCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center';
  const selectCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm';
  let html = '';

  html += '<h2 class="text-lg font-semibold mb-3">Załącznik nr 3 - Badanie wyłączników różnicowoprądowych (RCD)</h2>';

  html += '<div class="overflow-x-auto">';
  html += '<table class="w-full border-collapse text-sm">';

  // Header (1 row)
  html += '<thead>';
  html += '<tr class="bg-gray-50 text-center font-semibold">';
  html += '<th class="border border-gray-300 px-2 py-1 w-10">Lp.</th>';
  html += '<th class="border border-gray-300 px-2 py-1 min-w-[180px]">Typ urządzenia</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-16">TEST</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">I<sub>n</sub> [mA]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">I<sub>w</sub> [mA]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">t<sub>w</sub> [ms]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">t<sub>z</sub> [ms]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-24">Ocena</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-10"></th>';
  html += '</tr>';
  html += '</thead>';

  html += '<tbody>';

  for (let i = 0; i < AppState.attachment3.rows.length; i++) {
    const row = AppState.attachment3.rows[i];
    const lp = i + 1;
    row.calculated = calcRCDRow(row);
    const calc = row.calculated;
    const dataAttrs = 'data-row-id="' + row.id + '" data-attachment="3"';

    html += '<tr data-row-id="' + row.id + '">';

    // Lp.
    html += '<td class="border border-gray-300 px-2 py-1 text-center font-medium">' + lp + '</td>';

    // Typ urzadzenia
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="text" data-field="rcd-deviceType" ' + dataAttrs + ' value="' + escapeHtml(row.deviceType || '') + '" class="' + inputCls + '" placeholder="np. Eaton PF7-25/2/003-A">';
    html += '</td>';

    // TEST (TAK/NIE)
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<select data-field="rcd-testResult" ' + dataAttrs + ' class="' + selectCls + '">';
    html += '<option value="TAK"' + (row.testResult === 'TAK' ? ' selected' : '') + '>TAK</option>';
    html += '<option value="NIE"' + (row.testResult === 'NIE' ? ' selected' : '') + '>NIE</option>';
    html += '</select>';
    html += '</td>';

    // In [mA]
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="rcd-In" ' + dataAttrs + ' value="' + (row.In != null ? row.In : '') + '" step="1" class="' + inputCls + ' font-mono" placeholder="mA">';
    html += '</td>';

    // Iw [mA]
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="rcd-Iw" ' + dataAttrs + ' value="' + (row.Iw != null ? row.Iw : '') + '" step="0.1" class="' + inputCls + ' font-mono" placeholder="mA">';
    html += '</td>';

    // tw [ms]
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="rcd-tw" ' + dataAttrs + ' value="' + (row.tw != null ? row.tw : '') + '" step="1" class="' + inputCls + ' font-mono" placeholder="ms">';
    html += '</td>';

    // tz [ms] (default 300)
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="rcd-tz" ' + dataAttrs + ' value="' + (row.tz != null ? row.tz : '') + '" step="1" class="' + inputCls + ' font-mono" placeholder="ms">';
    html += '</td>';

    // Verdict
    const verdictClass = calc.verdict === 'POZYTYWNA' ? 'text-green-700' : calc.verdict === 'NEGATYWNA' ? 'text-red-700' : '';
    html += '<td class="border border-gray-300 px-2 py-1 text-center font-bold rcd-verdict-cell ' + verdictClass + '" data-row-id="' + row.id + '">' + (calc.verdict || '') + '</td>';

    // Usun
    html += '<td class="border border-gray-300 px-1 py-1 text-center">';
    html += '<button data-action="remove-row" data-row-id="' + row.id + '" data-attachment="3" class="text-red-500 hover:text-red-700 text-xs">Usuń</button>';
    html += '</td>';

    html += '</tr>';
  }

  if (AppState.attachment3.rows.length === 0) {
    html += '<tr><td colspan="9" class="border border-gray-300 px-2 py-4 text-center text-gray-400 italic">Brak wierszy - kliknij "Dodaj wiersz RCD"</td></tr>';
  }

  html += '</tbody></table>';
  html += '</div>';

  // "Dodaj wiersz RCD" button below table
  html += '<button data-action="add-row-rcd" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Dodaj wiersz RCD</button>';

  // Legend RCD-05
  html += '<div class="mt-4 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">';
  html += '<div><strong>I<sub>n</sub></strong> - Znamionowy prąd różnicowy wyłącznika [mA]</div>';
  html += '<div><strong>I<sub>w</sub></strong> - Zmierzony prąd wyłączający [mA]</div>';
  html += '<div><strong>t<sub>w</sub></strong> - Zmierzony czas wyłączenia [ms]</div>';
  html += '<div><strong>t<sub>z</sub></strong> - Dopuszczalny czas wyłączenia [ms]</div>';
  html += '</div>';

  container.innerHTML = html;
}

function renderAttachment4() {
  const container = document.getElementById('attachment-4');
  const inputCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center';
  let html = '';

  html += '<h2 class="text-lg font-semibold mb-3">Załącznik nr 4 - Rezystancja uziemienia</h2>';

  html += '<div class="overflow-x-auto">';
  html += '<table class="w-full border-collapse text-sm">';

  // Header (1 row)
  html += '<thead>';
  html += '<tr class="bg-gray-50 text-center font-semibold">';
  html += '<th class="border border-gray-300 px-2 py-1 w-10">Lp.</th>';
  html += '<th class="border border-gray-300 px-2 py-1 min-w-[180px]">Nazwa urządzenia</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">R<sub>E</sub> [&Omega;]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-16">W<sub>k</sub></th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">R<sub>po</sub> [&Omega;]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">R<sub>w</sub> [&Omega;]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-24">Ocena</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-10"></th>';
  html += '</tr>';
  html += '</thead>';

  html += '<tbody>';

  for (let i = 0; i < AppState.attachment4.rows.length; i++) {
    const row = AppState.attachment4.rows[i];
    const lp = i + 1;
    row.calculated = calcUZIEMRow(row);
    const calc = row.calculated;
    const dataAttrs = 'data-row-id="' + row.id + '" data-attachment="4"';

    html += '<tr data-row-id="' + row.id + '">';

    // Lp.
    html += '<td class="border border-gray-300 px-2 py-1 text-center font-medium">' + lp + '</td>';

    // Nazwa urzadzenia
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="text" data-field="uziem-deviceName" ' + dataAttrs + ' value="' + escapeHtml(row.deviceName || '') + '" class="' + inputCls + '" placeholder="np. Instalacja odgromowa">';
    html += '</td>';

    // Rp (RE) [Ohm]
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="uziem-Rp" ' + dataAttrs + ' value="' + (row.Rp != null ? row.Rp : '') + '" step="0.01" class="' + inputCls + ' font-mono" placeholder="&Omega;">';
    html += '</td>';

    // Wk
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="uziem-Wk" ' + dataAttrs + ' value="' + (row.Wk != null ? row.Wk : '') + '" step="0.01" class="' + inputCls + ' font-mono" placeholder="Wk">';
    html += '</td>';

    // Rpo (computed, display only)
    html += '<td class="border border-gray-300 px-2 py-1 text-right font-mono uziem-rpo-cell" data-row-id="' + row.id + '">' + (calc.Rpo != null ? calc.Rpo.toFixed(2) : '') + '</td>';

    // Rw [Ohm] (editable, default 10)
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="uziem-Rw" ' + dataAttrs + ' value="' + (row.Rw != null ? row.Rw : '') + '" step="0.1" class="' + inputCls + ' font-mono" placeholder="&Omega;">';
    html += '</td>';

    // Verdict
    const verdictClass = calc.verdict === 'POZYTYWNA' ? 'text-green-700' : calc.verdict === 'NEGATYWNA' ? 'text-red-700' : '';
    html += '<td class="border border-gray-300 px-2 py-1 text-center font-bold uziem-verdict-cell ' + verdictClass + '" data-row-id="' + row.id + '">' + (calc.verdict || '') + '</td>';

    // Usun
    html += '<td class="border border-gray-300 px-1 py-1 text-center">';
    html += '<button data-action="remove-row" data-row-id="' + row.id + '" data-attachment="4" class="text-red-500 hover:text-red-700 text-xs">Usuń</button>';
    html += '</td>';

    html += '</tr>';
  }

  if (AppState.attachment4.rows.length === 0) {
    html += '<tr><td colspan="8" class="border border-gray-300 px-2 py-4 text-center text-gray-400 italic">Brak wierszy - kliknij "Dodaj wiersz"</td></tr>';
  }

  html += '</tbody></table>';
  html += '</div>';

  // "Dodaj wiersz" button below table (UZIEM-05)
  html += '<button data-action="add-row-uziem" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Dodaj wiersz</button>';

  // Legend UZIEM-06
  html += '<div class="mt-4 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">';
  html += '<div><strong>R<sub>E</sub></strong> - Zmierzona wartość rezystancji uziemienia [&Omega;]</div>';
  html += '<div><strong>W<sub>k</sub></strong> - Współczynnik korekcyjny</div>';
  html += '<div><strong>R<sub>po</sub></strong> - Obliczona wartość rezystancji uziemienia [&Omega;]</div>';
  html += '<div><strong>R<sub>w</sub></strong> - Wymagana wartość rezystancji uziemienia [&Omega;]</div>';
  html += '</div>';

  container.innerHTML = html;
}

// === HELPERS ===

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// === FORM CONTROLLER ===

function bindTabEvents() {
  document.getElementById('tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('[data-tab]');
    if (!btn) return;
    UIState.activeTab = Number(btn.dataset.tab);
    renderTabs();
  });
}

function bindAppEvents() {
  const app = document.getElementById('app');

  // Click delegation
  app.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;

    if (action === 'add-section') {
      const newSection = {
        id: crypto.randomUUID(),
        title: 'Nowa sekcja',
        subsections: []
      };
      AppState.sections.push(newSection);
      EventBus.emit('sections:changed');
    }

    if (action === 'add-subsection') {
      const sectionId = btn.dataset.sectionId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (!section) return;
      const newSub = {
        id: crypto.randomUUID(),
        title: 'Nowy podtytuł'
      };
      section.subsections.push(newSub);
      // Initialize rowsBySubsection for BOTH attachments (Pitfall 5)
      AppState.attachment1.rowsBySubsection[newSub.id] = [];
      AppState.attachment2.rowsBySubsection[newSub.id] = [];
      EventBus.emit('sections:changed');
    }

    if (action === 'add-row-swz') {
      const subId = btn.dataset.subId;
      if (!AppState.attachment1.rowsBySubsection[subId]) {
        AppState.attachment1.rowsBySubsection[subId] = [];
      }
      AppState.attachment1.rowsBySubsection[subId].push(createNewSWZRow());
      EventBus.emit('attachment1:changed');
    }

    if (action === 'add-row-izol') {
      const subId = btn.dataset.subId;
      if (!AppState.attachment2.rowsBySubsection[subId]) {
        AppState.attachment2.rowsBySubsection[subId] = [];
      }
      AppState.attachment2.rowsBySubsection[subId].push(createNewIZOLRow());
      EventBus.emit('attachment2:changed');
    }

    if (action === 'add-row-rcd') {
      AppState.attachment3.rows.push(createNewRCDRow());
      EventBus.emit('attachment3:changed');
    }

    if (action === 'add-row-uziem') {
      AppState.attachment4.rows.push(createNewUZIEMRow());
      EventBus.emit('attachment4:changed');
    }

    if (action === 'remove-section') {
      const sectionId = btn.dataset.sectionId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (!section) return;
      // Remove all rows from both attachments for all subsections
      for (const sub of section.subsections) {
        delete AppState.attachment1.rowsBySubsection[sub.id];
        delete AppState.attachment2.rowsBySubsection[sub.id];
      }
      AppState.sections = AppState.sections.filter(s => s.id !== sectionId);
      EventBus.emit('sections:changed');
    }

    if (action === 'remove-subsection') {
      const sectionId = btn.dataset.sectionId;
      const subId = btn.dataset.subId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (!section) return;
      section.subsections = section.subsections.filter(s => s.id !== subId);
      // Remove rows from both attachments
      delete AppState.attachment1.rowsBySubsection[subId];
      delete AppState.attachment2.rowsBySubsection[subId];
      EventBus.emit('sections:changed');
    }

    if (action === 'remove-row') {
      const rowId = btn.dataset.rowId;
      const subId = btn.dataset.subId;
      const attachment = btn.dataset.attachment;

      if (attachment === '1' && subId) {
        const rows = AppState.attachment1.rowsBySubsection[subId];
        if (rows) {
          AppState.attachment1.rowsBySubsection[subId] = rows.filter(r => r.id !== rowId);
        }
        EventBus.emit('attachment1:changed');
      }

      if (attachment === '2' && subId) {
        const rows = AppState.attachment2.rowsBySubsection[subId];
        if (rows) {
          AppState.attachment2.rowsBySubsection[subId] = rows.filter(r => r.id !== rowId);
        }
        EventBus.emit('attachment2:changed');
      }

      if (attachment === '3') {
        AppState.attachment3.rows = AppState.attachment3.rows.filter(r => r.id !== rowId);
        EventBus.emit('attachment3:changed');
      }

      if (attachment === '4') {
        AppState.attachment4.rows = AppState.attachment4.rows.filter(r => r.id !== rowId);
        EventBus.emit('attachment4:changed');
      }
    }
  });

  // Input delegation (for section/subsection title editing AND SWZ field editing)
  app.addEventListener('input', (e) => {
    const field = e.target.dataset.field;
    if (!field) return;

    if (field === 'section-title') {
      const sectionId = e.target.dataset.sectionId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (section) {
        section.title = e.target.value;
        // Re-render Zal.2 only (Zal.1 is being edited - no re-render needed for it)
        renderAttachment2();
      }
      return;
    }

    if (field === 'subsection-title') {
      const sectionId = e.target.dataset.sectionId;
      const subId = e.target.dataset.subId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (section) {
        const sub = section.subsections.find(s => s.id === subId);
        if (sub) {
          sub.title = e.target.value;
          // Re-render Zal.2 only
          renderAttachment2();
        }
      }
      return;
    }

    // IZOL field editing
    if (field && field.startsWith('izol-')) {
      handleIZOLFieldChange(e.target);
      return;
    }

    // RCD field editing
    if (field && field.startsWith('rcd-')) {
      handleRCDFieldChange(e.target);
      return;
    }

    // UZIEM field editing
    if (field && field.startsWith('uziem-')) {
      handleUZIEMFieldChange(e.target);
      return;
    }

    // SWZ field editing (input fields: circuit, protType, protCurrent, Usk, Ia, Zs)
    handleSWZFieldChange(e.target);
  });

  // Change delegation (for selects: baseType, baseCurrent, tw, izol-phaseType, rcd-testResult)
  app.addEventListener('change', (e) => {
    const field = e.target.dataset.field;
    if (!field) return;

    // IZOL phaseType select
    if (field === 'izol-phaseType') {
      handleIZOLFieldChange(e.target);
      return;
    }

    // RCD testResult select
    if (field === 'rcd-testResult') {
      handleRCDFieldChange(e.target);
      return;
    }

    // SWZ select fields
    handleSWZFieldChange(e.target);
  });
}

// === SWZ FIELD CHANGE HANDLER ===

const SWZ_FIELDS = new Set(['circuit', 'protType', 'protCurrent', 'baseType', 'baseCurrent', 'Usk', 'Ia', 'Zs', 'tw']);
const SWZ_NUMERIC_FIELDS = new Set(['protCurrent', 'Usk', 'Ia', 'Zs']);

function findSWZRow(rowId, subId) {
  if (rowId === 'fixed') return AppState.swzFixedRow;
  if (!subId) return null;
  const rows = AppState.attachment1.rowsBySubsection[subId];
  if (!rows) return null;
  return rows.find(r => r.id === rowId) || null;
}

function handleSWZFieldChange(el) {
  const field = el.dataset.field;
  if (!field || !SWZ_FIELDS.has(field)) return;

  const rowId = el.dataset.rowId;
  const subId = el.dataset.subId;
  if (!rowId) return;

  const row = findSWZRow(rowId, subId);
  if (!row) return;

  // Normalize and update value in AppState
  if (SWZ_NUMERIC_FIELDS.has(field)) {
    const val = el.value.trim();
    row[field] = val === '' ? null : parseFloat(val);
  } else if (field === 'baseCurrent') {
    row[field] = Number(el.value);
  } else if (field === 'tw') {
    row[field] = el.value;
  } else {
    // String fields: circuit, protType, baseType
    row[field] = el.value;
  }

  // Special: baseType change -> validate baseCurrent, recalculate, re-render
  if (field === 'baseType') {
    const spec = PROTECTION_DB[row.baseType];
    if (spec && !spec.ratings.includes(Number(row.baseCurrent))) {
      row.baseCurrent = 16; // default if current rating not in new type
    }
    // Recalculate before re-render so row.calculated is fresh
    row.calculated = calcSWZRow(row);
    // Re-render to refresh baseCurrent options and Ia placeholder
    // Save/restore focus
    const activeField = document.activeElement?.dataset?.field;
    const activeRowId = document.activeElement?.dataset?.rowId;
    const activeSubId = document.activeElement?.dataset?.subId;
    renderAttachment1();
    if (activeField && activeRowId) {
      const selector = '[data-field="' + activeField + '"][data-row-id="' + activeRowId + '"]' +
        (activeSubId ? '[data-sub-id="' + activeSubId + '"]' : '');
      const restored = document.querySelector(selector);
      if (restored) restored.focus();
    }
    return;
  }

  // Special: baseCurrent change -> update Ia placeholder (no need for full re-render)
  if (field === 'baseCurrent') {
    // Update Ia placeholder
    const iaInput = document.querySelector('[data-field="Ia"][data-row-id="' + rowId + '"]' +
      (subId ? '[data-sub-id="' + subId + '"]' : ''));
    if (iaInput) {
      const autoIa = getIa(row.baseType, row.baseCurrent);
      iaInput.placeholder = autoIa != null ? autoIa : '';
    }
  }

  // Recalculate
  const result = calcSWZRow(row);
  row.calculated = result;

  // Update DOM: targeted update of computed cells
  updateSWZComputedCells(rowId, result);
}

function updateSWZComputedCells(rowId, result) {
  // Find cells by data-row-id attribute on the cells themselves
  const idCell = document.querySelector('.id-cell[data-row-id="' + rowId + '"]');
  const zsmaxCell = document.querySelector('.zsmax-cell[data-row-id="' + rowId + '"]');
  const verdictCell = document.querySelector('.verdict-cell[data-row-id="' + rowId + '"]');

  if (idCell) {
    idCell.textContent = result.Id != null ? result.Id.toFixed(2) : '';
  }
  if (zsmaxCell) {
    zsmaxCell.textContent = result.Zsmax != null ? result.Zsmax.toFixed(2) : '';
  }
  if (verdictCell) {
    verdictCell.textContent = result.verdict || '';
    verdictCell.classList.remove('text-green-700', 'text-red-700');
    if (result.verdict === 'POZYTYWNA') verdictCell.classList.add('text-green-700');
    if (result.verdict === 'NEGATYWNA') verdictCell.classList.add('text-red-700');
  }
}

// === IZOL FIELD CHANGE HANDLER ===

const IZOL_RP_FIELDS_MAP = {
  'izol-rp-L1N': 'L1N', 'izol-rp-L2N': 'L2N', 'izol-rp-L3N': 'L3N',
  'izol-rp-L1L2': 'L1L2', 'izol-rp-L1L3': 'L1L3', 'izol-rp-L2L3': 'L2L3',
  'izol-rp-L1PE': 'L1PE', 'izol-rp-L2PE': 'L2PE', 'izol-rp-L3PE': 'L3PE',
  'izol-rp-NPE': 'NPE'
};

function findIZOLRow(rowId, subId) {
  if (rowId === 'izol-fixed') return AppState.attachment2.fixedRow;
  if (!subId) return null;
  const rows = AppState.attachment2.rowsBySubsection[subId];
  if (!rows) return null;
  return rows.find(r => r.id === rowId) || null;
}

function handleIZOLFieldChange(el) {
  const field = el.dataset.field;
  if (!field) return;

  const rowId = el.dataset.rowId;
  const subId = el.dataset.subId;
  if (!rowId) return;

  const row = findIZOLRow(rowId, subId);
  if (!row) return;

  // Handle phaseType change
  if (field === 'izol-phaseType') {
    row.phaseType = el.value;
    // Clear values of inactive fields in AppState
    const activeFields = getActiveIZOLFields(row.phaseType);
    const allFields = IZOL_FIELDS_3PHASE;
    for (const f of allFields) {
      if (!activeFields.includes(f)) {
        row.rp[f] = null;
      }
    }
    row.calculated = calcIZOLRow(row);
    // Re-render to apply phase type visuals (disable/enable fields)
    const savedFocus = document.activeElement;
    renderAttachment2();
    return;
  }

  // Handle Rp field changes
  const rpField = IZOL_RP_FIELDS_MAP[field];
  if (rpField) {
    const val = el.value.trim();
    row.rp[rpField] = val === '' ? null : parseFloat(val);
    row.calculated = calcIZOLRow(row);
    updateIZOLVerdict(rowId, row.calculated);
    return;
  }

  // Handle name and wireType
  if (field === 'izol-name') {
    row.name = el.value;
    return;
  }
  if (field === 'izol-wireType') {
    row.wireType = el.value;
    return;
  }
}

function updateIZOLVerdict(rowId, result) {
  const verdictCell = document.querySelector('.izol-verdict-cell[data-row-id="' + rowId + '"]');
  if (verdictCell) {
    verdictCell.textContent = result.verdict || '';
    verdictCell.classList.remove('text-green-700', 'text-red-700');
    if (result.verdict === 'POZYTYWNA') verdictCell.classList.add('text-green-700');
    if (result.verdict === 'NEGATYWNA') verdictCell.classList.add('text-red-700');
  }
}

// === RCD FIELD CHANGE HANDLER ===

const RCD_NUMERIC_FIELDS = { 'rcd-In': 'In', 'rcd-Iw': 'Iw', 'rcd-tw': 'tw', 'rcd-tz': 'tz' };

function findRCDRow(rowId) {
  return AppState.attachment3.rows.find(r => r.id === rowId) || null;
}

function handleRCDFieldChange(el) {
  const field = el.dataset.field;
  if (!field) return;

  const rowId = el.dataset.rowId;
  if (!rowId) return;

  const row = findRCDRow(rowId);
  if (!row) return;

  // Handle numeric fields
  const numericKey = RCD_NUMERIC_FIELDS[field];
  if (numericKey) {
    const val = el.value.trim();
    row[numericKey] = val === '' ? null : parseFloat(val);
    row.calculated = calcRCDRow(row);
    updateRCDVerdict(rowId, row.calculated);
    return;
  }

  // Handle deviceType
  if (field === 'rcd-deviceType') {
    row.deviceType = el.value;
    return;
  }

  // Handle testResult (select)
  if (field === 'rcd-testResult') {
    row.testResult = el.value;
    return;
  }
}

function updateRCDVerdict(rowId, result) {
  const verdictCell = document.querySelector('.rcd-verdict-cell[data-row-id="' + rowId + '"]');
  if (verdictCell) {
    verdictCell.textContent = result.verdict || '';
    verdictCell.classList.remove('text-green-700', 'text-red-700');
    if (result.verdict === 'POZYTYWNA') verdictCell.classList.add('text-green-700');
    if (result.verdict === 'NEGATYWNA') verdictCell.classList.add('text-red-700');
  }
}

// === UZIEM FIELD CHANGE HANDLER ===

const UZIEM_NUMERIC_FIELDS = { 'uziem-Rp': 'Rp', 'uziem-Wk': 'Wk', 'uziem-Rw': 'Rw' };

function findUZIEMRow(rowId) {
  return AppState.attachment4.rows.find(r => r.id === rowId) || null;
}

function handleUZIEMFieldChange(el) {
  const field = el.dataset.field;
  if (!field) return;

  const rowId = el.dataset.rowId;
  if (!rowId) return;

  const row = findUZIEMRow(rowId);
  if (!row) return;

  // Handle numeric fields
  const numericKey = UZIEM_NUMERIC_FIELDS[field];
  if (numericKey) {
    const val = el.value.trim();
    row[numericKey] = val === '' ? null : parseFloat(val);
    row.calculated = calcUZIEMRow(row);
    updateUZIEMComputedCells(rowId, row.calculated);
    return;
  }

  // Handle deviceName
  if (field === 'uziem-deviceName') {
    row.deviceName = el.value;
    return;
  }
}

function updateUZIEMComputedCells(rowId, result) {
  // Update Rpo cell
  const rpoCell = document.querySelector('.uziem-rpo-cell[data-row-id="' + rowId + '"]');
  if (rpoCell) {
    rpoCell.textContent = result.Rpo != null ? result.Rpo.toFixed(2) : '';
  }

  // Update verdict cell
  const verdictCell = document.querySelector('.uziem-verdict-cell[data-row-id="' + rowId + '"]');
  if (verdictCell) {
    verdictCell.textContent = result.verdict || '';
    verdictCell.classList.remove('text-green-700', 'text-red-700');
    if (result.verdict === 'POZYTYWNA') verdictCell.classList.add('text-green-700');
    if (result.verdict === 'NEGATYWNA') verdictCell.classList.add('text-red-700');
  }
}

// === EVENT BUS SUBSCRIPTIONS ===

EventBus.on('sections:changed', () => {
  renderAttachment1();
  renderAttachment2();
});

EventBus.on('attachment1:changed', renderAttachment1);
EventBus.on('attachment2:changed', renderAttachment2);
EventBus.on('attachment3:changed', renderAttachment3);
EventBus.on('attachment4:changed', renderAttachment4);

// === INIT ===

function init() {
  // Initialize default content: one section with one subsection and one row
  const defaultSubId = crypto.randomUUID();
  const defaultSectionId = crypto.randomUUID();

  AppState.sections.push({
    id: defaultSectionId,
    title: 'Parter',
    subsections: [{
      id: defaultSubId,
      title: 'Obwód gniazd wtykowych'
    }]
  });

  // Initialize rowsBySubsection for BOTH attachments (Pitfall 5 / DYN-06)
  AppState.attachment1.rowsBySubsection[defaultSubId] = [createNewSWZRow()];
  AppState.attachment2.rowsBySubsection[defaultSubId] = [];

  renderTabs();
  renderAttachment1();
  renderAttachment2();
  renderAttachment3();
  renderAttachment4();
  bindTabEvents();
  bindAppEvents();
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
