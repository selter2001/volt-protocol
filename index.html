<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoltProtokol - Protokół kontrolno-pomiarowy</title>

  <!-- Tailwind CSS v4 Play CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- pdfmake — załadowany od początku, używany w Fazie 3 -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.3.5/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.3.5/build/vfs_fonts.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">

  <div id="app" class="max-w-7xl mx-auto p-4">
    <div class="flex items-center justify-between mb-6 flex-wrap gap-2">
      <h1 class="text-2xl font-bold">Protokół kontrolno-pomiarowy PN-HD 60364-6</h1>
      <div class="flex gap-2 flex-wrap">
        <button id="btn-save" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm font-medium">Zapisz</button>
        <button id="btn-load" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm font-medium">Wczytaj</button>
        <button id="btn-export-json" class="bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm font-medium">Eksport JSON</button>
        <button id="btn-import-json" class="bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm font-medium">Import JSON</button>
        <button id="btn-export-word" class="bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700 text-sm font-medium">Eksport Word</button>
        <button id="btn-import-word" class="bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700 text-sm font-medium">Import Word</button>
        <button id="btn-export-pdf" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-medium">Eksportuj PDF</button>
      </div>
    </div>

    <!-- Zakładki -->
    <div id="tabs" class="flex border-b border-gray-300 mb-4">
      <button data-tab="0" class="px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600">Protokół</button>
      <button data-tab="1" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Zał. 1 - SWZ</button>
      <button data-tab="2" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Zał. 2 - Izolacja</button>
      <button data-tab="3" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Zał. 3 - RCD</button>
      <button data-tab="4" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">Zał. 4 - Uziemienie</button>
    </div>

    <!-- Kontenery załączników -->
    <div id="attachment-0"></div>
    <div id="attachment-1" class="hidden"></div>
    <div id="attachment-2" class="hidden"></div>
    <div id="attachment-3" class="hidden"></div>
    <div id="attachment-4" class="hidden"></div>

    <!-- Footer -->
    <div class="mt-8 pt-4 border-t border-gray-200 text-center text-xs text-gray-400">
      VoltProtocol &copy; 2026 Wojciech Olszak &middot; <a href="https://github.com/selter2001/volt-protocol" class="underline hover:text-gray-600">GitHub</a> &middot; MIT License
    </div>
  </div>

<script>
// === CONSTANTS ===

const PROTECTION_DB = Object.freeze({
  B: { multiplier: 5,  ratings: [6, 8, 10, 13, 16, 20, 25, 32, 40, 50, 63] },
  C: { multiplier: 10, ratings: [6, 8, 10, 13, 16, 20, 25, 32, 40, 50, 63] },
  D: { multiplier: 20, ratings: [6, 8, 10, 13, 16, 20, 25, 32, 40, 50, 63] }
});

function getIa(type, rating) {
  const spec = PROTECTION_DB[type];
  if (!spec) return null;
  if (!spec.ratings.includes(Number(rating))) return null;
  return spec.multiplier * Number(rating);
}

const IZOL_FIELDS_1PHASE = ['L1N', 'L1PE', 'NPE'];
const IZOL_FIELDS_3PHASE = ['L1N','L2N','L3N','L1L2','L1L3','L2L3','L1PE','L2PE','L3PE','NPE'];

function getActiveIZOLFields(phaseType) {
  return phaseType === '3' ? IZOL_FIELDS_3PHASE : IZOL_FIELDS_1PHASE;
}

const INSTRUMENT_LABELS = {
  SWZ:   'Pomiar skuteczności ochrony przeciwporażeniowej przez samoczynne wyłączenie zasilania',
  RCD:   'Pomiar wyłączników różnicowoprądowych',
  IZOL:  'Pomiar rezystancji izolacji',
  UZIEM: 'Pomiar rezystancji uziomu'
};

// === HELPERS ===

function generateProtocolNumber() {
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  return `${yyyy}/${mm}/001`;
}

function parseLocalDate(dateStr) {
  if (!dateStr) return null;
  const [yyyy, mm, dd] = dateStr.split('-').map(Number);
  return new Date(yyyy, mm - 1, dd);
}

// === STATE ===

const AppState = {
  sections: [],
  swzFixedRow: {
    circuit: 'Zabezpieczenie główne',
    protType: '',
    protCurrent: null,
    baseType: 'C',
    baseCurrent: 25,
    Ia: null,
    Usk: null,
    tw: '5',
    Zs: null,
    calculated: { Id: null, Zsmax: null, verdict: null }
  },
  attachment1: {
    rowsBySubsection: {}
  },
  attachment2: {
    fixedRow: {
      id: 'izol-fixed',
      name: 'WLZ',
      wireType: '',
      phaseType: '3',
      rp: { L1N: null, L2N: null, L3N: null, L1L2: null, L1L3: null,
            L2L3: null, L1PE: null, L2PE: null, L3PE: null, NPE: null },
      Rw: 1,
      calculated: { verdict: null }
    },
    rowsBySubsection: {}
  },
  attachment3: {
    rows: []
  },
  attachment4: {
    rows: []
  },
  form: {
    protocolNumber: '',
    objectName: '',
    objectAddress: '',
    objectParcel: '',
    executorName: '',
    executorSepE: '',
    executorSepD: '',
    testDate: '',
    testTemp: null,
    instruments: [
      { type: 'SWZ',   name: '', serial: '', calibration: '' },
      { type: 'RCD',   name: '', serial: '', calibration: '' },
      { type: 'IZOL',  name: '', serial: '', calibration: '' },
      { type: 'UZIEM', name: '', serial: '', calibration: '' }
    ]
  }
};

const UIState = { activeTab: 0 };

// === EVENT BUS ===

const EventBus = (() => {
  const listeners = {};
  return {
    on(event, fn) {
      (listeners[event] = listeners[event] || []).push(fn);
    },
    emit(event, data) {
      (listeners[event] || []).forEach(fn => fn(data));
    }
  };
})();

// === CALCULATOR ===

function roundTo3(val) {
  return Math.round(val * 1000) / 1000;
}

function calcSWZRow(row) {
  const Ia = (row.Ia != null) ? row.Ia : getIa(row.baseType, row.baseCurrent);
  if (!Ia || !row.Usk || !row.Zs) return { Id: null, Zsmax: null, verdict: null };
  const Id = roundTo3(row.Usk / row.Zs);
  const Zsmax = roundTo3(row.Usk / Ia);
  const verdict = roundTo3(row.Zs) <= Zsmax ? 'POZYTYWNA' : 'NEGATYWNA';
  return { Id, Zsmax, verdict };
}

function calcIZOLRow(row) {
  const activeFields = getActiveIZOLFields(row.phaseType);
  const allMeasured = activeFields.every(f => row.rp[f] != null);
  if (!allMeasured) return { verdict: null };
  const allPass = activeFields.every(f => roundTo3(row.rp[f]) >= roundTo3(row.Rw));
  return { verdict: allPass ? 'POZYTYWNA' : 'NEGATYWNA' };
}

function calcRCDRow(row) {
  if (row.Iw == null || row.In == null || row.tw == null || row.tz == null) {
    return { verdict: null };
  }
  const pass = roundTo3(row.Iw) <= roundTo3(row.In) && roundTo3(row.tw) <= roundTo3(row.tz);
  return { verdict: pass ? 'POZYTYWNA' : 'NEGATYWNA' };
}

function calcUZIEMRow(row) {
  if (row.Rp == null || row.Wk == null) return { Rpo: null, verdict: null };
  const Rpo = roundTo3(row.Rp * row.Wk);
  const verdict = Rpo <= roundTo3(row.Rw) ? 'POZYTYWNA' : 'NEGATYWNA';
  return { Rpo, verdict };
}

// === OCENA KONCOWA / ORZECZENIE ===

function calcAttachmentVerdict(attachmentKey) {
  const allVerdicts = [];

  if (attachmentKey === 'attachment1') {
    // Fixed row
    const fixedCalc = calcSWZRow(AppState.swzFixedRow);
    if (fixedCalc.verdict) allVerdicts.push(fixedCalc.verdict);
    // Dynamic rows
    for (const section of AppState.sections) {
      for (const sub of section.subsections) {
        const rows = AppState.attachment1.rowsBySubsection[sub.id] || [];
        for (const row of rows) {
          const calc = calcSWZRow(row);
          if (calc.verdict) allVerdicts.push(calc.verdict);
        }
      }
    }
  }

  if (attachmentKey === 'attachment2') {
    // Fixed row
    const fixedCalc = calcIZOLRow(AppState.attachment2.fixedRow);
    if (fixedCalc.verdict) allVerdicts.push(fixedCalc.verdict);
    // Dynamic rows
    for (const section of AppState.sections) {
      for (const sub of section.subsections) {
        const rows = AppState.attachment2.rowsBySubsection[sub.id] || [];
        for (const row of rows) {
          const calc = calcIZOLRow(row);
          if (calc.verdict) allVerdicts.push(calc.verdict);
        }
      }
    }
  }

  if (attachmentKey === 'attachment3') {
    for (const row of AppState.attachment3.rows) {
      const calc = calcRCDRow(row);
      if (calc.verdict) allVerdicts.push(calc.verdict);
    }
  }

  if (attachmentKey === 'attachment4') {
    for (const row of AppState.attachment4.rows) {
      const calc = calcUZIEMRow(row);
      if (calc.verdict) allVerdicts.push(calc.verdict);
    }
  }

  if (allVerdicts.length === 0) return null;
  return allVerdicts.every(v => v === 'POZYTYWNA') ? 'POZYTYWNY' : 'NEGATYWNY';
}

function calcFinalAssessment() {
  return {
    documentation: 'POZYTYWNY',
    inspection: 'POZYTYWNY',
    swz: calcAttachmentVerdict('attachment1'),
    izol: calcAttachmentVerdict('attachment2'),
    rcd: calcAttachmentVerdict('attachment3'),
    uziem: calcAttachmentVerdict('attachment4')
  };
}

function calcNextTestDate(testDateStr) {
  const d = parseLocalDate(testDateStr);
  if (!d) return null;
  d.setFullYear(d.getFullYear() + 5);
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yyyy = d.getFullYear();
  return dd + '.' + mm + '.' + yyyy;
}

function calcOrzeczenie() {
  const assessment = calcFinalAssessment();
  const allPositive = Object.values(assessment).every(v => v === 'POZYTYWNY');
  const nextDate = calcNextTestDate(AppState.form.testDate);
  return { allPositive, nextDate };
}

// === ROW FACTORIES ===

function createNewSWZRow() {
  return {
    id: crypto.randomUUID(),
    circuit: '',
    protType: '',
    protCurrent: null,
    baseType: 'B',
    baseCurrent: 16,
    Ia: null,
    Usk: 230,
    tw: '0.2',
    Zs: null,
    calculated: { Id: null, Zsmax: null, verdict: null }
  };
}

function createNewIZOLRow() {
  return {
    id: crypto.randomUUID(),
    name: '',
    wireType: '',
    phaseType: '1',
    rp: { L1N: null, L2N: null, L3N: null, L1L2: null, L1L3: null,
          L2L3: null, L1PE: null, L2PE: null, L3PE: null, NPE: null },
    Rw: 1,
    calculated: { verdict: null }
  };
}

function createNewRCDRow() {
  return {
    id: crypto.randomUUID(),
    deviceType: '',
    testResult: 'TAK',
    In: null,
    Iw: null,
    tw: null,
    tz: 300,
    calculated: { verdict: null }
  };
}

function createNewUZIEMRow() {
  return {
    id: crypto.randomUUID(),
    deviceName: '',
    Rp: null,
    Wk: null,
    Rw: 10,
    calculated: { Rpo: null, verdict: null }
  };
}

// === LP NUMBERING ===

function getSWZLpNumber(subId, rowId) {
  let counter = 2; // 1 = fixed row
  for (const section of AppState.sections) {
    for (const sub of section.subsections) {
      const rows = AppState.attachment1.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        if (sub.id === subId && row.id === rowId) return counter;
        counter++;
      }
    }
  }
  return counter;
}

function getIZOLLpNumber(subId, rowId) {
  let counter = 2; // 1 = fixed WLZ row
  for (const section of AppState.sections) {
    for (const sub of section.subsections) {
      const rows = AppState.attachment2.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        if (sub.id === subId && row.id === rowId) return counter;
        counter++;
      }
    }
  }
  return counter;
}

// === FORM RENDERER ===

function renderTabs() {
  const tabsContainer = document.getElementById('tabs');
  tabsContainer.querySelectorAll('[data-tab]').forEach(btn => {
    const tabNum = Number(btn.dataset.tab);
    if (tabNum === UIState.activeTab) {
      btn.className = 'px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600';
    } else {
      btn.className = 'px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
    }
  });

  for (let i = 0; i <= 4; i++) {
    const container = document.getElementById('attachment-' + i);
    if (i === UIState.activeTab) {
      container.classList.remove('hidden');
    } else {
      container.classList.add('hidden');
    }
  }
}

function renderBaseCurrentOptions(selectedType, selectedCurrent) {
  const spec = PROTECTION_DB[selectedType];
  if (!spec) return '';
  let opts = '';
  for (const r of spec.ratings) {
    opts += '<option value="' + r + '"' + (r === Number(selectedCurrent) ? ' selected' : '') + '>' + r + '</option>';
  }
  return opts;
}

function renderBaseTypeOptions(selectedType) {
  let opts = '';
  for (const t of ['B', 'C', 'D']) {
    opts += '<option value="' + t + '"' + (t === selectedType ? ' selected' : '') + '>' + t + '</option>';
  }
  return opts;
}

function renderTwOptions(selectedTw) {
  const twValues = ['0.2', '0.4', '5'];
  let opts = '';
  for (const tw of twValues) {
    opts += '<option value="' + tw + '"' + (String(selectedTw) === tw ? ' selected' : '') + '>' + tw + '</option>';
  }
  return opts;
}

function renderSWZRowCells(row, lp, subId, isFixed) {
  const rowIdAttr = isFixed ? 'fixed' : row.id;
  const subIdAttr = subId || '';
  const calc = row.calculated || { Id: null, Zsmax: null, verdict: null };
  const autoIa = getIa(row.baseType, row.baseCurrent);

  const dataAttrs = 'data-row-id="' + rowIdAttr + '"' + (subIdAttr ? ' data-sub-id="' + subIdAttr + '"' : '');
  const inputCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center';
  const selectCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm';

  let html = '';

  // Lp.
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-medium">' + lp + '</td>';

  // Obwod
  if (isFixed) {
    html += '<td class="border border-gray-300 px-2 py-1 font-medium">Zabezpieczenie główne</td>';
  } else {
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="text" data-field="circuit" ' + dataAttrs + ' value="' + escapeHtml(row.circuit || '') + '" class="' + inputCls + '" placeholder="nr obwodu">';
    html += '</td>';
  }

  // Zabezpieczenia dodatkowe - typ
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="text" data-field="protType" ' + dataAttrs + ' value="' + escapeHtml(row.protType || '') + '" class="' + inputCls + '" placeholder="typ">';
  html += '</td>';

  // Zabezpieczenia dodatkowe - prad
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="number" data-field="protCurrent" ' + dataAttrs + ' value="' + (row.protCurrent != null ? row.protCurrent : '') + '" class="' + inputCls + '" placeholder="[A]" step="any">';
  html += '</td>';

  // Zabezpieczenia podstawowe - typ (select B/C/D)
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<select data-field="baseType" ' + dataAttrs + ' class="' + selectCls + '">';
  html += renderBaseTypeOptions(row.baseType);
  html += '</select>';
  html += '</td>';

  // Zabezpieczenia podstawowe - prad (select from PROTECTION_DB ratings)
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<select data-field="baseCurrent" ' + dataAttrs + ' class="' + selectCls + '">';
  html += renderBaseCurrentOptions(row.baseType, row.baseCurrent);
  html += '</select>';
  html += '</td>';

  // Usk
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="number" data-field="Usk" ' + dataAttrs + ' value="' + (row.Usk != null ? row.Usk : '') + '" class="' + inputCls + '" step="0.1" placeholder="[V]">';
  html += '</td>';

  // Ia (editable, placeholder = auto value from DB)
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="number" data-field="Ia" ' + dataAttrs + ' value="' + (row.Ia != null ? row.Ia : '') + '" class="' + inputCls + '" placeholder="' + (autoIa != null ? autoIa : '') + '" step="any">';
  html += '</td>';

  // Id (computed, display only)
  html += '<td class="border border-gray-300 px-2 py-1 text-right text-sm font-mono id-cell" data-row-id="' + rowIdAttr + '">' + (calc.Id != null ? calc.Id.toFixed(2) : '') + '</td>';

  // Zs
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="number" data-field="Zs" ' + dataAttrs + ' value="' + (row.Zs != null ? row.Zs : '') + '" class="' + inputCls + '" step="0.001" placeholder="[&Omega;]">';
  html += '</td>';

  // Zsmax (computed, display only)
  html += '<td class="border border-gray-300 px-2 py-1 text-right text-sm font-mono zsmax-cell" data-row-id="' + rowIdAttr + '">' + (calc.Zsmax != null ? calc.Zsmax.toFixed(2) : '') + '</td>';

  // tw (select 0.2 / 0.4 / 5)
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<select data-field="tw" ' + dataAttrs + ' class="' + selectCls + '">';
  html += renderTwOptions(row.tw);
  html += '</select>';
  html += '</td>';

  // Ocena (verdict)
  const verdictClass = calc.verdict === 'POZYTYWNA' ? 'text-green-700' : calc.verdict === 'NEGATYWNA' ? 'text-red-700' : '';
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-bold verdict-cell ' + verdictClass + '" data-row-id="' + rowIdAttr + '">' + (calc.verdict || '') + '</td>';

  // Action (delete or fixed indicator)
  if (isFixed) {
    html += '<td class="border border-gray-300 px-2 py-1 text-center text-gray-400" title="Wiersz stały - nie można usunąć">-</td>';
  } else {
    html += '<td class="border border-gray-300 px-1 py-1 text-center">';
    html += '<button data-action="remove-row" data-row-id="' + row.id + '" data-sub-id="' + subId + '" data-attachment="1" class="text-red-500 hover:text-red-700 text-xs">Usuń</button>';
    html += '</td>';
  }

  return html;
}

function renderFormTab() {
  const container = document.getElementById('attachment-0');
  const f = AppState.form;
  const inputCls = 'w-full border border-gray-300 rounded px-2 py-1.5 text-sm';
  const labelCls = 'block text-sm font-medium text-gray-700 mb-1';
  let html = '';

  // FORM-01: Numer protokołu
  html += '<div class="bg-white border rounded p-4 mb-4">';
  html += '<h3 class="text-md font-semibold mb-3 text-gray-800">Numer protokołu</h3>';
  html += '<div class="max-w-xs">';
  html += '<label class="' + labelCls + '">Numer</label>';
  html += '<input type="text" data-field="form-protocolNumber" value="' + escapeHtml(f.protocolNumber) + '" class="' + inputCls + '" placeholder="RRRR/MM/NNN">';
  html += '</div>';
  html += '</div>';

  // FORM-02: Obiekt badany
  html += '<div class="bg-white border rounded p-4 mb-4">';
  html += '<h3 class="text-md font-semibold mb-3 text-gray-800">Obiekt badany</h3>';
  html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
  html += '<div>';
  html += '<label class="' + labelCls + '">Nazwa obiektu</label>';
  html += '<input type="text" data-field="form-objectName" value="' + escapeHtml(f.objectName) + '" class="' + inputCls + '" placeholder="np. Budynek mieszkalny">';
  html += '</div>';
  html += '<div>';
  html += '<label class="' + labelCls + '">Adres</label>';
  html += '<input type="text" data-field="form-objectAddress" value="' + escapeHtml(f.objectAddress) + '" class="' + inputCls + '" placeholder="np. ul. Przykładowa 1, 00-000 Warszawa">';
  html += '</div>';
  html += '<div>';
  html += '<label class="' + labelCls + '">Nr działki</label>';
  html += '<input type="text" data-field="form-objectParcel" value="' + escapeHtml(f.objectParcel) + '" class="' + inputCls + '" placeholder="np. 123/4">';
  html += '</div>';
  html += '</div>';
  html += '</div>';

  // FORM-03: Wykonawca
  html += '<div class="bg-white border rounded p-4 mb-4">';
  html += '<h3 class="text-md font-semibold mb-3 text-gray-800">Wykonawca badań</h3>';
  html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
  html += '<div>';
  html += '<label class="' + labelCls + '">Imię i nazwisko</label>';
  html += '<input type="text" data-field="form-executorName" value="' + escapeHtml(f.executorName) + '" class="' + inputCls + '" placeholder="Jan Kowalski">';
  html += '</div>';
  html += '<div>';
  html += '<label class="' + labelCls + '">Nr świadectwa SEP E (eksploatacja)</label>';
  html += '<input type="text" data-field="form-executorSepE" value="' + escapeHtml(f.executorSepE) + '" class="' + inputCls + '" placeholder="np. 12345/2024">';
  html += '</div>';
  html += '<div>';
  html += '<label class="' + labelCls + '">Nr świadectwa SEP D (dozór)</label>';
  html += '<input type="text" data-field="form-executorSepD" value="' + escapeHtml(f.executorSepD) + '" class="' + inputCls + '" placeholder="np. 67890/2024">';
  html += '</div>';
  html += '</div>';
  html += '</div>';

  // FORM-04: Warunki badań
  html += '<div class="bg-white border rounded p-4 mb-4">';
  html += '<h3 class="text-md font-semibold mb-3 text-gray-800">Warunki badań</h3>';
  html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-lg">';
  html += '<div>';
  html += '<label class="' + labelCls + '">Data badania</label>';
  html += '<input type="date" data-field="form-testDate" value="' + escapeHtml(f.testDate) + '" class="' + inputCls + '">';
  html += '</div>';
  html += '<div>';
  html += '<label class="' + labelCls + '">Temperatura otoczenia</label>';
  html += '<div class="flex items-center gap-2">';
  html += '<input type="number" data-field="form-testTemp" value="' + (f.testTemp != null ? f.testTemp : '') + '" step="0.1" class="' + inputCls + '" placeholder="np. 22.5">';
  html += '<span class="text-sm text-gray-500">\u00b0C</span>';
  html += '</div>';
  html += '</div>';
  html += '</div>';
  html += '</div>';

  // FORM-05: Przyrządy pomiarowe
  html += '<div class="bg-white border rounded p-4 mb-4">';
  html += '<h3 class="text-md font-semibold mb-3 text-gray-800">Przyrządy pomiarowe</h3>';
  html += '<div class="overflow-x-auto">';
  html += '<table class="w-full border-collapse text-sm">';
  html += '<thead class="bg-gray-50">';
  html += '<tr>';
  html += '<th class="border border-gray-300 px-3 py-2 text-left font-medium">Wykonane pomiary</th>';
  html += '<th class="border border-gray-300 px-3 py-2 text-left font-medium w-48">Przyrządy pomiarowe</th>';
  html += '<th class="border border-gray-300 px-3 py-2 text-left font-medium w-36">Nr seryjny</th>';
  html += '<th class="border border-gray-300 px-3 py-2 text-left font-medium w-44">Nr świadectwa wzorcowania</th>';
  html += '</tr>';
  html += '</thead>';
  html += '<tbody>';
  for (const instr of f.instruments) {
    html += '<tr>';
    html += '<td class="border border-gray-300 px-3 py-2 text-sm text-gray-700">' + escapeHtml(INSTRUMENT_LABELS[instr.type]) + '</td>';
    html += '<td class="border border-gray-300 px-1 py-1">';
    html += '<input type="text" data-field="form-instr-' + instr.type + '-name" value="' + escapeHtml(instr.name) + '" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="np. MPI-530">';
    html += '</td>';
    html += '<td class="border border-gray-300 px-1 py-1">';
    html += '<input type="text" data-field="form-instr-' + instr.type + '-serial" value="' + escapeHtml(instr.serial) + '" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="nr seryjny">';
    html += '</td>';
    html += '<td class="border border-gray-300 px-1 py-1">';
    html += '<input type="text" data-field="form-instr-' + instr.type + '-calibration" value="' + escapeHtml(instr.calibration) + '" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="nr świadectwa">';
    html += '</td>';
    html += '</tr>';
  }
  html += '</tbody>';
  html += '</table>';
  html += '</div>';
  html += '</div>';

  // FORM-06: Ocena końcowa
  const assessment = calcFinalAssessment();
  html += '<div id="assessment-section" class="bg-white border rounded p-4 mb-4">';
  html += '<h3 class="text-md font-semibold mb-3 text-gray-800">Ocena wykonanych badań odbiorczych</h3>';
  html += '<div class="overflow-x-auto">';
  html += '<table class="w-full border-collapse text-sm">';
  html += '<thead class="bg-gray-50">';
  html += '<tr>';
  html += '<th class="border border-gray-300 px-3 py-2 text-left font-medium">Wykonane badania odbiorcze</th>';
  html += '<th class="border border-gray-300 px-3 py-2 text-center font-medium w-24">Załączniki</th>';
  html += '<th class="border border-gray-300 px-3 py-2 text-center font-medium w-36">Ogólny wynik</th>';
  html += '</tr>';
  html += '</thead>';
  html += '<tbody>';

  // Row 1: Dokumentacja (stały POZYTYWNY)
  html += '<tr>';
  html += '<td class="border border-gray-300 px-3 py-2">Sprawdzenie dokumentacji instalacji</td>';
  html += '<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">\u2014</td>';
  html += '<td class="border border-gray-300 px-3 py-2 text-center font-bold text-green-700">POZYTYWNY</td>';
  html += '</tr>';

  // Row 2: Oględziny (stały POZYTYWNY)
  html += '<tr>';
  html += '<td class="border border-gray-300 px-3 py-2">Ogl\u0119dziny instalacji elektrycznej</td>';
  html += '<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">\u2014</td>';
  html += '<td class="border border-gray-300 px-3 py-2 text-center font-bold text-green-700">POZYTYWNY</td>';
  html += '</tr>';

  // Row 3: SWZ
  const swzClass = assessment.swz === 'POZYTYWNY' ? 'text-green-700' : assessment.swz === 'NEGATYWNY' ? 'text-red-700' : 'text-gray-400';
  html += '<tr>';
  html += '<td class="border border-gray-300 px-3 py-2">Badanie skuteczno\u015bci ochrony przeciwpora\u017ceniowej przez samoczynne wy\u0142\u0105czenie zasilania</td>';
  html += '<td class="border border-gray-300 px-3 py-2 text-center">Za\u0142. 1</td>';
  html += '<td id="assess-swz" class="border border-gray-300 px-3 py-2 text-center font-bold ' + swzClass + '">' + (assessment.swz || '\u2014') + '</td>';
  html += '</tr>';

  // Row 4: Izolacja
  const izolClass = assessment.izol === 'POZYTYWNY' ? 'text-green-700' : assessment.izol === 'NEGATYWNY' ? 'text-red-700' : 'text-gray-400';
  html += '<tr>';
  html += '<td class="border border-gray-300 px-3 py-2">Badanie stanu rezystancji izolacji obwod\u00f3w</td>';
  html += '<td class="border border-gray-300 px-3 py-2 text-center">Za\u0142. 2</td>';
  html += '<td id="assess-izol" class="border border-gray-300 px-3 py-2 text-center font-bold ' + izolClass + '">' + (assessment.izol || '\u2014') + '</td>';
  html += '</tr>';

  // Row 5: RCD
  const rcdClass = assessment.rcd === 'POZYTYWNY' ? 'text-green-700' : assessment.rcd === 'NEGATYWNY' ? 'text-red-700' : 'text-gray-400';
  html += '<tr>';
  html += '<td class="border border-gray-300 px-3 py-2">Badanie skuteczno\u015bci ochrony dodatkowej (RCD)</td>';
  html += '<td class="border border-gray-300 px-3 py-2 text-center">Za\u0142. 3</td>';
  html += '<td id="assess-rcd" class="border border-gray-300 px-3 py-2 text-center font-bold ' + rcdClass + '">' + (assessment.rcd || '\u2014') + '</td>';
  html += '</tr>';

  // Row 6: Uziemienie
  const uziemClass = assessment.uziem === 'POZYTYWNY' ? 'text-green-700' : assessment.uziem === 'NEGATYWNY' ? 'text-red-700' : 'text-gray-400';
  html += '<tr>';
  html += '<td class="border border-gray-300 px-3 py-2">Badanie rezystancji uziemienia</td>';
  html += '<td class="border border-gray-300 px-3 py-2 text-center">Za\u0142. 4</td>';
  html += '<td id="assess-uziem" class="border border-gray-300 px-3 py-2 text-center font-bold ' + uziemClass + '">' + (assessment.uziem || '\u2014') + '</td>';
  html += '</tr>';

  html += '</tbody>';
  html += '</table>';
  html += '</div>';
  html += '</div>';

  // FORM-07: Orzeczenie
  const orz = calcOrzeczenie();
  html += '<div id="orzeczenie-section" class="bg-white border rounded p-4 mb-4">';
  html += '<h3 class="text-md font-semibold mb-3 text-gray-800">Orzeczenie</h3>';

  if (orz.allPositive) {
    html += '<p id="orzeczenie-text" class="text-base font-bold text-green-700 mb-2">Na podstawie wykonanych bada\u0144 odbiorczych orzeka si\u0119, \u017ce instalacja elektryczna <strong>NADAJE SI\u0118</strong> do eksploatacji.</p>';
  } else {
    const hasAnyData = calcFinalAssessment();
    const hasNegative = Object.values(hasAnyData).some(v => v === 'NEGATYWNY');
    if (hasNegative) {
      html += '<p id="orzeczenie-text" class="text-base font-bold text-red-700 mb-2">Na podstawie wykonanych bada\u0144 odbiorczych orzeka si\u0119, \u017ce instalacja elektryczna <strong>NIE NADAJE SI\u0118</strong> do eksploatacji.</p>';
    } else {
      html += '<p id="orzeczenie-text" class="text-base text-gray-400 mb-2">(uzupe\u0142nij dane pomiarowe)</p>';
    }
  }

  if (orz.nextDate) {
    html += '<p id="next-test-date" class="text-sm text-gray-700">Data nast\u0119pnego badania: <strong>' + orz.nextDate + ' r.</strong> lub po dokonaniu zmian.</p>';
  } else {
    html += '<p id="next-test-date" class="text-sm text-gray-400">(uzupe\u0142nij dat\u0119 badania)</p>';
  }

  html += '<div class="mt-8 flex gap-16">';
  html += '<div class="text-center">';
  html += '<div class="border-b border-gray-400 w-48 mb-1"></div>';
  html += '<div class="text-xs text-gray-500">wykonawca</div>';
  html += '</div>';
  html += '<div class="text-center">';
  html += '<div class="border-b border-gray-400 w-48 mb-1"></div>';
  html += '<div class="text-xs text-gray-500">miejscowo\u015b\u0107 i data</div>';
  html += '</div>';
  html += '</div>';
  html += '</div>';

  container.innerHTML = html;
}

function renderAttachment1() {
  const container = document.getElementById('attachment-1');
  let html = '';

  html += '<h2 class="text-lg font-semibold mb-3">Załącznik nr 1 - Skuteczność ochrony przez samoczynne wyłączenie zasilania</h2>';
  html += '<button data-action="add-section" class="mb-3 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Dodaj sekcję</button>';

  html += '<div class="overflow-x-auto">';
  html += '<table class="w-full border-collapse border border-gray-300 text-sm">';

  // 4-row header (as in reference)
  html += '<thead class="bg-gray-50 text-xs text-center">';

  // Row 1: main headers
  html += '<tr>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-10">Lp.</th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 min-w-[120px]">Obwód<br><span class="font-normal text-gray-500">numer gniazda</span></th>';
  html += '<th colspan="4" class="border border-gray-300 px-2 py-1">Zabezpieczenia</th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-16">U<sub>sk</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-16">I<sub>a</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-16">I<sub>d</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-16">Z<sub>s</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-20">Z<sub>s max</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-14">t<sub>w</sub></th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-24">Ocena</th>';
  html += '<th rowspan="4" class="border border-gray-300 px-2 py-1 w-10"></th>';
  html += '</tr>';

  // Row 2: zabezpieczenia sub-headers
  html += '<tr>';
  html += '<th colspan="2" class="border border-gray-300 px-2 py-1">dodatkowe</th>';
  html += '<th colspan="2" class="border border-gray-300 px-2 py-1">podstawowe</th>';
  html += '</tr>';

  // Row 3: typ / prad labels
  html += '<tr>';
  html += '<th class="border border-gray-300 px-1 py-0.5">typ</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">prąd</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">typ</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">prąd I<sub>&Delta;n</sub></th>';
  html += '</tr>';

  // Row 4: units
  html += '<tr class="text-gray-500">';
  html += '<th class="border border-gray-300 px-1 py-0.5">-</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">[A]</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">-</th>';
  html += '<th class="border border-gray-300 px-1 py-0.5">[A]</th>';
  html += '</tr>';

  html += '</thead>';

  html += '<tbody>';

  // Fixed row: Tablica rozdzielcza (Lp.1)
  const fr = AppState.swzFixedRow;
  html += '<tr class="bg-yellow-50" data-row-id="fixed">';
  html += renderSWZRowCells(fr, 1, null, true);
  html += '</tr>';

  // Dynamic sections
  for (const section of AppState.sections) {
    // Section header row
    html += '<tr class="bg-gray-200">';
    html += '<td colspan="12" class="border border-gray-300 px-2 py-1 font-bold">';
    html += '<input type="text" data-field="section-title" data-section-id="' + section.id + '" value="' + escapeHtml(section.title) + '" class="bg-transparent font-bold w-64 outline-none focus:bg-white focus:ring-1 focus:ring-blue-400 rounded px-1">';
    html += '<button data-action="add-subsection" data-section-id="' + section.id + '" class="ml-3 px-2 py-0.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Dodaj podtytuł</button>';
    html += '</td>';
    html += '<td colspan="2" class="border border-gray-300 px-2 py-1 text-right">';
    html += '<button data-action="remove-section" data-section-id="' + section.id + '" class="px-2 py-0.5 bg-red-500 text-white rounded text-xs hover:bg-red-600">Usuń sekcję</button>';
    html += '</td>';
    html += '</tr>';

    for (const sub of section.subsections) {
      // Subsection header row
      html += '<tr class="bg-gray-100">';
      html += '<td colspan="12" class="border border-gray-300 px-2 py-1 italic">';
      html += '<input type="text" data-field="subsection-title" data-section-id="' + section.id + '" data-sub-id="' + sub.id + '" value="' + escapeHtml(sub.title) + '" class="bg-transparent italic w-64 outline-none focus:bg-white focus:ring-1 focus:ring-blue-400 rounded px-1">';
      html += '<button data-action="add-row-swz" data-sub-id="' + sub.id + '" class="ml-3 px-2 py-0.5 bg-green-500 text-white rounded text-xs hover:bg-green-600">Dodaj wiersz</button>';
      html += '</td>';
      html += '<td colspan="2" class="border border-gray-300 px-2 py-1 text-right">';
      html += '<button data-action="remove-subsection" data-section-id="' + section.id + '" data-sub-id="' + sub.id + '" class="px-2 py-0.5 bg-red-400 text-white rounded text-xs hover:bg-red-500">Usuń podtytuł</button>';
      html += '</td>';
      html += '</tr>';

      // Data rows for this subsection
      const rows = AppState.attachment1.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        const lp = getSWZLpNumber(sub.id, row.id);
        html += '<tr data-row-id="' + row.id + '" data-sub-id="' + sub.id + '">';
        html += renderSWZRowCells(row, lp, sub.id, false);
        html += '</tr>';
      }
    }
  }

  html += '</tbody></table>';
  html += '</div>';

  // Legend SWZ-07
  html += '<div class="mt-4 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">';
  html += '<div><strong>I<sub>n</sub></strong> - prąd znamionowy zabezpieczenia [A]</div>';
  html += '<div><strong>I<sub>a</sub></strong> - prąd zapewniający samoczynne wyłączenie zasilania [A]</div>';
  html += '<div><strong>I<sub>d</sub></strong> - prąd obliczeniowy zwarcia jednofazowego [A]</div>';
  html += '<div><strong>t<sub>w</sub></strong> - wymagany czas wyłączenia [s]</div>';
  html += '<div><strong>Z<sub>s</sub></strong> - zmierzona impedancja pętli zwarcia [&Omega;]</div>';
  html += '<div><strong>Z<sub>s max</sub></strong> - dopuszczalna impedancja pętli zwarcia [&Omega;]</div>';
  html += '<div><strong>U<sub>sk</sub></strong> - napięcie znamionowe źródła zasilania [V]</div>';
  html += '</div>';

  container.innerHTML = html;
}

function renderIZOLRowCells(row, lp, subId, isFixed) {
  const rowIdAttr = isFixed ? 'izol-fixed' : row.id;
  const subIdAttr = subId || '';
  const calc = row.calculated || { verdict: null };
  const izolFields = ['L1N','L2N','L3N','L1L2','L1L3','L2L3','L1PE','L2PE','L3PE','NPE'];
  const activeFields = getActiveIZOLFields(row.phaseType);

  const dataAttrs = 'data-row-id="' + rowIdAttr + '"' + (subIdAttr ? ' data-sub-id="' + subIdAttr + '"' : '') + ' data-attachment="2"';
  const inputCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center';

  let html = '';

  // Lp.
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-medium">' + lp + '</td>';

  // Nazwa obwodu
  if (isFixed) {
    html += '<td class="border border-gray-300 px-2 py-1 font-medium">WLZ</td>';
  } else {
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="text" data-field="izol-name" ' + dataAttrs + ' value="' + escapeHtml(row.name || '') + '" class="' + inputCls + '" placeholder="nazwa obwodu">';
    html += '</td>';
  }

  // Typ przewodu
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  html += '<input type="text" data-field="izol-wireType" ' + dataAttrs + ' value="' + escapeHtml(row.wireType || '') + '" class="' + inputCls + '" placeholder="typ przewodu">';
  html += '</td>';

  // Fazy select
  html += '<td class="border border-gray-300 px-1 py-0.5">';
  if (isFixed) {
    html += '<span class="text-sm text-gray-500">3-faz</span>';
  } else {
    html += '<select data-field="izol-phaseType" ' + dataAttrs + ' class="w-full border border-gray-300 rounded px-1 py-0.5 text-sm">';
    html += '<option value="1"' + (row.phaseType === '1' ? ' selected' : '') + '>1-fazowy</option>';
    html += '<option value="3"' + (row.phaseType === '3' ? ' selected' : '') + '>3-fazowy</option>';
    html += '</select>';
  }
  html += '</td>';

  // 10 Rp fields
  for (const field of izolFields) {
    const isActive = activeFields.includes(field);
    const val = row.rp[field] != null ? row.rp[field] : '';
    const disabledAttr = isActive ? '' : ' disabled';
    const disabledCls = isActive ? '' : ' bg-gray-100 text-gray-400 cursor-not-allowed';
    html += '<td class="border border-gray-300 px-0.5 py-0.5">';
    html += '<input type="number" data-field="izol-rp-' + field + '" ' + dataAttrs + ' value="' + val + '" step="0.01" class="w-14 border border-gray-300 rounded px-0.5 py-0.5 text-sm text-center font-mono' + disabledCls + '"' + disabledAttr + '>';
    html += '</td>';
  }

  // Rw (not editable, display "1")
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-mono">' + row.Rw + '</td>';

  // Verdict
  const verdictClass = calc.verdict === 'POZYTYWNA' ? 'text-green-700' : calc.verdict === 'NEGATYWNA' ? 'text-red-700' : '';
  html += '<td class="border border-gray-300 px-2 py-1 text-center font-bold izol-verdict-cell ' + verdictClass + '" data-row-id="' + rowIdAttr + '">' + (calc.verdict || '') + '</td>';

  // Action
  if (isFixed) {
    html += '<td class="border border-gray-300 px-2 py-1 text-center text-gray-400" title="Wiersz stały - nie można usunąć">-</td>';
  } else {
    html += '<td class="border border-gray-300 px-1 py-1 text-center">';
    html += '<button data-action="remove-row" data-row-id="' + row.id + '" data-sub-id="' + subId + '" data-attachment="2" class="text-red-500 hover:text-red-700 text-xs">Usuń</button>';
    html += '</td>';
  }

  return html;
}

function renderAttachment2() {
  const container = document.getElementById('attachment-2');
  let html = '';

  html += '<h2 class="text-lg font-semibold mb-3">Załącznik nr 2 - Rezystancja izolacji</h2>';
  html += '<button data-action="add-section" class="mb-3 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Dodaj sekcję</button>';

  html += '<div class="overflow-x-auto">';
  html += '<table class="min-w-max border-collapse text-sm">';

  // Header Row 1
  html += '<thead class="bg-gray-50 text-xs text-center">';
  html += '<tr>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-10">Lp.</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 min-w-[120px]">Nazwa obwodu</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 min-w-[100px]">Typ przewodu</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-20">Fazy</th>';
  html += '<th colspan="10" class="border border-gray-300 px-2 py-1">R<sub>p</sub> [M&Omega;]</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-14">R<sub>w</sub><br>[M&Omega;]</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-24">Ocena</th>';
  html += '<th rowspan="2" class="border border-gray-300 px-2 py-1 w-10"></th>';
  html += '</tr>';

  // Header Row 2 - Rp sub-columns
  html += '<tr>';
  const izolCols = ['L1-N','L2-N','L3-N','L1-L2','L1-L3','L2-L3','L1-PE','L2-PE','L3-PE','N-PE'];
  for (const col of izolCols) {
    html += '<th class="border border-gray-300 px-1 py-0.5 text-xs font-normal text-gray-600">' + col + '</th>';
  }
  html += '</tr>';
  html += '</thead>';

  html += '<tbody>';

  // Fixed row: WLZ (Lp.1) - always 3-phase
  const ifr = AppState.attachment2.fixedRow;
  ifr.calculated = calcIZOLRow(ifr);
  html += '<tr class="bg-yellow-50" data-row-id="izol-fixed">';
  html += renderIZOLRowCells(ifr, 1, null, true);
  html += '</tr>';

  // Shared sections from AppState.sections (DYN-06)
  for (const section of AppState.sections) {
    // Section header row with editable title and management buttons
    html += '<tr class="bg-gray-200">';
    html += '<td colspan="15" class="border border-gray-300 px-2 py-1 font-bold">';
    html += '<input type="text" data-field="section-title" data-section-id="' + section.id + '" value="' + escapeHtml(section.title) + '" class="bg-transparent font-bold w-64 outline-none focus:bg-white focus:ring-1 focus:ring-blue-400 rounded px-1">';
    html += '<button data-action="add-subsection" data-section-id="' + section.id + '" class="ml-3 px-2 py-0.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">Dodaj podtytuł</button>';
    html += '</td>';
    html += '<td colspan="2" class="border border-gray-300 px-2 py-1 text-right">';
    html += '<button data-action="remove-section" data-section-id="' + section.id + '" class="px-2 py-0.5 bg-red-500 text-white rounded text-xs hover:bg-red-600">Usuń sekcję</button>';
    html += '</td>';
    html += '</tr>';

    for (const sub of section.subsections) {
      // Subsection header row with editable title
      html += '<tr class="bg-gray-100">';
      html += '<td colspan="15" class="border border-gray-300 px-2 py-1 italic">';
      html += '<input type="text" data-field="subsection-title" data-section-id="' + section.id + '" data-sub-id="' + sub.id + '" value="' + escapeHtml(sub.title) + '" class="bg-transparent italic w-64 outline-none focus:bg-white focus:ring-1 focus:ring-blue-400 rounded px-1">';
      html += '<button data-action="add-row-izol" data-sub-id="' + sub.id + '" class="ml-3 px-2 py-0.5 bg-green-500 text-white rounded text-xs hover:bg-green-600 not-italic font-normal">Dodaj wiersz</button>';
      html += '</td>';
      html += '<td colspan="2" class="border border-gray-300 px-2 py-1 text-right">';
      html += '<button data-action="remove-subsection" data-section-id="' + section.id + '" data-sub-id="' + sub.id + '" class="px-2 py-0.5 bg-red-400 text-white rounded text-xs hover:bg-red-500">Usuń podtytuł</button>';
      html += '</td>';
      html += '</tr>';

      // Data rows for this subsection in Zal.2
      const rows = AppState.attachment2.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        const lp = getIZOLLpNumber(sub.id, row.id);
        row.calculated = calcIZOLRow(row);
        html += '<tr data-row-id="' + row.id + '" data-sub-id="' + sub.id + '">';
        html += renderIZOLRowCells(row, lp, sub.id, false);
        html += '</tr>';
      }
    }
  }

  html += '</tbody></table>';
  html += '</div>';

  // Legend IZOL-07
  html += '<div class="mt-4 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">';
  html += '<div><strong>R<sub>p</sub></strong> - Zmierzona wartość rezystancji izolacji [M&Omega;]</div>';
  html += '<div><strong>R<sub>w</sub></strong> - Wymagana wartość rezystancji izolacji [M&Omega;]</div>';
  html += '</div>';

  container.innerHTML = html;
}

function renderAttachment3() {
  const container = document.getElementById('attachment-3');
  const inputCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center';
  const selectCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm';
  let html = '';

  html += '<h2 class="text-lg font-semibold mb-3">Załącznik nr 3 - Badanie wyłączników różnicowoprądowych (RCD)</h2>';

  html += '<div class="overflow-x-auto">';
  html += '<table class="w-full border-collapse text-sm">';

  // Header (1 row)
  html += '<thead>';
  html += '<tr class="bg-gray-50 text-center font-semibold">';
  html += '<th class="border border-gray-300 px-2 py-1 w-10">Lp.</th>';
  html += '<th class="border border-gray-300 px-2 py-1 min-w-[180px]">Typ urządzenia</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-16">TEST</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">I<sub>n</sub> [mA]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">I<sub>w</sub> [mA]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">t<sub>w</sub> [ms]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">t<sub>z</sub> [ms]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-24">Ocena</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-10"></th>';
  html += '</tr>';
  html += '</thead>';

  html += '<tbody>';

  for (let i = 0; i < AppState.attachment3.rows.length; i++) {
    const row = AppState.attachment3.rows[i];
    const lp = i + 1;
    row.calculated = calcRCDRow(row);
    const calc = row.calculated;
    const dataAttrs = 'data-row-id="' + row.id + '" data-attachment="3"';

    html += '<tr data-row-id="' + row.id + '">';

    // Lp.
    html += '<td class="border border-gray-300 px-2 py-1 text-center font-medium">' + lp + '</td>';

    // Typ urzadzenia
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="text" data-field="rcd-deviceType" ' + dataAttrs + ' value="' + escapeHtml(row.deviceType || '') + '" class="' + inputCls + '" placeholder="np. Eaton PF7-25/2/003-A">';
    html += '</td>';

    // TEST (TAK/NIE)
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<select data-field="rcd-testResult" ' + dataAttrs + ' class="' + selectCls + '">';
    html += '<option value="TAK"' + (row.testResult === 'TAK' ? ' selected' : '') + '>TAK</option>';
    html += '<option value="NIE"' + (row.testResult === 'NIE' ? ' selected' : '') + '>NIE</option>';
    html += '</select>';
    html += '</td>';

    // In [mA]
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="rcd-In" ' + dataAttrs + ' value="' + (row.In != null ? row.In : '') + '" step="1" class="' + inputCls + ' font-mono" placeholder="mA">';
    html += '</td>';

    // Iw [mA]
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="rcd-Iw" ' + dataAttrs + ' value="' + (row.Iw != null ? row.Iw : '') + '" step="0.1" class="' + inputCls + ' font-mono" placeholder="mA">';
    html += '</td>';

    // tw [ms]
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="rcd-tw" ' + dataAttrs + ' value="' + (row.tw != null ? row.tw : '') + '" step="1" class="' + inputCls + ' font-mono" placeholder="ms">';
    html += '</td>';

    // tz [ms] (default 300)
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="rcd-tz" ' + dataAttrs + ' value="' + (row.tz != null ? row.tz : '') + '" step="1" class="' + inputCls + ' font-mono" placeholder="ms">';
    html += '</td>';

    // Verdict
    const verdictClass = calc.verdict === 'POZYTYWNA' ? 'text-green-700' : calc.verdict === 'NEGATYWNA' ? 'text-red-700' : '';
    html += '<td class="border border-gray-300 px-2 py-1 text-center font-bold rcd-verdict-cell ' + verdictClass + '" data-row-id="' + row.id + '">' + (calc.verdict || '') + '</td>';

    // Usun
    html += '<td class="border border-gray-300 px-1 py-1 text-center">';
    html += '<button data-action="remove-row" data-row-id="' + row.id + '" data-attachment="3" class="text-red-500 hover:text-red-700 text-xs">Usuń</button>';
    html += '</td>';

    html += '</tr>';
  }

  if (AppState.attachment3.rows.length === 0) {
    html += '<tr><td colspan="9" class="border border-gray-300 px-2 py-4 text-center text-gray-400 italic">Brak wierszy - kliknij "Dodaj wiersz RCD"</td></tr>';
  }

  html += '</tbody></table>';
  html += '</div>';

  // "Dodaj wiersz RCD" button below table
  html += '<button data-action="add-row-rcd" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Dodaj wiersz RCD</button>';

  // Legend RCD-05
  html += '<div class="mt-4 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">';
  html += '<div><strong>I<sub>n</sub></strong> - Znamionowy prąd różnicowy wyłącznika [mA]</div>';
  html += '<div><strong>I<sub>w</sub></strong> - Zmierzony prąd wyłączający [mA]</div>';
  html += '<div><strong>t<sub>w</sub></strong> - Zmierzony czas wyłączenia [ms]</div>';
  html += '<div><strong>t<sub>z</sub></strong> - Dopuszczalny czas wyłączenia [ms]</div>';
  html += '</div>';

  container.innerHTML = html;
}

function renderAttachment4() {
  const container = document.getElementById('attachment-4');
  const inputCls = 'w-full border border-gray-300 rounded px-1 py-0.5 text-sm text-center';
  let html = '';

  html += '<h2 class="text-lg font-semibold mb-3">Załącznik nr 4 - Rezystancja uziemienia</h2>';

  html += '<div class="overflow-x-auto">';
  html += '<table class="w-full border-collapse text-sm">';

  // Header (1 row)
  html += '<thead>';
  html += '<tr class="bg-gray-50 text-center font-semibold">';
  html += '<th class="border border-gray-300 px-2 py-1 w-10">Lp.</th>';
  html += '<th class="border border-gray-300 px-2 py-1 min-w-[180px]">Nazwa urządzenia</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">R<sub>E</sub> [&Omega;]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-16">W<sub>k</sub></th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">R<sub>po</sub> [&Omega;]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-20">R<sub>w</sub> [&Omega;]</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-24">Ocena</th>';
  html += '<th class="border border-gray-300 px-2 py-1 w-10"></th>';
  html += '</tr>';
  html += '</thead>';

  html += '<tbody>';

  for (let i = 0; i < AppState.attachment4.rows.length; i++) {
    const row = AppState.attachment4.rows[i];
    const lp = i + 1;
    row.calculated = calcUZIEMRow(row);
    const calc = row.calculated;
    const dataAttrs = 'data-row-id="' + row.id + '" data-attachment="4"';

    html += '<tr data-row-id="' + row.id + '">';

    // Lp.
    html += '<td class="border border-gray-300 px-2 py-1 text-center font-medium">' + lp + '</td>';

    // Nazwa urzadzenia
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="text" data-field="uziem-deviceName" ' + dataAttrs + ' value="' + escapeHtml(row.deviceName || '') + '" class="' + inputCls + '" placeholder="np. Instalacja odgromowa">';
    html += '</td>';

    // Rp (RE) [Ohm]
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="uziem-Rp" ' + dataAttrs + ' value="' + (row.Rp != null ? row.Rp : '') + '" step="0.01" class="' + inputCls + ' font-mono" placeholder="&Omega;">';
    html += '</td>';

    // Wk
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="uziem-Wk" ' + dataAttrs + ' value="' + (row.Wk != null ? row.Wk : '') + '" step="0.01" class="' + inputCls + ' font-mono" placeholder="Wk">';
    html += '</td>';

    // Rpo (computed, display only)
    html += '<td class="border border-gray-300 px-2 py-1 text-right font-mono uziem-rpo-cell" data-row-id="' + row.id + '">' + (calc.Rpo != null ? calc.Rpo.toFixed(2) : '') + '</td>';

    // Rw [Ohm] (editable, default 10)
    html += '<td class="border border-gray-300 px-1 py-0.5">';
    html += '<input type="number" data-field="uziem-Rw" ' + dataAttrs + ' value="' + (row.Rw != null ? row.Rw : '') + '" step="0.1" class="' + inputCls + ' font-mono" placeholder="&Omega;">';
    html += '</td>';

    // Verdict
    const verdictClass = calc.verdict === 'POZYTYWNA' ? 'text-green-700' : calc.verdict === 'NEGATYWNA' ? 'text-red-700' : '';
    html += '<td class="border border-gray-300 px-2 py-1 text-center font-bold uziem-verdict-cell ' + verdictClass + '" data-row-id="' + row.id + '">' + (calc.verdict || '') + '</td>';

    // Usun
    html += '<td class="border border-gray-300 px-1 py-1 text-center">';
    html += '<button data-action="remove-row" data-row-id="' + row.id + '" data-attachment="4" class="text-red-500 hover:text-red-700 text-xs">Usuń</button>';
    html += '</td>';

    html += '</tr>';
  }

  if (AppState.attachment4.rows.length === 0) {
    html += '<tr><td colspan="8" class="border border-gray-300 px-2 py-4 text-center text-gray-400 italic">Brak wierszy - kliknij "Dodaj wiersz"</td></tr>';
  }

  html += '</tbody></table>';
  html += '</div>';

  // "Dodaj wiersz" button below table (UZIEM-05)
  html += '<button data-action="add-row-uziem" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Dodaj wiersz</button>';

  // Legend UZIEM-06
  html += '<div class="mt-4 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">';
  html += '<div><strong>R<sub>E</sub></strong> - Zmierzona wartość rezystancji uziemienia [&Omega;]</div>';
  html += '<div><strong>W<sub>k</sub></strong> - Współczynnik korekcyjny</div>';
  html += '<div><strong>R<sub>po</sub></strong> - Obliczona wartość rezystancji uziemienia [&Omega;]</div>';
  html += '<div><strong>R<sub>w</sub></strong> - Wymagana wartość rezystancji uziemienia [&Omega;]</div>';
  html += '</div>';

  container.innerHTML = html;
}

// === HELPERS ===

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// === FORM FIELD CHANGE HANDLERS ===

function handleFormFieldChange(field, value) {
  switch (field) {
    case 'form-protocolNumber':
      AppState.form.protocolNumber = value;
      break;
    case 'form-objectName':
      AppState.form.objectName = value;
      break;
    case 'form-objectAddress':
      AppState.form.objectAddress = value;
      break;
    case 'form-objectParcel':
      AppState.form.objectParcel = value;
      break;
    case 'form-executorName':
      AppState.form.executorName = value;
      break;
    case 'form-executorSepE':
      AppState.form.executorSepE = value;
      break;
    case 'form-executorSepD':
      AppState.form.executorSepD = value;
      break;
    case 'form-testDate':
      AppState.form.testDate = value;
      if (typeof updateOrzeczenieDisplay === 'function') {
        updateOrzeczenieDisplay();
      }
      break;
    case 'form-testTemp':
      AppState.form.testTemp = value === '' ? null : parseFloat(value);
      break;
    default:
      // Instrument field pattern: form-instr-{TYPE}-{PROP}
      handleInstrumentFieldChange(field, value);
      break;
  }
}

function handleInstrumentFieldChange(field, value) {
  const match = field.match(/^form-instr-(SWZ|RCD|IZOL|UZIEM)-(name|serial|calibration)$/);
  if (!match) return;
  const type = match[1];
  const prop = match[2];
  const instr = AppState.form.instruments.find(i => i.type === type);
  if (instr) {
    instr[prop] = value;
  }
}

// === FORM CONTROLLER ===

function bindTabEvents() {
  document.getElementById('tabs').addEventListener('click', (e) => {
    const btn = e.target.closest('[data-tab]');
    if (!btn) return;
    UIState.activeTab = Number(btn.dataset.tab);
    renderTabs();
    // Pełny re-render zakladki Protokol przy przełączeniu
    if (UIState.activeTab === 0) {
      renderFormTab();
    }
  });
}

function bindAppEvents() {
  const app = document.getElementById('app');

  // Click delegation
  app.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;

    if (action === 'add-section') {
      const newSection = {
        id: crypto.randomUUID(),
        title: 'Nowa sekcja',
        subsections: []
      };
      AppState.sections.push(newSection);
      EventBus.emit('sections:changed');
    }

    if (action === 'add-subsection') {
      const sectionId = btn.dataset.sectionId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (!section) return;
      const newSub = {
        id: crypto.randomUUID(),
        title: 'Nowy podtytuł'
      };
      section.subsections.push(newSub);
      // Initialize rowsBySubsection for BOTH attachments (Pitfall 5)
      AppState.attachment1.rowsBySubsection[newSub.id] = [];
      AppState.attachment2.rowsBySubsection[newSub.id] = [];
      EventBus.emit('sections:changed');
    }

    if (action === 'add-row-swz') {
      const subId = btn.dataset.subId;
      if (!AppState.attachment1.rowsBySubsection[subId]) {
        AppState.attachment1.rowsBySubsection[subId] = [];
      }
      AppState.attachment1.rowsBySubsection[subId].push(createNewSWZRow());
      EventBus.emit('attachment1:changed');
    }

    if (action === 'add-row-izol') {
      const subId = btn.dataset.subId;
      if (!AppState.attachment2.rowsBySubsection[subId]) {
        AppState.attachment2.rowsBySubsection[subId] = [];
      }
      AppState.attachment2.rowsBySubsection[subId].push(createNewIZOLRow());
      EventBus.emit('attachment2:changed');
    }

    if (action === 'add-row-rcd') {
      AppState.attachment3.rows.push(createNewRCDRow());
      EventBus.emit('attachment3:changed');
    }

    if (action === 'add-row-uziem') {
      AppState.attachment4.rows.push(createNewUZIEMRow());
      EventBus.emit('attachment4:changed');
    }

    if (action === 'remove-section') {
      const sectionId = btn.dataset.sectionId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (!section) return;
      // Remove all rows from both attachments for all subsections
      for (const sub of section.subsections) {
        delete AppState.attachment1.rowsBySubsection[sub.id];
        delete AppState.attachment2.rowsBySubsection[sub.id];
      }
      AppState.sections = AppState.sections.filter(s => s.id !== sectionId);
      EventBus.emit('sections:changed');
    }

    if (action === 'remove-subsection') {
      const sectionId = btn.dataset.sectionId;
      const subId = btn.dataset.subId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (!section) return;
      section.subsections = section.subsections.filter(s => s.id !== subId);
      // Remove rows from both attachments
      delete AppState.attachment1.rowsBySubsection[subId];
      delete AppState.attachment2.rowsBySubsection[subId];
      EventBus.emit('sections:changed');
    }

    if (action === 'remove-row') {
      const rowId = btn.dataset.rowId;
      const subId = btn.dataset.subId;
      const attachment = btn.dataset.attachment;

      if (attachment === '1' && subId) {
        const rows = AppState.attachment1.rowsBySubsection[subId];
        if (rows) {
          AppState.attachment1.rowsBySubsection[subId] = rows.filter(r => r.id !== rowId);
        }
        EventBus.emit('attachment1:changed');
      }

      if (attachment === '2' && subId) {
        const rows = AppState.attachment2.rowsBySubsection[subId];
        if (rows) {
          AppState.attachment2.rowsBySubsection[subId] = rows.filter(r => r.id !== rowId);
        }
        EventBus.emit('attachment2:changed');
      }

      if (attachment === '3') {
        AppState.attachment3.rows = AppState.attachment3.rows.filter(r => r.id !== rowId);
        EventBus.emit('attachment3:changed');
      }

      if (attachment === '4') {
        AppState.attachment4.rows = AppState.attachment4.rows.filter(r => r.id !== rowId);
        EventBus.emit('attachment4:changed');
      }
    }
  });

  // Input delegation (for section/subsection title editing AND SWZ field editing)
  app.addEventListener('input', (e) => {
    const field = e.target.dataset.field;
    if (!field) return;

    // Form field editing (Protokol tab)
    if (field.startsWith('form-')) {
      handleFormFieldChange(field, e.target.value);
      return;
    }

    if (field === 'section-title') {
      const sectionId = e.target.dataset.sectionId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (section) {
        section.title = e.target.value;
        // Re-render the other attachment (not the one being edited)
        if (UIState.activeTab === 1) renderAttachment2();
        else if (UIState.activeTab === 2) renderAttachment1();
      }
      return;
    }

    if (field === 'subsection-title') {
      const sectionId = e.target.dataset.sectionId;
      const subId = e.target.dataset.subId;
      const section = AppState.sections.find(s => s.id === sectionId);
      if (section) {
        const sub = section.subsections.find(s => s.id === subId);
        if (sub) {
          sub.title = e.target.value;
          if (UIState.activeTab === 1) renderAttachment2();
          else if (UIState.activeTab === 2) renderAttachment1();
        }
      }
      return;
    }

    // IZOL field editing
    if (field && field.startsWith('izol-')) {
      handleIZOLFieldChange(e.target);
      return;
    }

    // RCD field editing
    if (field && field.startsWith('rcd-')) {
      handleRCDFieldChange(e.target);
      return;
    }

    // UZIEM field editing
    if (field && field.startsWith('uziem-')) {
      handleUZIEMFieldChange(e.target);
      return;
    }

    // SWZ field editing (input fields: circuit, protType, protCurrent, Usk, Ia, Zs)
    handleSWZFieldChange(e.target);
  });

  // Change delegation (for selects: baseType, baseCurrent, tw, izol-phaseType, rcd-testResult)
  app.addEventListener('change', (e) => {
    const field = e.target.dataset.field;
    if (!field) return;

    // Form field change (date input fires change, not input)
    if (field.startsWith('form-')) {
      handleFormFieldChange(field, e.target.value);
      return;
    }

    // IZOL phaseType select
    if (field === 'izol-phaseType') {
      handleIZOLFieldChange(e.target);
      return;
    }

    // RCD testResult select
    if (field === 'rcd-testResult') {
      handleRCDFieldChange(e.target);
      return;
    }

    // SWZ select fields
    handleSWZFieldChange(e.target);
  });
}

// === SWZ FIELD CHANGE HANDLER ===

const SWZ_FIELDS = new Set(['circuit', 'protType', 'protCurrent', 'baseType', 'baseCurrent', 'Usk', 'Ia', 'Zs', 'tw']);
const SWZ_NUMERIC_FIELDS = new Set(['protCurrent', 'Usk', 'Ia', 'Zs']);

function findSWZRow(rowId, subId) {
  if (rowId === 'fixed') return AppState.swzFixedRow;
  if (!subId) return null;
  const rows = AppState.attachment1.rowsBySubsection[subId];
  if (!rows) return null;
  return rows.find(r => r.id === rowId) || null;
}

function handleSWZFieldChange(el) {
  const field = el.dataset.field;
  if (!field || !SWZ_FIELDS.has(field)) return;

  const rowId = el.dataset.rowId;
  const subId = el.dataset.subId;
  if (!rowId) return;

  const row = findSWZRow(rowId, subId);
  if (!row) return;

  // Normalize and update value in AppState
  if (SWZ_NUMERIC_FIELDS.has(field)) {
    const val = el.value.trim();
    row[field] = val === '' ? null : parseFloat(val);
  } else if (field === 'baseCurrent') {
    row[field] = Number(el.value);
  } else if (field === 'tw') {
    row[field] = el.value;
  } else {
    // String fields: circuit, protType, baseType
    row[field] = el.value;
  }

  // Special: baseType change -> validate baseCurrent, recalculate, re-render
  if (field === 'baseType') {
    const spec = PROTECTION_DB[row.baseType];
    if (spec && !spec.ratings.includes(Number(row.baseCurrent))) {
      row.baseCurrent = 16; // default if current rating not in new type
    }
    // Recalculate before re-render so row.calculated is fresh
    row.calculated = calcSWZRow(row);
    // Re-render to refresh baseCurrent options and Ia placeholder
    // Save/restore focus
    const activeField = document.activeElement?.dataset?.field;
    const activeRowId = document.activeElement?.dataset?.rowId;
    const activeSubId = document.activeElement?.dataset?.subId;
    renderAttachment1();
    updateFinalAssessmentDisplay();
    if (activeField && activeRowId) {
      const selector = '[data-field="' + activeField + '"][data-row-id="' + activeRowId + '"]' +
        (activeSubId ? '[data-sub-id="' + activeSubId + '"]' : '');
      const restored = document.querySelector(selector);
      if (restored) restored.focus();
    }
    return;
  }

  // Special: baseCurrent change -> update Ia placeholder (no need for full re-render)
  if (field === 'baseCurrent') {
    // Update Ia placeholder
    const iaInput = document.querySelector('[data-field="Ia"][data-row-id="' + rowId + '"]' +
      (subId ? '[data-sub-id="' + subId + '"]' : ''));
    if (iaInput) {
      const autoIa = getIa(row.baseType, row.baseCurrent);
      iaInput.placeholder = autoIa != null ? autoIa : '';
    }
  }

  // Recalculate
  const result = calcSWZRow(row);
  row.calculated = result;

  // Update DOM: targeted update of computed cells
  updateSWZComputedCells(rowId, result);
  // Aktualizuj ocenę końcową (no-op jeśli tab 0 nieaktywny)
  updateFinalAssessmentDisplay();
}

function updateSWZComputedCells(rowId, result) {
  // Find cells by data-row-id attribute on the cells themselves
  const idCell = document.querySelector('.id-cell[data-row-id="' + rowId + '"]');
  const zsmaxCell = document.querySelector('.zsmax-cell[data-row-id="' + rowId + '"]');
  const verdictCell = document.querySelector('.verdict-cell[data-row-id="' + rowId + '"]');

  if (idCell) {
    idCell.textContent = result.Id != null ? result.Id.toFixed(2) : '';
  }
  if (zsmaxCell) {
    zsmaxCell.textContent = result.Zsmax != null ? result.Zsmax.toFixed(2) : '';
  }
  if (verdictCell) {
    verdictCell.textContent = result.verdict || '';
    verdictCell.classList.remove('text-green-700', 'text-red-700');
    if (result.verdict === 'POZYTYWNA') verdictCell.classList.add('text-green-700');
    if (result.verdict === 'NEGATYWNA') verdictCell.classList.add('text-red-700');
  }
}

// === IZOL FIELD CHANGE HANDLER ===

const IZOL_RP_FIELDS_MAP = {
  'izol-rp-L1N': 'L1N', 'izol-rp-L2N': 'L2N', 'izol-rp-L3N': 'L3N',
  'izol-rp-L1L2': 'L1L2', 'izol-rp-L1L3': 'L1L3', 'izol-rp-L2L3': 'L2L3',
  'izol-rp-L1PE': 'L1PE', 'izol-rp-L2PE': 'L2PE', 'izol-rp-L3PE': 'L3PE',
  'izol-rp-NPE': 'NPE'
};

function findIZOLRow(rowId, subId) {
  if (rowId === 'izol-fixed') return AppState.attachment2.fixedRow;
  if (!subId) return null;
  const rows = AppState.attachment2.rowsBySubsection[subId];
  if (!rows) return null;
  return rows.find(r => r.id === rowId) || null;
}

function handleIZOLFieldChange(el) {
  const field = el.dataset.field;
  if (!field) return;

  const rowId = el.dataset.rowId;
  const subId = el.dataset.subId;
  if (!rowId) return;

  const row = findIZOLRow(rowId, subId);
  if (!row) return;

  // Handle phaseType change
  if (field === 'izol-phaseType') {
    row.phaseType = el.value;
    // Clear values of inactive fields in AppState
    const activeFields = getActiveIZOLFields(row.phaseType);
    const allFields = IZOL_FIELDS_3PHASE;
    for (const f of allFields) {
      if (!activeFields.includes(f)) {
        row.rp[f] = null;
      }
    }
    row.calculated = calcIZOLRow(row);
    // Re-render to apply phase type visuals (disable/enable fields)
    const savedFocus = document.activeElement;
    renderAttachment2();
    return;
  }

  // Handle Rp field changes
  const rpField = IZOL_RP_FIELDS_MAP[field];
  if (rpField) {
    const val = el.value.trim();
    row.rp[rpField] = val === '' ? null : parseFloat(val);
    row.calculated = calcIZOLRow(row);
    updateIZOLVerdict(rowId, row.calculated);
    updateFinalAssessmentDisplay();
    return;
  }

  // Handle name and wireType
  if (field === 'izol-name') {
    row.name = el.value;
    return;
  }
  if (field === 'izol-wireType') {
    row.wireType = el.value;
    return;
  }
}

function updateIZOLVerdict(rowId, result) {
  const verdictCell = document.querySelector('.izol-verdict-cell[data-row-id="' + rowId + '"]');
  if (verdictCell) {
    verdictCell.textContent = result.verdict || '';
    verdictCell.classList.remove('text-green-700', 'text-red-700');
    if (result.verdict === 'POZYTYWNA') verdictCell.classList.add('text-green-700');
    if (result.verdict === 'NEGATYWNA') verdictCell.classList.add('text-red-700');
  }
}

// === RCD FIELD CHANGE HANDLER ===

const RCD_NUMERIC_FIELDS = { 'rcd-In': 'In', 'rcd-Iw': 'Iw', 'rcd-tw': 'tw', 'rcd-tz': 'tz' };

function findRCDRow(rowId) {
  return AppState.attachment3.rows.find(r => r.id === rowId) || null;
}

function handleRCDFieldChange(el) {
  const field = el.dataset.field;
  if (!field) return;

  const rowId = el.dataset.rowId;
  if (!rowId) return;

  const row = findRCDRow(rowId);
  if (!row) return;

  // Handle numeric fields
  const numericKey = RCD_NUMERIC_FIELDS[field];
  if (numericKey) {
    const val = el.value.trim();
    row[numericKey] = val === '' ? null : parseFloat(val);
    row.calculated = calcRCDRow(row);
    updateRCDVerdict(rowId, row.calculated);
    updateFinalAssessmentDisplay();
    return;
  }

  // Handle deviceType
  if (field === 'rcd-deviceType') {
    row.deviceType = el.value;
    return;
  }

  // Handle testResult (select)
  if (field === 'rcd-testResult') {
    row.testResult = el.value;
    return;
  }
}

function updateRCDVerdict(rowId, result) {
  const verdictCell = document.querySelector('.rcd-verdict-cell[data-row-id="' + rowId + '"]');
  if (verdictCell) {
    verdictCell.textContent = result.verdict || '';
    verdictCell.classList.remove('text-green-700', 'text-red-700');
    if (result.verdict === 'POZYTYWNA') verdictCell.classList.add('text-green-700');
    if (result.verdict === 'NEGATYWNA') verdictCell.classList.add('text-red-700');
  }
}

// === UZIEM FIELD CHANGE HANDLER ===

const UZIEM_NUMERIC_FIELDS = { 'uziem-Rp': 'Rp', 'uziem-Wk': 'Wk', 'uziem-Rw': 'Rw' };

function findUZIEMRow(rowId) {
  return AppState.attachment4.rows.find(r => r.id === rowId) || null;
}

function handleUZIEMFieldChange(el) {
  const field = el.dataset.field;
  if (!field) return;

  const rowId = el.dataset.rowId;
  if (!rowId) return;

  const row = findUZIEMRow(rowId);
  if (!row) return;

  // Handle numeric fields
  const numericKey = UZIEM_NUMERIC_FIELDS[field];
  if (numericKey) {
    const val = el.value.trim();
    row[numericKey] = val === '' ? null : parseFloat(val);
    row.calculated = calcUZIEMRow(row);
    updateUZIEMComputedCells(rowId, row.calculated);
    updateFinalAssessmentDisplay();
    return;
  }

  // Handle deviceName
  if (field === 'uziem-deviceName') {
    row.deviceName = el.value;
    return;
  }
}

function updateUZIEMComputedCells(rowId, result) {
  // Update Rpo cell
  const rpoCell = document.querySelector('.uziem-rpo-cell[data-row-id="' + rowId + '"]');
  if (rpoCell) {
    rpoCell.textContent = result.Rpo != null ? result.Rpo.toFixed(2) : '';
  }

  // Update verdict cell
  const verdictCell = document.querySelector('.uziem-verdict-cell[data-row-id="' + rowId + '"]');
  if (verdictCell) {
    verdictCell.textContent = result.verdict || '';
    verdictCell.classList.remove('text-green-700', 'text-red-700');
    if (result.verdict === 'POZYTYWNA') verdictCell.classList.add('text-green-700');
    if (result.verdict === 'NEGATYWNA') verdictCell.classList.add('text-red-700');
  }
}

// === TARGETED DOM UPDATE: OCENA KONCOWA / ORZECZENIE ===

function updateAssessmentCell(id, verdict) {
  const cell = document.getElementById(id);
  if (!cell) return;
  cell.textContent = verdict || '\u2014';
  cell.classList.remove('text-green-700', 'text-red-700', 'text-gray-400');
  if (verdict === 'POZYTYWNY') {
    cell.classList.add('text-green-700');
  } else if (verdict === 'NEGATYWNY') {
    cell.classList.add('text-red-700');
  } else {
    cell.classList.add('text-gray-400');
  }
}

function updateFinalAssessmentDisplay() {
  if (!document.getElementById('assess-swz')) return;
  const assessment = calcFinalAssessment();
  updateAssessmentCell('assess-swz', assessment.swz);
  updateAssessmentCell('assess-izol', assessment.izol);
  updateAssessmentCell('assess-rcd', assessment.rcd);
  updateAssessmentCell('assess-uziem', assessment.uziem);
  updateOrzeczenieDisplay();
}

function updateOrzeczenieDisplay() {
  const orzText = document.getElementById('orzeczenie-text');
  const nextDateEl = document.getElementById('next-test-date');
  if (!orzText || !nextDateEl) return;

  const orz = calcOrzeczenie();

  if (orz.allPositive) {
    orzText.innerHTML = 'Na podstawie wykonanych bada\u0144 odbiorczych orzeka si\u0119, \u017ce instalacja elektryczna <strong>NADAJE SI\u0118</strong> do eksploatacji.';
    orzText.className = 'text-base font-bold text-green-700 mb-2';
  } else {
    const assessment = calcFinalAssessment();
    const hasNegative = Object.values(assessment).some(v => v === 'NEGATYWNY');
    if (hasNegative) {
      orzText.innerHTML = 'Na podstawie wykonanych bada\u0144 odbiorczych orzeka si\u0119, \u017ce instalacja elektryczna <strong>NIE NADAJE SI\u0118</strong> do eksploatacji.';
      orzText.className = 'text-base font-bold text-red-700 mb-2';
    } else {
      orzText.textContent = '(uzupe\u0142nij dane pomiarowe)';
      orzText.className = 'text-base text-gray-400 mb-2';
    }
  }

  if (orz.nextDate) {
    nextDateEl.innerHTML = 'Data nast\u0119pnego badania: <strong>' + orz.nextDate + ' r.</strong> lub po dokonaniu zmian.';
    nextDateEl.className = 'text-sm text-gray-700';
  } else {
    nextDateEl.textContent = '(uzupe\u0142nij dat\u0119 badania)';
    nextDateEl.className = 'text-sm text-gray-400';
  }
}

// === PERSISTENCE ===

const STORAGE_KEY = 'voltprotokol-state';

function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm z-50';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 2500);
}

function recalculateAll() {
  AppState.swzFixedRow.calculated = calcSWZRow(AppState.swzFixedRow);
  for (const section of AppState.sections) {
    for (const sub of section.subsections) {
      const swzRows = AppState.attachment1.rowsBySubsection[sub.id] || [];
      for (const row of swzRows) {
        row.calculated = calcSWZRow(row);
      }
      const izolRows = AppState.attachment2.rowsBySubsection[sub.id] || [];
      for (const row of izolRows) {
        row.calculated = calcIZOLRow(row);
      }
    }
  }
  AppState.attachment2.fixedRow.calculated = calcIZOLRow(AppState.attachment2.fixedRow);
  AppState.attachment3.rows.forEach(row => { row.calculated = calcRCDRow(row); });
  AppState.attachment4.rows.forEach(row => { row.calculated = calcUZIEMRow(row); });
}

function restoreAppState(saved) {
  const deep = JSON.parse(JSON.stringify(saved));
  Object.keys(deep).forEach(k => { AppState[k] = deep[k]; });
  Object.keys(AppState).forEach(k => { if (!(k in deep)) delete AppState[k]; });
  recalculateAll();
  renderFormTab();
  renderAttachment1();
  renderAttachment2();
  renderAttachment3();
  renderAttachment4();
  updateFinalAssessmentDisplay();
}

function saveToLocalStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(AppState));
    showToast('Dane zapisane.');
  } catch (e) {
    if (e.name === 'QuotaExceededError') {
      showToast('Błąd: brak miejsca w przeglądarce.');
    } else {
      showToast('Błąd zapisu: ' + e.message);
    }
  }
}

function loadFromLocalStorage() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) { showToast('Brak zapisanych danych.'); return; }
  try {
    const saved = JSON.parse(raw);
    restoreAppState(saved);
    showToast('Dane wczytane.');
  } catch (e) {
    showToast('Błąd: uszkodzone dane w localStorage.');
  }
}

function exportToJSON() {
  const json = JSON.stringify(AppState, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const filename = 'voltprotokol-' + (AppState.form.protocolNumber || 'draft').replace(/\//g, '-') + '.json';
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importFromJSON() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,application/json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const saved = JSON.parse(ev.target.result);
        restoreAppState(saved);
        showToast('Wczytano z pliku.');
      } catch (err) {
        showToast('Błąd: nieprawidłowy plik JSON.');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// === WORD EXPORTER ===

function wordEsc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function buildWordHTML() {
  const f = AppState.form;
  const orz = calcOrzeczenie();
  const assessment = calcFinalAssessment();

  let testDateFormatted = '';
  if (f.testDate) {
    const pd = parseLocalDate(f.testDate);
    if (pd) {
      testDateFormatted = String(pd.getDate()).padStart(2,'0') + '.' + String(pd.getMonth()+1).padStart(2,'0') + '.' + pd.getFullYear();
    }
  }

  let html = '';
  html += '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">\n';
  html += '<head><meta charset="utf-8">\n';
  html += '<!--[if gte mso 9]><xml><w:WordDocument><w:View>Print</w:View></w:WordDocument></xml><![endif]-->\n';
  html += '<style>\n';
  html += '@page Section1 { size: 210mm 297mm; margin: 2cm 2cm 2cm 2cm; }\n';
  html += '@page Section2 { size: 297mm 210mm; mso-page-orientation: landscape; margin: 1.5cm 1.5cm 1.5cm 1.5cm; }\n';
  html += '@page Section3 { size: 210mm 297mm; margin: 2cm 2cm 2cm 2cm; }\n';
  html += 'div.Section1 { page: Section1; }\n';
  html += 'div.Section2 { page: Section2; }\n';
  html += 'div.Section3 { page: Section3; }\n';
  html += 'body { font-family: "Times New Roman", serif; font-size: 10pt; }\n';
  html += 'table { border-collapse: collapse; width: 100%; }\n';
  html += 'td, th { border: 1px solid black; padding: 2pt 4pt; font-size: 9pt; vertical-align: middle; }\n';
  html += 'th { background-color: #f0f0f0; font-weight: bold; text-align: center; }\n';
  html += '.title { font-size: 13pt; font-weight: bold; text-align: center; margin-bottom: 12pt; }\n';
  html += '.att-title { font-size: 11pt; font-weight: bold; margin-bottom: 3pt; }\n';
  html += '.att-subtitle { font-size: 9pt; font-weight: bold; text-align: center; margin-bottom: 8pt; }\n';
  html += '.section-hdr td { background-color: #d1d5db; font-weight: bold; }\n';
  html += '.subsection-hdr td { background-color: #f3f4f6; font-style: italic; }\n';
  html += '.pos { color: green; font-weight: bold; }\n';
  html += '.neg { color: red; font-weight: bold; }\n';
  html += '.c { text-align: center; }\n';
  html += '.nb { border: none; }\n';
  html += '</style>\n';
  html += '</head>\n<body>\n';

  // Embedded data for round-trip import (base64 encoded for safety)
  html += '<!-- VOLTPROTOCOL_DATA:' + btoa(unescape(encodeURIComponent(JSON.stringify(AppState)))) + ' -->\n';

  // === SECTION 1: Main protocol + Attachment 1 ===
  html += '<div class="Section1">\n';

  // Main protocol title
  html += '<p class="title">PROTOK\u00d3\u0141 KONTROLNO-POMIAROWY NR ' + wordEsc(f.protocolNumber) + '</p>\n';

  // 1. Obiekt badany
  html += '<p><b>1. Obiekt badany:</b></p>\n';
  html += '<p>' + wordEsc(f.objectName || '') + (f.objectParcel ? ', dz. ' + wordEsc(f.objectParcel) : '') + (f.objectAddress ? ', ' + wordEsc(f.objectAddress) : '') + '</p>\n';

  // 2. Wykonawca
  html += '<p><b>2. Wykonawca:</b></p>\n';
  let execText = 'Protok\u00f3\u0142 oraz badania wykona\u0142 oraz zatwierdzi\u0142 ' + wordEsc(f.executorName || '') + '.';
  if (f.executorSepE || f.executorSepD) {
    execText += ' \u015awiadectwa Kwalifikacyjne SEP';
    if (f.executorSepE) execText += ' na stanowisku eksploatacji nr ' + wordEsc(f.executorSepE);
    if (f.executorSepD) execText += ' oraz na stanowisku dozoru ' + wordEsc(f.executorSepD);
    execText += '.';
  }
  html += '<p>' + execText + '</p>\n';

  // 3. Warunki badan
  html += '<p><b>3. Warunki bada\u0144:</b></p>\n';
  html += '<p style="margin-left:20pt">1. Badania wykonano w dniu ' + wordEsc(testDateFormatted) + '</p>\n';
  html += '<p style="margin-left:20pt">2. Temperatura otoczenia w dniu bada\u0144: ' + (f.testTemp != null ? f.testTemp : '') + '\u00b0C.</p>\n';
  html += '<p style="margin-left:20pt">3. Przyrz\u0105dy pomiarowe</p>\n';

  // Instruments table
  html += '<table>\n';
  html += '<tr><th>Wykonane pomiary</th><th>Przyrz\u0105dy pomiarowe</th><th>Nr \u015bwiadectwa wzorcowania</th></tr>\n';
  for (const instr of f.instruments) {
    html += '<tr>';
    html += '<td>' + wordEsc(INSTRUMENT_LABELS[instr.type]) + '</td>';
    html += '<td>' + wordEsc(instr.name || '') + (instr.serial ? ' nr ' + wordEsc(instr.serial) : '') + '</td>';
    html += '<td>' + wordEsc(instr.calibration || '') + '</td>';
    html += '</tr>\n';
  }
  html += '</table>\n';

  // 4. Ocena
  html += '<p><b>4. Ocena wykonanych bada\u0144 odbiorczych:</b></p>\n';
  html += '<table>\n';
  html += '<tr><th>Wykonane badania odbiorcze</th><th style="width:60pt">Za\u0142\u0105czniki</th><th style="width:80pt">Og\u00f3lny wynik</th></tr>\n';

  const assessRows = [
    ['Sprawdzenie dokumentacji instalacji', '\u2014', 'POZYTYWNY'],
    ['Ogl\u0119dziny instalacji elektrycznej', '\u2014', 'POZYTYWNY'],
    ['Badanie skuteczno\u015bci ochrony przeciwpora\u017ceniowej przez samoczynne wy\u0142\u0105czenie zasilania', 'Za\u0142. 1', assessment.swz],
    ['Badanie stanu rezystancji izolacji obwod\u00f3w', 'Za\u0142. 2', assessment.izol],
    ['Badanie skuteczno\u015bci ochrony dodatkowej (RCD)', 'Za\u0142. 3', assessment.rcd],
    ['Badanie rezystancji uziemienia', 'Za\u0142. 4', assessment.uziem]
  ];
  for (const [label, att, verdict] of assessRows) {
    const cls = verdict === 'POZYTYWNY' ? 'pos' : verdict === 'NEGATYWNY' ? 'neg' : '';
    html += '<tr><td>' + label + '</td><td class="c">' + att + '</td><td class="c ' + cls + '">' + (verdict || '\u2014') + '</td></tr>\n';
  }
  html += '</table>\n';

  // 5. Orzeczenie
  html += '<p><b>5. Orzeczenie:</b></p>\n';
  if (orz.allPositive) {
    html += '<p><b>Na podstawie wykonanych bada\u0144 odbiorczych orzeka si\u0119, \u017ce instalacja elektryczna NADAJE SI\u0118 do eksploatacji.</b></p>\n';
  } else {
    const hasNeg = Object.values(assessment).some(v => v === 'NEGATYWNY');
    if (hasNeg) {
      html += '<p style="color:red"><b>Na podstawie wykonanych bada\u0144 odbiorczych orzeka si\u0119, \u017ce instalacja elektryczna NIE NADAJE SI\u0118 do eksploatacji.</b></p>\n';
    } else {
      html += '<p style="color:gray"><i>(uzupe\u0142nij dane pomiarowe)</i></p>\n';
    }
  }
  if (orz.nextDate) {
    html += '<p>Data nast\u0119pnego badania: <b>' + orz.nextDate + ' r.</b> lub po dokonaniu zmian.</p>\n';
  }

  // Signatures
  html += '<br><br>\n';
  html += '<table style="border:none;width:70%">\n';
  html += '<tr><td class="nb" style="width:45%;border-top:1px solid black;text-align:center;font-size:8pt">wykonawca</td>';
  html += '<td class="nb" style="width:10%"></td>';
  html += '<td class="nb" style="width:45%;border-top:1px solid black;text-align:center;font-size:8pt">miejscowo\u015b\u0107 i data</td></tr>\n';
  html += '</table>\n';

  // === ATTACHMENT 1: SWZ ===
  html += '<br clear="all" style="page-break-before:always">\n';
  html += '<p class="att-title">ZA\u0141\u0104CZNIK NR 1 DO PROTOKO\u0141U KONTROLNO-POMIAROWEGO NR ' + wordEsc(f.protocolNumber) + '</p>\n';
  html += '<p class="att-subtitle">SKUTECZNO\u015a\u0106 OCHRONY PODSTAWOWEJ ORAZ DODATKOWEJ PRZECIWPORA\u017bENIOWEJ PRZEZ SAMOCZYNNE WY\u0141\u0104CZENIE ZASILANIA</p>\n';

  html += '<table>\n';
  // 4-row header
  html += '<tr>';
  html += '<th rowspan="4" style="width:20pt">Lp.</th>';
  html += '<th rowspan="4">Obw\u00f3d<br><span style="font-weight:normal;color:gray">numer gniazda</span></th>';
  html += '<th colspan="4">Zabezpieczenia</th>';
  html += '<th rowspan="4" style="width:30pt">U<sub>sk</sub><br>[V]</th>';
  html += '<th rowspan="4" style="width:30pt">I<sub>a</sub><br>[A]</th>';
  html += '<th rowspan="4" style="width:30pt">I<sub>d</sub><br>[A]</th>';
  html += '<th rowspan="4" style="width:30pt">Z<sub>s</sub><br>[\u03a9]</th>';
  html += '<th rowspan="4" style="width:35pt">Z<sub>s max</sub><br>[\u03a9]</th>';
  html += '<th rowspan="4" style="width:25pt">t<sub>w</sub><br>[s]</th>';
  html += '<th rowspan="4" style="width:55pt">Ocena</th>';
  html += '</tr>\n';
  html += '<tr><th colspan="2">dodatkowe</th><th colspan="2">podstawowe</th></tr>\n';
  html += '<tr><th>typ</th><th>pr\u0105d</th><th>typ</th><th>pr\u0105d I<sub>\u0394n</sub></th></tr>\n';
  html += '<tr><th style="color:gray">-</th><th style="color:gray">[A]</th><th style="color:gray">-</th><th style="color:gray">[A]</th></tr>\n';

  // Fixed row
  const wfr = AppState.swzFixedRow;
  const wfrCalc = calcSWZRow(wfr);
  const wfrIa = wfr.Ia != null ? wfr.Ia : getIa(wfr.baseType, wfr.baseCurrent);
  html += '<tr style="background:#fefce8">';
  html += '<td class="c">1</td>';
  html += '<td><b>Zabezpieczenie g\u0142\u00f3wne</b></td>';
  html += '<td class="c">' + wordEsc(wfr.protType) + '</td>';
  html += '<td class="c">' + (wfr.protCurrent != null ? wfr.protCurrent : '') + '</td>';
  html += '<td class="c">' + wordEsc(wfr.baseType) + '</td>';
  html += '<td class="c">' + wfr.baseCurrent + '</td>';
  html += '<td class="c">' + (wfr.Usk != null ? wfr.Usk : '') + '</td>';
  html += '<td class="c">' + (wfrIa != null ? wfrIa : '') + '</td>';
  html += '<td class="c">' + (wfrCalc.Id != null ? wfrCalc.Id.toFixed(2) : '') + '</td>';
  html += '<td class="c">' + (wfr.Zs != null ? wfr.Zs : '') + '</td>';
  html += '<td class="c">' + (wfrCalc.Zsmax != null ? wfrCalc.Zsmax.toFixed(2) : '') + '</td>';
  html += '<td class="c">' + wordEsc(wfr.tw) + '</td>';
  html += '<td class="c ' + (wfrCalc.verdict === 'POZYTYWNA' ? 'pos' : wfrCalc.verdict === 'NEGATYWNA' ? 'neg' : '') + '">' + (wfrCalc.verdict || '') + '</td>';
  html += '</tr>\n';

  // Dynamic sections
  let wLp = 2;
  for (const section of AppState.sections) {
    html += '<tr class="section-hdr"><td colspan="13">' + wordEsc(section.title) + '</td></tr>\n';
    for (const sub of section.subsections) {
      html += '<tr class="subsection-hdr"><td colspan="13">' + wordEsc(sub.title) + '</td></tr>\n';
      const rows = AppState.attachment1.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        const calc = calcSWZRow(row);
        const rowIa = row.Ia != null ? row.Ia : getIa(row.baseType, row.baseCurrent);
        const vCls = calc.verdict === 'POZYTYWNA' ? 'pos' : calc.verdict === 'NEGATYWNA' ? 'neg' : '';
        html += '<tr>';
        html += '<td class="c">' + wLp + '</td>';
        html += '<td>' + wordEsc(row.circuit) + '</td>';
        html += '<td class="c">' + wordEsc(row.protType) + '</td>';
        html += '<td class="c">' + (row.protCurrent != null ? row.protCurrent : '') + '</td>';
        html += '<td class="c">' + wordEsc(row.baseType) + '</td>';
        html += '<td class="c">' + row.baseCurrent + '</td>';
        html += '<td class="c">' + (row.Usk != null ? row.Usk : '') + '</td>';
        html += '<td class="c">' + (rowIa != null ? rowIa : '') + '</td>';
        html += '<td class="c">' + (calc.Id != null ? calc.Id.toFixed(2) : '') + '</td>';
        html += '<td class="c">' + (row.Zs != null ? row.Zs : '') + '</td>';
        html += '<td class="c">' + (calc.Zsmax != null ? calc.Zsmax.toFixed(2) : '') + '</td>';
        html += '<td class="c">' + wordEsc(row.tw) + '</td>';
        html += '<td class="c ' + vCls + '">' + (calc.verdict || '') + '</td>';
        html += '</tr>\n';
        wLp++;
      }
    }
  }
  html += '</table>\n';
  html += '</div>\n';

  // === SECTION 2: Attachment 2 (landscape) ===
  html += '<div class="Section2">\n';
  html += '<p class="att-title">ZA\u0141\u0104CZNIK NR 2 DO PROTOKO\u0141U KONTROLNO-POMIAROWEGO NR ' + wordEsc(f.protocolNumber) + '</p>\n';
  html += '<p class="att-subtitle">REZYSTANCJA IZOLACJI</p>\n';

  const wRpCols = ['L1-N','L2-N','L3-N','L1-L2','L1-L3','L2-L3','L1-PE','L2-PE','L3-PE','N-PE'];
  const wRpKeys = ['L1N','L2N','L3N','L1L2','L1L3','L2L3','L1PE','L2PE','L3PE','NPE'];

  html += '<table>\n';
  html += '<tr>';
  html += '<th rowspan="2" style="width:20pt">Lp.</th>';
  html += '<th rowspan="2">Nazwa obwodu</th>';
  html += '<th rowspan="2" style="width:60pt">Typ przewodu</th>';
  html += '<th colspan="10">R<sub>p</sub> [M\u03a9]</th>';
  html += '<th rowspan="2" style="width:25pt">R<sub>w</sub><br>[M\u03a9]</th>';
  html += '<th rowspan="2" style="width:50pt">Ocena</th>';
  html += '</tr>\n';
  html += '<tr>';
  for (const col of wRpCols) {
    html += '<th style="font-size:7pt;font-weight:normal;color:#555;width:35pt">' + col + '</th>';
  }
  html += '</tr>\n';

  // Fixed row (WLZ)
  const wifr = AppState.attachment2.fixedRow;
  const wifrCalc = calcIZOLRow(wifr);
  const wifrActive = getActiveIZOLFields(wifr.phaseType);
  html += '<tr style="background:#fefce8">';
  html += '<td class="c">1</td>';
  html += '<td><b>WLZ</b></td>';
  html += '<td class="c">' + wordEsc(wifr.wireType) + '</td>';
  for (const key of wRpKeys) {
    if (wifrActive.includes(key)) {
      html += '<td class="c">' + (wifr.rp[key] != null ? wifr.rp[key] : '') + '</td>';
    } else {
      html += '<td class="c" style="background:#f0f0f0">-</td>';
    }
  }
  html += '<td class="c">' + wifr.Rw + '</td>';
  html += '<td class="c ' + (wifrCalc.verdict === 'POZYTYWNA' ? 'pos' : wifrCalc.verdict === 'NEGATYWNA' ? 'neg' : '') + '">' + (wifrCalc.verdict || '') + '</td>';
  html += '</tr>\n';

  // Dynamic sections
  let wLp2 = 2;
  for (const section of AppState.sections) {
    html += '<tr class="section-hdr"><td colspan="15">' + wordEsc(section.title) + '</td></tr>\n';
    for (const sub of section.subsections) {
      html += '<tr class="subsection-hdr"><td colspan="15">' + wordEsc(sub.title) + '</td></tr>\n';
      const rows = AppState.attachment2.rowsBySubsection[sub.id] || [];
      for (const row of rows) {
        const calc = calcIZOLRow(row);
        const activeFields = getActiveIZOLFields(row.phaseType);
        const vCls = calc.verdict === 'POZYTYWNA' ? 'pos' : calc.verdict === 'NEGATYWNA' ? 'neg' : '';
        html += '<tr>';
        html += '<td class="c">' + wLp2 + '</td>';
        html += '<td>' + wordEsc(row.name) + '</td>';
        html += '<td class="c">' + wordEsc(row.wireType) + '</td>';
        for (const key of wRpKeys) {
          if (activeFields.includes(key)) {
            html += '<td class="c">' + (row.rp[key] != null ? row.rp[key] : '') + '</td>';
          } else {
            html += '<td class="c" style="background:#f0f0f0">-</td>';
          }
        }
        html += '<td class="c">' + row.Rw + '</td>';
        html += '<td class="c ' + vCls + '">' + (calc.verdict || '') + '</td>';
        html += '</tr>\n';
        wLp2++;
      }
    }
  }
  html += '</table>\n';
  html += '</div>\n';

  // === SECTION 3: Attachments 3 & 4 (portrait) ===
  html += '<div class="Section3">\n';

  // Attachment 3: RCD
  html += '<p class="att-title">ZA\u0141\u0104CZNIK NR 3 DO PROTOKO\u0141U KONTROLNO-POMIAROWEGO NR ' + wordEsc(f.protocolNumber) + '</p>\n';
  html += '<p class="att-subtitle">BADANIE WY\u0141\u0104CZNIK\u00d3W R\u00d3\u017bNICOWOPR\u0104DOWYCH (RCD)</p>\n';

  html += '<table>\n';
  html += '<tr><th style="width:25pt">Lp.</th><th>Typ wy\u0142\u0105cznika</th><th style="width:60pt">TEST<br>TAK/NIE</th>';
  html += '<th style="width:40pt">I<sub>n</sub><br>[mA]</th><th style="width:40pt">I<sub>w</sub><br>[mA]</th>';
  html += '<th style="width:40pt">t<sub>w</sub><br>[ms]</th><th style="width:40pt">t<sub>z</sub><br>[ms]</th>';
  html += '<th style="width:55pt">Ocena</th></tr>\n';

  if (AppState.attachment3.rows.length === 0) {
    html += '<tr><td colspan="8" class="c" style="color:gray"><i>Brak danych</i></td></tr>\n';
  }
  for (let i = 0; i < AppState.attachment3.rows.length; i++) {
    const row = AppState.attachment3.rows[i];
    const calc = calcRCDRow(row);
    const vCls = calc.verdict === 'POZYTYWNA' ? 'pos' : calc.verdict === 'NEGATYWNA' ? 'neg' : '';
    html += '<tr>';
    html += '<td class="c">' + (i+1) + '</td>';
    html += '<td>' + wordEsc(row.deviceType) + '</td>';
    html += '<td class="c">' + wordEsc(row.testResult) + '</td>';
    html += '<td class="c">' + (row.In != null ? row.In : '') + '</td>';
    html += '<td class="c">' + (row.Iw != null ? row.Iw : '') + '</td>';
    html += '<td class="c">' + (row.tw != null ? row.tw : '') + '</td>';
    html += '<td class="c">' + (row.tz != null ? row.tz : '') + '</td>';
    html += '<td class="c ' + vCls + '">' + (calc.verdict || '') + '</td>';
    html += '</tr>\n';
  }
  html += '</table>\n';

  // Page break before Att.4
  html += '<br clear="all" style="page-break-before:always">\n';

  // Attachment 4: Earthing
  html += '<p class="att-title">ZA\u0141\u0104CZNIK NR 4 DO PROTOKO\u0141U KONTROLNO-POMIAROWEGO NR ' + wordEsc(f.protocolNumber) + '</p>\n';
  html += '<p class="att-subtitle">REZYSTANCJA UZIEMIENIA</p>\n';

  html += '<table>\n';
  html += '<tr><th style="width:25pt">Lp.</th><th>Nazwa</th>';
  html += '<th style="width:50pt">R<sub>E</sub><br>[\u03a9]</th><th style="width:50pt">W<sub>k</sub></th>';
  html += '<th style="width:50pt">R<sub>po</sub><br>[\u03a9]</th><th style="width:50pt">R<sub>w</sub><br>[\u03a9]</th>';
  html += '<th style="width:55pt">Ocena</th></tr>\n';

  if (AppState.attachment4.rows.length === 0) {
    html += '<tr><td colspan="7" class="c" style="color:gray"><i>Brak danych</i></td></tr>\n';
  }
  for (let i = 0; i < AppState.attachment4.rows.length; i++) {
    const row = AppState.attachment4.rows[i];
    const calc = calcUZIEMRow(row);
    const vCls = calc.verdict === 'POZYTYWNA' ? 'pos' : calc.verdict === 'NEGATYWNA' ? 'neg' : '';
    html += '<tr>';
    html += '<td class="c">' + (i+1) + '</td>';
    html += '<td>' + wordEsc(row.deviceName) + '</td>';
    html += '<td class="c">' + (row.Rp != null ? row.Rp : '') + '</td>';
    html += '<td class="c">' + (row.Wk != null ? row.Wk : '') + '</td>';
    html += '<td class="c">' + (calc.Rpo != null ? calc.Rpo.toFixed(2) : '') + '</td>';
    html += '<td class="c">' + (row.Rw != null ? row.Rw : '') + '</td>';
    html += '<td class="c ' + vCls + '">' + (calc.verdict || '') + '</td>';
    html += '</tr>\n';
  }
  html += '</table>\n';

  html += '</div>\n';
  html += '</body></html>';
  return html;
}

function exportToWord() {
  const html = buildWordHTML();
  const blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const filename = 'protokol-' + (AppState.form.protocolNumber || 'draft').replace(/\//g, '-') + '.doc';
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importFromWord() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.doc,.html';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const text = ev.target.result;
      const match = text.match(/<!-- VOLTPROTOCOL_DATA:([\s\S]*?) -->/);
      if (match) {
        try {
          const jsonStr = decodeURIComponent(escape(atob(match[1].trim())));
          const saved = JSON.parse(jsonStr);
          restoreAppState(saved);
          showToast('Wczytano dane z pliku Word.');
          return;
        } catch(err) {
          showToast('B\u0142\u0105d: uszkodzone dane w pliku.');
          return;
        }
      }
      showToast('Nie znaleziono danych VoltProtocol. U\u017cyj pliku wyeksportowanego z aplikacji.');
    };
    reader.readAsText(file);
  };
  input.click();
}

// === PDF EXPORTER ===

function pdfVal(v) {
  return v != null ? String(v) : '';
}

function makeSectionRow(title, numCols) {
  var row = [{ text: title, bold: true, fillColor: '#d1d5db', colSpan: numCols }];
  for (var i = 1; i < numCols; i++) { row.push({}); }
  return row;
}

function makeSubsectionRow(title, numCols) {
  var row = [{ text: title, italics: true, fillColor: '#f3f4f6', colSpan: numCols }];
  for (var i = 1; i < numCols; i++) { row.push({}); }
  return row;
}

function buildFormMainContent() {
  var f = AppState.form;
  var content = [];

  // Tytuł
  content.push({
    text: 'PROTOKÓŁ KONTROLNO-POMIAROWY NR ' + (f.protocolNumber || ''),
    bold: true, fontSize: 14, alignment: 'center', margin: [0, 0, 0, 15]
  });

  // 1. Obiekt badany
  content.push({ text: '1. Obiekt badany:', bold: true, fontSize: 10, margin: [0, 0, 0, 5] });
  content.push({ text: [f.objectName || '', f.objectParcel ? ', dz. ' + f.objectParcel : '', f.objectAddress ? ', ' + f.objectAddress : ''].join(''), margin: [0, 0, 0, 10] });

  // 2. Wykonawca
  content.push({ text: '2. Wykonawca:', bold: true, fontSize: 10, margin: [0, 0, 0, 5] });
  var executorText = 'Protokół oraz badania wykonał oraz zatwierdził ' + (f.executorName || '') + '.';
  if (f.executorSepE || f.executorSepD) {
    executorText += ' Świadectwa Kwalifikacyjne SEP';
    if (f.executorSepE) executorText += ' na stanowisku eksploatacji nr ' + f.executorSepE;
    if (f.executorSepD) executorText += ' oraz na stanowisku dozoru ' + f.executorSepD;
    executorText += '.';
  }
  content.push({ text: executorText, margin: [0, 0, 0, 10] });

  // 3. Warunki badań
  content.push({ text: '3. Warunki badań:', bold: true, fontSize: 10, margin: [0, 0, 0, 5] });

  var testDateFormatted = '';
  if (f.testDate) {
    var pd = parseLocalDate(f.testDate);
    if (pd) {
      testDateFormatted = String(pd.getDate()).padStart(2, '0') + '.' + String(pd.getMonth() + 1).padStart(2, '0') + '.' + pd.getFullYear();
    }
  }
  content.push({ text: '    1. Badania wykonano w dniu ' + testDateFormatted, margin: [0, 0, 0, 3] });
  content.push({ text: '    2. Temperatura otoczenia w dniu badań: ' + (f.testTemp != null ? f.testTemp : '') + '\u00b0C.', margin: [0, 0, 0, 5] });
  content.push({ text: '    3. Przyrządy pomiarowe', margin: [0, 0, 0, 5] });

  // Tabela przyrządów
  var instrBody = [
    [
      { text: 'Wykonane pomiary', bold: true },
      { text: 'Przyrządy pomiarowe', bold: true },
      { text: 'Nr świadectwa wzorcowania', bold: true }
    ]
  ];
  for (var i = 0; i < f.instruments.length; i++) {
    var instr = f.instruments[i];
    instrBody.push([
      INSTRUMENT_LABELS[instr.type] || '',
      [instr.name || '', instr.serial ? ' nr ' + instr.serial : ''].join(''),
      instr.calibration || ''
    ]);
  }
  content.push({
    table: {
      headerRows: 1,
      widths: ['*', 'auto', 'auto'],
      body: instrBody
    },
    layout: { hLineWidth: function() { return 0.5; }, vLineWidth: function() { return 0.5; } },
    margin: [0, 0, 0, 10]
  });

  // 4. Ocena wykonanych badań
  content.push({ text: '4. Ocena wykonanych badań odbiorczych:', bold: true, fontSize: 10, margin: [0, 0, 0, 5] });

  var assessBody = [
    [
      { text: 'Wykonane badania odbiorcze', bold: true },
      { text: 'Załączniki', bold: true, alignment: 'center' },
      { text: 'Ogólny wynik', bold: true, alignment: 'center' }
    ],
    ['Sprawdzenie dokumentacji instalacji', { text: '\u2014', alignment: 'center' }, { text: 'POZYTYWNY', bold: true, alignment: 'center' }],
    ['Oględziny instalacji elektrycznej', { text: '\u2014', alignment: 'center' }, { text: 'POZYTYWNY', bold: true, alignment: 'center' }],
    ['Badanie skuteczności ochrony przeciwporażeniowej przez samoczynne wyłączenie zasilania', { text: 'Zał. 1', alignment: 'center' }, { text: calcAttachmentVerdict('attachment1') || '\u2014', bold: true, alignment: 'center' }],
    ['Badanie stanu rezystancji izolacji obwodów', { text: 'Zał. 2', alignment: 'center' }, { text: calcAttachmentVerdict('attachment2') || '\u2014', bold: true, alignment: 'center' }],
    ['Badanie skuteczności ochrony dodatkowej (RCD)', { text: 'Zał. 3', alignment: 'center' }, { text: calcAttachmentVerdict('attachment3') || '\u2014', bold: true, alignment: 'center' }],
    ['Badanie rezystancji uziemienia', { text: 'Zał. 4', alignment: 'center' }, { text: calcAttachmentVerdict('attachment4') || '\u2014', bold: true, alignment: 'center' }]
  ];
  content.push({
    table: {
      headerRows: 1,
      widths: ['*', 60, 80],
      body: assessBody
    },
    layout: { hLineWidth: function() { return 0.5; }, vLineWidth: function() { return 0.5; } },
    margin: [0, 0, 0, 10]
  });

  // 5. Orzeczenie
  content.push({ text: '5. Orzeczenie:', bold: true, fontSize: 10, margin: [0, 0, 0, 5] });
  var orz = calcOrzeczenie();
  if (orz.allPositive) {
    content.push({ text: 'Na podstawie wykonanych badań odbiorczych orzeka się, że instalacja elektryczna NADAJE SIĘ do eksploatacji.', bold: true, margin: [0, 0, 0, 5] });
  } else {
    var assessment = calcFinalAssessment();
    var hasNegative = Object.values(assessment).some(function(v) { return v === 'NEGATYWNY'; });
    if (hasNegative) {
      content.push({ text: 'Na podstawie wykonanych badań odbiorczych orzeka się, że instalacja elektryczna NIE NADAJE SIĘ do eksploatacji.', bold: true, margin: [0, 0, 0, 5] });
    } else {
      content.push({ text: '(uzupełnij dane pomiarowe)', color: '#9ca3af', margin: [0, 0, 0, 5] });
    }
  }

  // 6. Data następnego badania
  if (orz.nextDate) {
    content.push({ text: 'Data następnego badania: ' + orz.nextDate + ' r. lub po dokonaniu zmian.', margin: [0, 0, 0, 15] });
  }

  // Podpisy
  content.push({
    columns: [
      {
        width: '*',
        stack: [
          { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 140, y2: 0, lineWidth: 0.5 }], margin: [0, 30, 0, 2] },
          { text: 'wykonawca', fontSize: 7, alignment: 'center', width: 140 }
        ]
      },
      {
        width: '*',
        stack: [
          { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 140, y2: 0, lineWidth: 0.5 }], margin: [0, 30, 0, 2] },
          { text: 'miejscowość i data', fontSize: 7, alignment: 'center', width: 140 }
        ]
      }
    ],
    margin: [0, 0, 0, 0]
  });

  return content;
}

function buildAttachment1Content() {
  var content = [];

  content.push({
    text: 'ZAŁĄCZNIK NR 1 DO PROTOKOŁU KONTROLNO-POMIAROWEGO NR ' + (AppState.form.protocolNumber || ''),
    bold: true, fontSize: 11, pageBreak: 'before', margin: [0, 0, 0, 3]
  });
  content.push({
    text: 'SKUTECZNOŚĆ OCHRONY PODSTAWOWEJ ORAZ DODATKOWEJ PRZECIWPORAŻENIOWEJ PRZEZ SAMOCZYNNE WYŁĄCZENIE ZASILANIA',
    bold: true, fontSize: 9, alignment: 'center', margin: [0, 0, 0, 10]
  });

  // 4-wierszowy nagłówek tabeli SWZ — 13 kolumn
  var headerRow1 = [
    { text: 'Lp.', rowSpan: 4, alignment: 'center', bold: true },
    { text: 'Obwód\nnumer gniazda', rowSpan: 4, alignment: 'center', bold: true },
    { text: 'Zabezpieczenia', colSpan: 4, alignment: 'center', bold: true }, {}, {}, {},
    { text: 'Usk\n[V]', rowSpan: 4, alignment: 'center', bold: true },
    { text: 'Ia\n[A]', rowSpan: 4, alignment: 'center', bold: true },
    { text: 'Id\n[A]', rowSpan: 4, alignment: 'center', bold: true },
    { text: 'Zs\n[\u03a9]', rowSpan: 4, alignment: 'center', bold: true },
    { text: 'Zs max\n[\u03a9]', rowSpan: 4, alignment: 'center', bold: true },
    { text: 'tw\n[s]', rowSpan: 4, alignment: 'center', bold: true },
    { text: 'Ocena', rowSpan: 4, alignment: 'center', bold: true }
  ];
  var headerRow2 = [
    {}, {},
    { text: 'dodatkowe', colSpan: 2, alignment: 'center', bold: true }, {},
    { text: 'podstawowe', colSpan: 2, alignment: 'center', bold: true }, {},
    {}, {}, {}, {}, {}, {}, {}
  ];
  var headerRow3 = [
    {}, {},
    { text: 'typ', alignment: 'center', bold: true },
    { text: 'prąd', alignment: 'center', bold: true },
    { text: 'typ', alignment: 'center', bold: true },
    { text: 'prąd I\u0394n', alignment: 'center', bold: true },
    {}, {}, {}, {}, {}, {}, {}
  ];
  var headerRow4 = [
    {}, {},
    { text: '-', alignment: 'center' },
    { text: '[A]', alignment: 'center' },
    { text: '-', alignment: 'center' },
    { text: '[A]', alignment: 'center' },
    {}, {}, {}, {}, {}, {}, {}
  ];

  var body = [headerRow1, headerRow2, headerRow3, headerRow4];

  // Numeracja Lp ciągła
  var lpCounter = 1;

  // Stały wiersz (swzFixedRow)
  var fr = AppState.swzFixedRow;
  var frCalc = calcSWZRow(fr);
  var frIa = fr.Ia != null ? fr.Ia : getIa(fr.baseType, fr.baseCurrent);
  body.push([
    { text: String(lpCounter), alignment: 'center' },
    'Zabezpieczenie główne',
    pdfVal(fr.protType),
    pdfVal(fr.protCurrent),
    pdfVal(fr.baseType),
    pdfVal(fr.baseCurrent),
    pdfVal(fr.Usk),
    frIa != null ? String(frIa) : '',
    frCalc.Id != null ? frCalc.Id.toFixed(2) : '',
    pdfVal(fr.Zs),
    frCalc.Zsmax != null ? frCalc.Zsmax.toFixed(2) : '',
    pdfVal(fr.tw),
    frCalc.verdict || ''
  ]);
  lpCounter++;

  // Dynamiczne sekcje/podsekcje/wiersze
  for (var si = 0; si < AppState.sections.length; si++) {
    var section = AppState.sections[si];
    body.push(makeSectionRow(section.title, 13));

    for (var sbi = 0; sbi < section.subsections.length; sbi++) {
      var sub = section.subsections[sbi];
      body.push(makeSubsectionRow(sub.title, 13));

      var rows = AppState.attachment1.rowsBySubsection[sub.id] || [];
      for (var ri = 0; ri < rows.length; ri++) {
        var row = rows[ri];
        var calc = calcSWZRow(row);
        var rowIa = row.Ia != null ? row.Ia : getIa(row.baseType, row.baseCurrent);
        body.push([
          { text: String(lpCounter), alignment: 'center' },
          pdfVal(row.circuit),
          pdfVal(row.protType),
          pdfVal(row.protCurrent),
          pdfVal(row.baseType),
          pdfVal(row.baseCurrent),
          pdfVal(row.Usk),
          rowIa != null ? String(rowIa) : '',
          calc.Id != null ? calc.Id.toFixed(2) : '',
          pdfVal(row.Zs),
          calc.Zsmax != null ? calc.Zsmax.toFixed(2) : '',
          pdfVal(row.tw),
          calc.verdict || ''
        ]);
        lpCounter++;
      }
    }
  }

  content.push({
    table: {
      headerRows: 4,
      widths: [20, '*', 25, 30, 25, 35, 30, 30, 30, 30, 35, 25, 55],
      body: body
    },
    layout: {
      hLineWidth: function() { return 0.5; },
      vLineWidth: function() { return 0.5; }
    }
  });

  return content;
}

function buildAttachment2Content() {
  var content = [];

  content.push({
    text: 'ZAŁĄCZNIK NR 2 DO PROTOKOŁU KONTROLNO-POMIAROWEGO NR ' + (AppState.form.protocolNumber || ''),
    bold: true, fontSize: 11, margin: [0, 0, 0, 3]
  });
  content.push({
    text: 'REZYSTANCJA IZOLACJI',
    bold: true, fontSize: 9, alignment: 'center', margin: [0, 0, 0, 10]
  });

  // 2-wierszowy nagłówek — 15 kolumn
  var headerRow1 = [
    { text: 'Lp.', rowSpan: 2, alignment: 'center', bold: true },
    { text: 'Nazwa obwodu', rowSpan: 2, alignment: 'center', bold: true },
    { text: 'Typ przewodu', rowSpan: 2, alignment: 'center', bold: true },
    { text: 'Rp [M\u03a9]', colSpan: 10, alignment: 'center', bold: true },
    {}, {}, {}, {}, {}, {}, {}, {}, {},
    { text: 'Rw\n[M\u03a9]', rowSpan: 2, alignment: 'center', bold: true },
    { text: 'Ocena', rowSpan: 2, alignment: 'center', bold: true }
  ];
  var rpCols = ['L1-N', 'L2-N', 'L3-N', 'L1-L2', 'L1-L3', 'L2-L3', 'L1-PE', 'L2-PE', 'L3-PE', 'N-PE'];
  var headerRow2 = [{}, {}, {}];
  for (var ci = 0; ci < rpCols.length; ci++) {
    headerRow2.push({ text: rpCols[ci], alignment: 'center', fontSize: 7 });
  }
  headerRow2.push({});
  headerRow2.push({});

  var body = [headerRow1, headerRow2];

  var rpFieldKeys = ['L1N', 'L2N', 'L3N', 'L1L2', 'L1L3', 'L2L3', 'L1PE', 'L2PE', 'L3PE', 'NPE'];
  var lpCounter = 1;

  // Helper: build Rp cells respecting phaseType
  function buildRpCells(row) {
    var activeFields = getActiveIZOLFields(row.phaseType);
    var cells = [];
    for (var k = 0; k < rpFieldKeys.length; k++) {
      var key = rpFieldKeys[k];
      if (activeFields.includes(key)) {
        cells.push(row.rp[key] != null ? String(row.rp[key]) : '');
      } else {
        cells.push('-');
      }
    }
    return cells;
  }

  // Stały wiersz (fixedRow) — zawsze 3-fazowy
  var ifr = AppState.attachment2.fixedRow;
  var ifrCalc = calcIZOLRow(ifr);
  var fixedRpCells = buildRpCells(ifr);
  var fixedDataRow = [
    { text: String(lpCounter), alignment: 'center' },
    'WLZ',
    pdfVal(ifr.wireType)
  ];
  for (var fc = 0; fc < fixedRpCells.length; fc++) {
    fixedDataRow.push({ text: fixedRpCells[fc], alignment: 'center' });
  }
  fixedDataRow.push({ text: String(ifr.Rw), alignment: 'center' });
  fixedDataRow.push(ifrCalc.verdict || '');
  body.push(fixedDataRow);
  lpCounter++;

  // Dynamiczne sekcje/podsekcje/wiersze
  for (var si = 0; si < AppState.sections.length; si++) {
    var section = AppState.sections[si];
    body.push(makeSectionRow(section.title, 15));

    for (var sbi = 0; sbi < section.subsections.length; sbi++) {
      var sub = section.subsections[sbi];
      body.push(makeSubsectionRow(sub.title, 15));

      var rows = AppState.attachment2.rowsBySubsection[sub.id] || [];
      for (var ri = 0; ri < rows.length; ri++) {
        var row = rows[ri];
        var calc = calcIZOLRow(row);
        var rpCells = buildRpCells(row);
        var dataRow = [
          { text: String(lpCounter), alignment: 'center' },
          pdfVal(row.name),
          pdfVal(row.wireType)
        ];
        for (var rc = 0; rc < rpCells.length; rc++) {
          dataRow.push({ text: rpCells[rc], alignment: 'center' });
        }
        dataRow.push({ text: String(row.Rw), alignment: 'center' });
        dataRow.push(calc.verdict || '');
        body.push(dataRow);
        lpCounter++;
      }
    }
  }

  content.push({
    table: {
      headerRows: 2,
      widths: [20, '*', 40, 38, 38, 38, 38, 38, 38, 38, 38, 38, 38, 25, 50],
      body: body
    },
    layout: {
      hLineWidth: function() { return 0.5; },
      vLineWidth: function() { return 0.5; }
    }
  });

  return content;
}

function buildAttachment3Content() {
  var content = [];

  content.push({
    text: 'ZAŁĄCZNIK NR 3 DO PROTOKOŁU KONTROLNO-POMIAROWEGO NR ' + (AppState.form.protocolNumber || ''),
    bold: true, fontSize: 11, margin: [0, 0, 0, 3]
  });
  content.push({
    text: 'BADANIE WYŁĄCZNIKÓW RÓŻNICOWOPRĄDOWYCH (RCD)',
    bold: true, fontSize: 9, alignment: 'center', margin: [0, 0, 0, 10]
  });

  var body = [
    [
      { text: 'Lp.', bold: true, alignment: 'center' },
      { text: 'Typ wyłącznika', bold: true, alignment: 'center' },
      { text: 'TEST\nTAK/NIE', bold: true, alignment: 'center' },
      { text: 'In\n[mA]', bold: true, alignment: 'center' },
      { text: 'Iw\n[mA]', bold: true, alignment: 'center' },
      { text: 'tw\n[ms]', bold: true, alignment: 'center' },
      { text: 'tz\n[ms]', bold: true, alignment: 'center' },
      { text: 'Ocena', bold: true, alignment: 'center' }
    ]
  ];

  for (var i = 0; i < AppState.attachment3.rows.length; i++) {
    var row = AppState.attachment3.rows[i];
    var calc = calcRCDRow(row);
    body.push([
      { text: String(i + 1), alignment: 'center' },
      pdfVal(row.deviceType),
      { text: pdfVal(row.testResult), alignment: 'center' },
      { text: pdfVal(row.In), alignment: 'center' },
      { text: pdfVal(row.Iw), alignment: 'center' },
      { text: pdfVal(row.tw), alignment: 'center' },
      { text: pdfVal(row.tz), alignment: 'center' },
      calc.verdict || ''
    ]);
  }

  // Jeśli brak wierszy, dodaj pusty wiersz placeholder
  if (AppState.attachment3.rows.length === 0) {
    body.push([{ text: 'Brak danych', colSpan: 8, alignment: 'center', italics: true }, {}, {}, {}, {}, {}, {}, {}]);
  }

  content.push({
    table: {
      headerRows: 1,
      widths: [25, '*', 60, 40, 40, 40, 40, 55],
      body: body
    },
    layout: {
      hLineWidth: function() { return 0.5; },
      vLineWidth: function() { return 0.5; }
    }
  });

  return content;
}

function buildAttachment4Content() {
  var content = [];

  content.push({
    text: 'ZAŁĄCZNIK NR 4 DO PROTOKOŁU KONTROLNO-POMIAROWEGO NR ' + (AppState.form.protocolNumber || ''),
    bold: true, fontSize: 11, pageBreak: 'before', margin: [0, 0, 0, 3]
  });
  content.push({
    text: 'REZYSTANCJA UZIEMIENIA',
    bold: true, fontSize: 9, alignment: 'center', margin: [0, 0, 0, 10]
  });

  var body = [
    [
      { text: 'Lp.', bold: true, alignment: 'center' },
      { text: 'Nazwa', bold: true, alignment: 'center' },
      { text: 'Rp\n[\u03a9]', bold: true, alignment: 'center' },
      { text: 'Wk', bold: true, alignment: 'center' },
      { text: 'Rpo\n[\u03a9]', bold: true, alignment: 'center' },
      { text: 'Rw\n[\u03a9]', bold: true, alignment: 'center' },
      { text: 'Ocena', bold: true, alignment: 'center' }
    ]
  ];

  for (var i = 0; i < AppState.attachment4.rows.length; i++) {
    var row = AppState.attachment4.rows[i];
    var calc = calcUZIEMRow(row);
    body.push([
      { text: String(i + 1), alignment: 'center' },
      pdfVal(row.deviceName),
      { text: pdfVal(row.Rp), alignment: 'center' },
      { text: pdfVal(row.Wk), alignment: 'center' },
      { text: calc.Rpo != null ? calc.Rpo.toFixed(2) : '', alignment: 'center' },
      { text: pdfVal(row.Rw), alignment: 'center' },
      calc.verdict || ''
    ]);
  }

  // Jeśli brak wierszy, dodaj pusty wiersz placeholder
  if (AppState.attachment4.rows.length === 0) {
    body.push([{ text: 'Brak danych', colSpan: 7, alignment: 'center', italics: true }, {}, {}, {}, {}, {}, {}]);
  }

  content.push({
    table: {
      headerRows: 1,
      widths: [25, '*', 50, 50, 50, 50, 55],
      body: body
    },
    layout: {
      hLineWidth: function() { return 0.5; },
      vLineWidth: function() { return 0.5; }
    }
  });

  return content;
}

function buildDocDefinition() {
  return {
    pageSize: 'A4',
    pageOrientation: 'portrait',
    pageMargins: [40, 60, 40, 60],
    defaultStyle: { font: 'Roboto', fontSize: 9 },
    footer: function(currentPage, pageCount) {
      return { text: currentPage + ' / ' + pageCount, alignment: 'center', fontSize: 8, margin: [0, 10, 0, 0] };
    },
    content: [
      ...buildFormMainContent(),
      ...buildAttachment1Content(),
      { stack: buildAttachment2Content(), pageOrientation: 'landscape', pageBreak: 'before' },
      { stack: buildAttachment3Content(), pageOrientation: 'portrait', pageBreak: 'before' },
      ...buildAttachment4Content()
    ]
  };
}

function exportPDF() {
  var dd = buildDocDefinition();
  var filename = 'protokol-' + (AppState.form.protocolNumber || 'draft').replace(/\//g, '-') + '.pdf';
  pdfMake.createPdf(dd).download(filename);
}

// === EVENT BUS SUBSCRIPTIONS ===

EventBus.on('sections:changed', () => {
  renderAttachment1();
  renderAttachment2();
});

EventBus.on('attachment1:changed', renderAttachment1);
EventBus.on('attachment2:changed', renderAttachment2);
EventBus.on('attachment3:changed', renderAttachment3);
EventBus.on('attachment4:changed', renderAttachment4);

// Aktualizacja oceny końcowej przy zmianach w załącznikach
EventBus.on('attachment1:changed', updateFinalAssessmentDisplay);
EventBus.on('attachment2:changed', updateFinalAssessmentDisplay);
EventBus.on('attachment3:changed', updateFinalAssessmentDisplay);
EventBus.on('attachment4:changed', updateFinalAssessmentDisplay);
EventBus.on('sections:changed', updateFinalAssessmentDisplay);

// === INIT ===

function init() {
  // Auto-generate protocol number
  AppState.form.protocolNumber = generateProtocolNumber();

  // Initialize default content: one section with one subsection and one row
  const defaultSubId = crypto.randomUUID();
  const defaultSectionId = crypto.randomUUID();

  AppState.sections.push({
    id: defaultSectionId,
    title: 'Parter',
    subsections: [{
      id: defaultSubId,
      title: 'Obwód gniazd wtykowych'
    }]
  });

  // Initialize rowsBySubsection for BOTH attachments (Pitfall 5 / DYN-06)
  AppState.attachment1.rowsBySubsection[defaultSubId] = [createNewSWZRow()];
  AppState.attachment2.rowsBySubsection[defaultSubId] = [];

  renderTabs();
  renderFormTab();
  renderAttachment1();
  renderAttachment2();
  renderAttachment3();
  renderAttachment4();
  bindTabEvents();
  bindAppEvents();
  document.getElementById('btn-export-pdf').addEventListener('click', exportPDF);
  document.getElementById('btn-save').addEventListener('click', saveToLocalStorage);
  document.getElementById('btn-load').addEventListener('click', loadFromLocalStorage);
  document.getElementById('btn-export-json').addEventListener('click', exportToJSON);
  document.getElementById('btn-import-json').addEventListener('click', importFromJSON);
  document.getElementById('btn-export-word').addEventListener('click', exportToWord);
  document.getElementById('btn-import-word').addEventListener('click', importFromWord);
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
